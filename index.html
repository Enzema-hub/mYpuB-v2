<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mYpuB - Gestión de Archivos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .brand {
            font-family: Georgia, serif;
            font-weight: bold;
            color: black;
        }
        .welcome-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        .file-card {
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .file-card:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .file-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        .like-btn {
            cursor: pointer;
        }
        .like-btn:hover {
            color: #dc3545;
        }
        .liked {
            color: #dc3545;
        }
        .folder-icon {
            color: #ffc107;
        }
        .nav-link.active {
            font-weight: bold;
            border-bottom: 2px solid #0d6efd;
        }
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 2px;
        }
        .help-panel {
            display: none;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }
        .file-preview {
            max-height: 200px;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Pantalla de inicio/registro -->
        <div id="auth-container" class="row justify-content-center align-items-center min-vh-100">
            <div class="col-md-6 col-lg-4">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="text-center" id="auth-title">Regístrate en <span class="brand">mYpuB</span></h3>
                    </div>
                    <div class="card-body">
                        <div id="login-form" style="display: none;">
                            <div class="mb-3">
                                <label for="login-email" class="form-label">Correo electrónico</label>
                                <input type="email" class="form-control" id="login-email" required>
                            </div>
                            <div class="mb-3">
                                <label for="login-password" class="form-label">Contraseña</label>
                                <input type="password" class="form-control" id="login-password" required>
                            </div>
                            <button id="login-btn" class="btn btn-primary w-100 mb-3">Iniciar sesión</button>
                            <p class="text-center">¿No tienes cuenta? <a href="#" id="show-register">Regístrate</a></p>
                        </div>

                        <div id="register-form">
                            <div class="mb-3">
                                <label for="full-name" class="form-label">Nombre completo</label>
                                <input type="text" class="form-control" id="full-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Correo electrónico (Gmail)</label>
                                <input type="email" class="form-control" id="email" required>
                                <div class="invalid-feedback">Debe ser una dirección de Gmail válida</div>
                            </div>
                            <div class="mb-3">
                                <label for="gender" class="form-label">Sexo</label>
                                <select class="form-select" id="gender" required>
                                    <option value="" selected disabled>Selecciona tu sexo</option>
                                    <option value="male">Hombre</option>
                                    <option value="female">Mujer</option>
                                    <option value="other">Otros</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Teléfono (con prefijo)</label>
                                <div class="input-group">
                                    <span class="input-group-text">+</span>
                                    <input type="tel" class="form-control" id="phone-prefix" placeholder="Prefijo" required>
                                    <input type="tel" class="form-control" id="phone" placeholder="Número" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Contraseña</label>
                                <input type="password" class="form-control" id="password" required>
                                <div class="invalid-feedback">La contraseña debe tener 12 caracteres: 6 letras (primera mayúscula), 4 números y 2 símbolos (@#&)</div>
                                <div class="password-strength" id="password-strength"></div>
                            </div>
                            <div class="mb-3">
                                <label for="confirm-password" class="form-label">Confirmar contraseña</label>
                                <input type="password" class="form-control" id="confirm-password" required>
                                <div class="invalid-feedback">Las contraseñas no coinciden</div>
                            </div>
                            <button id="register-btn" class="btn btn-primary w-100 mb-3">Registrarse</button>
                            <button id="help-btn" class="btn btn-outline-secondary w-100 mb-3">
                                <i class="bi bi-question-circle"></i> AYUDA
                            </button>
                            <div id="help-panel" class="help-panel">
                                <div class="mb-3">
                                    <button class="btn btn-outline-primary w-100 mb-2" id="email-help">
                                        <i class="bi bi-envelope"></i> Enviar consulta por email
                                    </button>
                                    <button class="btn btn-outline-success w-100" id="whatsapp-help">
                                        <i class="bi bi-whatsapp"></i> Enviar consulta por WhatsApp
                                    </button>
                                </div>
                            </div>
                            <p class="text-center">¿Ya tienes cuenta? <a href="#" id="show-login">Inicia sesión</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel principal (oculto inicialmente) -->
        <div id="main-container" class="container-fluid py-3" style="display: none;">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
                <div class="container-fluid">
                    <a class="navbar-brand brand" href="#">mYpuB</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav me-auto">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" data-section="upload"><i class="bi bi-cloud-arrow-up"></i> SUBIR TU</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="gallery"><i class="bi bi-images"></i> GALERÍA</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="share"><i class="bi bi-share"></i> COMPARTIR</a>
                            </li>
                            <li class="nav-item" id="user-management-item" style="display: none;">
                                <a class="nav-link" href="#" data-section="users"><i class="bi bi-people"></i> GESTIÓN DE USUARIOS</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="info"><i class="bi bi-info-circle"></i> INFÓRMATE</a>
                            </li>
                        </ul>
                        <div class="d-flex align-items-center">
                            <span class="text-white me-3" id="user-greeting"></span>
                            <button id="logout-btn" class="btn btn-outline-light">
                                <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Mensaje de bienvenida -->
            <div class="alert alert-primary welcome-message" id="welcome-message"></div>

            <!-- Secciones del panel principal -->
            <div id="upload-section" class="section-content">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="bi bi-cloud-arrow-up"></i> Subir archivos</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="file-type" class="form-label">Tipo de archivo</label>
                            <select class="form-select" id="file-type">
                                <option value="image">Imagen</option>
                                <option value="video">Video</option>
                                <option value="audio">Música (MP3)</option>
                                <option value="document">Documento (PDF)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="file-upload" class="form-label">Seleccionar archivo</label>
                            <input class="form-control" type="file" id="file-upload">
                        </div>
                        <div class="mb-3">
                            <label for="file-title" class="form-label">Título</label>
                            <input type="text" class="form-control" id="file-title" placeholder="Opcional">
                        </div>
                        <div class="mb-3">
                            <label for="file-description" class="form-label">Descripción</label>
                            <textarea class="form-control" id="file-description" rows="2" placeholder="Opcional"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="file-public" checked>
                                <label class="form-check-label" for="file-public">
                                    Archivo público (visible para todos los usuarios)
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="file-folder" class="form-label">Carpeta</label>
                            <div class="input-group">
                                <select class="form-select" id="file-folder">
                                    <option value="">Sin carpeta</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" id="new-folder-btn">
                                    <i class="bi bi-folder-plus"></i> Nueva
                                </button>
                            </div>
                        </div>
                        <button id="upload-btn" class="btn btn-primary">
                            <i class="bi bi-upload"></i> Subir archivo
                        </button>
                    </div>
                </div>
            </div>

            <div id="gallery-section" class="section-content" style="display: none;">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4><i class="bi bi-images"></i> Galería</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-light me-2" id="refresh-gallery">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar
                            </button>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-light dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-funnel"></i> Filtrar
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="all">Todos</a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="image">Imágenes</a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="video">Videos</a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="audio">Música</a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="document">Documentos</a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-filter="mine">Mis archivos</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" id="gallery-items">
                            <!-- Los archivos se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="share-section" class="section-content" style="display: none;">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="bi bi-share"></i> Compartir archivos</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="share-user" class="form-label">Usuario destino</label>
                                    <select class="form-select" id="share-user">
                                        <option value="" selected disabled>Selecciona un usuario</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="share-file" class="form-label">Archivo a compartir</label>
                                    <select class="form-select" id="share-file">
                                        <option value="" selected disabled>Selecciona un archivo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button id="share-btn" class="btn btn-primary">
                            <i class="bi bi-send"></i> Compartir
                        </button>
                    </div>
                </div>
            </div>

            <div id="users-section" class="section-content" style="display: none;">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="bi bi-people"></i> Gestión de usuarios</h4>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Teléfono</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="users-table">
                                <!-- Los usuarios se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="info-section" class="section-content" style="display: none;">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="bi bi-info-circle"></i> Información sobre <span class="brand">mYpuB</span></h4>
                    </div>
                    <div class="card-body">
                        <h5>¿Qué es <span class="brand">mYpuB</span>?</h5>
                        <p><span class="brand">mYpuB</span> es una aplicación web para gestionar y compartir archivos multimedia y documentos. Permite subir, organizar y compartir imágenes, videos, música y documentos PDF de forma pública o privada.</p>
                        
                        <h5 class="mt-4">¿Cómo se utiliza?</h5>
                        <ol>
                            <li>Regístrate con tu cuenta de Gmail</li>
                            <li>Inicia sesión con tus credenciales</li>
                            <li>Sube archivos desde la sección "SUBIR TU"</li>
                            <li>Organiza tus archivos en carpetas</li>
                            <li>Visualiza y gestiona tus archivos en "GALERÍA"</li>
                            <li>Comparte archivos con otros usuarios</li>
                        </ol>
                        
                        <h5 class="mt-4">Información del desarrollador</h5>
                        <div class="card">
                            <div class="card-body">
                                <p><strong>Nombre completo:</strong> Tarciano ENZEMA NCHAMA</p>
                                <p><strong>Formación académica:</strong> Finalista universitario de la UNGE</p>
                                <p><strong>Facultad:</strong> Ciencias económicas gestión y administración</p>
                                <p><strong>Departamento:</strong> Informática de gestión empresarial</p>
                                <p><strong>Contacto:</strong> enzemajr@gmail.com</p>
                                <p><strong>Fecha final del desarrollo:</strong> 06/07/2025</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para nueva carpeta -->
        <div class="modal fade" id="folderModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Crear nueva carpeta</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="folder-name" class="form-label">Nombre de la carpeta</label>
                            <input type="text" class="form-control" id="folder-name">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="folder-public">
                            <label class="form-check-label" for="folder-public">
                                Carpeta pública (visible para todos los usuarios)
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="create-folder-btn">Crear carpeta</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para visualizar archivos -->
        <div class="modal fade" id="fileModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="file-modal-title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div id="file-modal-content"></div>
                        <p id="file-modal-description" class="mt-3"></p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <span class="badge bg-secondary" id="file-modal-type"></span>
                                <span class="badge bg-primary ms-2" id="file-modal-visibility"></span>
                            </div>
                            <div>
                                <span class="me-3"><i class="bi bi-person"></i> <span id="file-modal-user"></span></span>
                                <span><i class="bi bi-calendar"></i> <span id="file-modal-date"></span></span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-center mt-3">
                            <button class="btn btn-outline-primary me-2" id="file-modal-like">
                                <i class="bi bi-hand-thumbs-up"></i> <span id="file-modal-likes">0</span>
                            </button>
                            <button class="btn btn-outline-secondary me-2" id="file-modal-download">
                                <i class="bi bi-download"></i> Descargar
                            </button>
                            <button class="btn btn-outline-danger" id="file-modal-delete" style="display: none;">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para confirmaciones -->
        <div class="modal fade" id="confirmModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirm-modal-title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="confirm-modal-body">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="confirm-modal-btn">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para ayuda -->
        <div class="modal fade" id="helpModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Enviar consulta al desarrollador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="help-name" class="form-label">Nombre completo</label>
                            <input type="text" class="form-control" id="help-name" required>
                        </div>
                        <div class="mb-3" id="help-email-container">
                            <label for="help-email" class="form-label">Email para respuesta</label>
                            <input type="email" class="form-control" id="help-email" required>
                        </div>
                        <div class="mb-3" id="help-phone-container" style="display: none;">
                            <label for="help-phone" class="form-label">Número de WhatsApp</label>
                            <input type="tel" class="form-control" id="help-phone" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="send-help-btn">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let db;
        let currentUser = null;
        let isDeveloper = false;
        let helpMethod = 'email';

        // Inicialización de la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeDB();
            setupEventListeners();
        });

        // Inicializar la base de datos IndexedDB
        function initializeDB() {
            const request = indexedDB.open('mYpuBDB', 3);

            request.onerror = function(event) {
                console.error('Error al abrir la base de datos', event);
                showAlert('Error al inicializar la base de datos', 'danger');
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('Base de datos inicializada correctamente');
                
                // Verificar si hay usuario en sesión
                checkSession();
            };

            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                
                // Crear almacén de usuarios
                const userStore = db.createObjectStore('users', { keyPath: 'email' });
                userStore.createIndex('email', 'email', { unique: true });
                
                // Crear almacén de archivos
                const fileStore = db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                fileStore.createIndex('userId', 'userId', { unique: false });
                fileStore.createIndex('type', 'type', { unique: false });
                fileStore.createIndex('folderId', 'folderId', { unique: false });
                fileStore.createIndex('isPublic', 'isPublic', { unique: false });
                
                // Crear almacén de carpetas
                const folderStore = db.createObjectStore('folders', { keyPath: 'id', autoIncrement: true });
                folderStore.createIndex('userId', 'userId', { unique: false });
                folderStore.createIndex('isPublic', 'isPublic', { unique: false });
                
                // Crear almacén de compartidos
                const sharedStore = db.createObjectStore('shared', { keyPath: 'id', autoIncrement: true });
                sharedStore.createIndex('fileId', 'fileId', { unique: false });
                sharedStore.createIndex('fromUser', 'fromUser', { unique: false });
                sharedStore.createIndex('toUser', 'toUser', { unique: false });
                
                // Crear almacén de likes
                const likeStore = db.createObjectStore('likes', { keyPath: 'id', autoIncrement: true });
                likeStore.createIndex('fileId', 'fileId', { unique: false });
                likeStore.createIndex('userId', 'userId', { unique: false });
                
                // Crear almacén de sesión
                db.createObjectStore('session', { keyPath: 'id' });
            };
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Autenticación
            document.getElementById('show-login').addEventListener('click', showLoginForm);
            document.getElementById('show-register').addEventListener('click', showRegisterForm);
            document.getElementById('register-btn').addEventListener('click', registerUser);
            document.getElementById('login-btn').addEventListener('click', loginUser);
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
            
            // Validación de contraseña en tiempo real
            document.getElementById('password').addEventListener('input', validatePasswordStrength);
            
            // Ayuda
            document.getElementById('help-btn').addEventListener('click', toggleHelpPanel);
            document.getElementById('email-help').addEventListener('click', showEmailHelp);
            document.getElementById('whatsapp-help').addEventListener('click', showWhatsAppHelp);
            document.getElementById('send-help-btn').addEventListener('click', sendHelpRequest);
            
            // Navegación
            document.querySelectorAll('[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.getAttribute('data-section'));
                });
            });
            
            // Archivos
            document.getElementById('upload-btn').addEventListener('click', uploadFile);
            document.getElementById('new-folder-btn').addEventListener('click', showNewFolderModal);
            document.getElementById('create-folder-btn').addEventListener('click', createFolder);
            document.getElementById('refresh-gallery').addEventListener('click', loadGallery);
            
            // Filtros de galería
            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadGallery(this.getAttribute('data-filter'));
                });
            });
            
            // Compartir
            document.getElementById('share-btn').addEventListener('click', shareFile);
        }

        // Mostrar formulario de login
        function showLoginForm(e) {
            e.preventDefault();
            document.getElementById('auth-title').textContent = `Inicie la sesión en ${formatBrand('mYpuB')}`;
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
        }

        // Mostrar formulario de registro
        function showRegisterForm(e) {
            e.preventDefault();
            document.getElementById('auth-title').textContent = `Regístrate en ${formatBrand('mYpuB')}`;
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }

        // Formatear el nombre de la marca
        function formatBrand(text) {
            return `<span class="brand">${text}</span>`;
        }

        // Validar fortaleza de la contraseña en tiempo real
        function validatePasswordStrength() {
            const password = document.getElementById('password').value;
            const strengthBar = document.getElementById('password-strength');
            let strength = 0;
            
            // Validar longitud
            if (password.length >= 12) strength += 20;
            
            // Validar letras (6 letras, primera mayúscula)
            const letterRegex = /^[A-Z][a-z]{5}/;
            if (letterRegex.test(password.substring(0, 6))) strength += 30;
            
            // Validar números (4 números)
            const numberRegex = /[0-9]{4}/;
            if (numberRegex.test(password)) strength += 20;
            
            // Validar símbolos (2 símbolos @#&)
            const symbolRegex = /[@#&].*[@#&]/;
            if (symbolRegex.test(password)) strength += 30;
            
            // Actualizar barra de fortaleza
            strengthBar.style.width = `${strength}%`;
            
            if (strength < 50) {
                strengthBar.className = 'password-strength bg-danger';
            } else if (strength < 80) {
                strengthBar.className = 'password-strength bg-warning';
            } else {
                strengthBar.className = 'password-strength bg-success';
            }
        }

        // Registrar un nuevo usuario
        function registerUser() {
            const fullName = document.getElementById('full-name').value.trim();
            const email = document.getElementById('email').value.trim();
            const gender = document.getElementById('gender').value;
            const phonePrefix = document.getElementById('phone-prefix').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // Validar campos
            if (!fullName || !email || !gender || !phonePrefix || !phone || !password || !confirmPassword) {
                showAlert('Todos los campos son obligatorios', 'danger');
                return;
            }
            
            // Validar email (debe ser Gmail)
            if (!email.endsWith('@gmail.com')) {
                document.getElementById('email').classList.add('is-invalid');
                showAlert('Debe proporcionar una dirección de Gmail válida', 'danger');
                return;
            } else {
                document.getElementById('email').classList.remove('is-invalid');
            }
            
            // Validar contraseña
            if (!validatePassword(password)) {
                document.getElementById('password').classList.add('is-invalid');
                showAlert('La contraseña no cumple con los requisitos', 'danger');
                return;
            } else {
                document.getElementById('password').classList.remove('is-invalid');
            }
            
            // Validar confirmación de contraseña
            if (password !== confirmPassword) {
                document.getElementById('confirm-password').classList.add('is-invalid');
                showAlert('Las contraseñas no coinciden', 'danger');
                return;
            } else {
                document.getElementById('confirm-password').classList.remove('is-invalid');
            }
            
            // Verificar si el usuario ya existe
            const transaction = db.transaction(['users'], 'readwrite');
            const userStore = transaction.objectStore('users');
            const request = userStore.get(email);
            
            request.onsuccess = function(e) {
                if (e.target.result) {
                    showAlert('El usuario ya está registrado', 'danger');
                } else {
                    // Crear nuevo usuario
                    const newUser = {
                        fullName,
                        email,
                        gender,
                        phone: `+${phonePrefix}${phone}`,
                        password,
                        isDeveloper: password === 'Enzema0097@&',
                        isBlocked: false,
                        createdAt: new Date()
                    };
                    
                    const addRequest = userStore.add(newUser);
                    
                    addRequest.onsuccess = function() {
                        showAlert('Usuario registrado correctamente', 'success');
                        clearForm('register-form');
                        
                        // Iniciar sesión automáticamente
                        currentUser = newUser;
                        isDeveloper = newUser.isDeveloper;
                        startSession(newUser);
                    };
                    
                    addRequest.onerror = function() {
                        showAlert('Error al registrar el usuario', 'danger');
                    };
                }
            };
            
            request.onerror = function() {
                showAlert('Error al verificar el usuario', 'danger');
            };
        }

        // Validar contraseña según requisitos
        function validatePassword(password) {
            // 12 caracteres: 6 letras (primera mayúscula), 4 números y 2 símbolos (@#&)
            const regex = /^(?=[A-Z][a-z]{5}[^A-Za-z]*[0-9]{4}[^0-9]*[@#&]{2}$).{12}$/;
            return regex.test(password);
        }

        // Iniciar sesión
        function loginUser() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showAlert('Email y contraseña son obligatorios', 'danger');
                return;
            }
            
            const transaction = db.transaction(['users'], 'readonly');
            const userStore = transaction.objectStore('users');
            const request = userStore.get(email);
            
            request.onsuccess = function(e) {
                const user = e.target.result;
                
                if (!user) {
                    showAlert('Usuario no encontrado', 'danger');
                } else if (user.isBlocked) {
                    showAlert('Usuario bloqueado. Contacta al administrador.', 'danger');
                } else if (user.password !== password) {
                    showAlert('Contraseña incorrecta', 'danger');
                } else {
                    currentUser = user;
                    isDeveloper = password === 'Enzema0097@&';
                    startSession(user);
                }
            };
            
            request.onerror = function() {
                showAlert('Error al iniciar sesión', 'danger');
            };
        }

        // Iniciar sesión y mostrar panel principal
        function startSession(user) {
            // Guardar sesión en IndexedDB
            const transaction = db.transaction(['session'], 'readwrite');
            const sessionStore = transaction.objectStore('session');
            sessionStore.put({ id: 'current', user: user.email });
            
            // Mostrar panel principal
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            
            // Mostrar mensaje de bienvenida
            showWelcomeMessage(user);
            
            // Cargar datos iniciales
            loadFolders();
            loadGallery();
            loadUsersForSharing();
            
            // Mostrar gestión de usuarios si es desarrollador
            if (isDeveloper) {
                document.getElementById('user-management-item').style.display = 'block';
                loadAllUsers();
            }
            
            // Mostrar sección de subir archivos por defecto
            showSection('upload');
        }

        // Mostrar mensaje de bienvenida según género
        function showWelcomeMessage(user) {
            const welcomeElement = document.getElementById('welcome-message');
            const greetingElement = document.getElementById('user-greeting');
            
            let welcomeMessage = '';
            let greeting = user.fullName;
            
            switch(user.gender) {
                case 'male':
                    welcomeMessage = `Bienvenido a ${formatBrand('mYpuB')} Sr. ${user.fullName}`;
                    greeting = `Sr. ${user.fullName}`;
                    break;
                case 'female':
                    welcomeMessage = `Bienvenida a ${formatBrand('mYpuB')} Sra. ${user.fullName}`;
                    greeting = `Sra. ${user.fullName}`;
                    break;
                default:
                    welcomeMessage = `Gracias por utilizar ${formatBrand('mYpuB')}`;
            }
            
            welcomeElement.innerHTML = welcomeMessage;
            greetingElement.textContent = greeting;
        }

        // Cerrar sesión
        function logoutUser() {
            const transaction = db.transaction(['session'], 'readwrite');
            const sessionStore = transaction.objectStore('session');
            sessionStore.delete('current');
            
            currentUser = null;
            isDeveloper = false;
            
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
            document.getElementById('auth-title').textContent = `Regístrate en ${formatBrand('mYpuB')}`;
            
            clearForm('login-form');
        }

        // Verificar sesión activa al cargar la página
        function checkSession() {
            const transaction = db.transaction(['session'], 'readonly');
            const sessionStore = transaction.objectStore('session');
            const request = sessionStore.get('current');
            
            request.onsuccess = function(e) {
                const session = e.target.result;
                if (session) {
                    // Obtener información del usuario
                    const userTransaction = db.transaction(['users'], 'readonly');
                    const userStore = userTransaction.objectStore('users');
                    const userRequest = userStore.get(session.user);
                    
                    userRequest.onsuccess = function(e) {
                        const user = e.target.result;
                        if (user && !user.isBlocked) {
                            currentUser = user;
                            isDeveloper = user.password === 'Enzema0097@&';
                            startSession(user);
                        }
                    };
                }
            };
        }

        // Mostrar sección del panel principal
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Mostrar la sección seleccionada
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            
            // Actualizar navegación activa
            document.querySelectorAll('[data-section]').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === sectionId) {
                    link.classList.add('active');
                }
            });
            
            // Cargar datos si es necesario
            if (sectionId === 'gallery') {
                loadGallery();
            } else if (sectionId === 'users' && isDeveloper) {
                loadAllUsers();
            }
        }

        // Cargar carpetas del usuario
        function loadFolders() {
            const transaction = db.transaction(['folders'], 'readonly');
            const folderStore = transaction.objectStore('folders');
            const index = folderStore.index('userId');
            const request = index.getAll(currentUser.email);
            
            request.onsuccess = function(e) {
                const folders = e.target.result;
                const select = document.getElementById('file-folder');
                
                // Limpiar opciones excepto la primera
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Agregar carpetas
                folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    select.appendChild(option);
                });
            };
        }

        // Mostrar modal para nueva carpeta
        function showNewFolderModal() {
            const modal = new bootstrap.Modal(document.getElementById('folderModal'));
            document.getElementById('folder-name').value = '';
            document.getElementById('folder-public').checked = true;
            modal.show();
        }

        // Crear nueva carpeta
        function createFolder() {
            const name = document.getElementById('folder-name').value.trim();
            const isPublic = document.getElementById('folder-public').checked;
            
            if (!name) {
                showAlert('El nombre de la carpeta es obligatorio', 'danger');
                return;
            }
            
            const transaction = db.transaction(['folders'], 'readwrite');
            const folderStore = transaction.objectStore('folders');
            
            const newFolder = {
                name,
                userId: currentUser.email,
                isPublic,
                createdAt: new Date()
            };
            
            const request = folderStore.add(newFolder);
            
            request.onsuccess = function() {
                showAlert('Carpeta creada correctamente', 'success');
                loadFolders();
                bootstrap.Modal.getInstance(document.getElementById('folderModal')).hide();
            };
            
            request.onerror = function() {
                showAlert('Error al crear la carpeta', 'danger');
            };
        }

        // Subir archivo
        function uploadFile() {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Debes seleccionar un archivo', 'danger');
                return;
            }
            
            const fileType = document.getElementById('file-type').value;
            const title = document.getElementById('file-title').value.trim() || file.name;
            const description = document.getElementById('file-description').value.trim();
            const isPublic = document.getElementById('file-public').checked;
            const folderId = document.getElementById('file-folder').value || null;
            
            // Validar tipo de archivo
            if (fileType === 'audio' && !file.name.endsWith('.mp3')) {
                showAlert('El archivo de audio debe ser MP3', 'danger');
                return;
            }
            
            if (fileType === 'document' && !file.name.endsWith('.pdf')) {
                showAlert('El documento debe ser PDF', 'danger');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const fileData = e.target.result;
                
                const transaction = db.transaction(['files'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                
                const newFile = {
                    userId: currentUser.email,
                    userName: currentUser.fullName,
                    type: fileType,
                    name: file.name,
                    title,
                    description,
                    data: fileData,
                    isPublic,
                    folderId,
                    likes: 0,
                    createdAt: new Date()
                };
                
                const request = fileStore.add(newFile);
                
                request.onsuccess = function() {
                    showAlert('Archivo subido correctamente', 'success');
                    clearForm('upload-section');
                    fileInput.value = '';
                    loadGallery();
                };
                
                request.onerror = function() {
                    showAlert('Error al subir el archivo', 'danger');
                };
            };
            
            reader.readAsDataURL(file);
        }

        // Cargar galería de archivos
        function loadGallery(filter = 'all') {
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const request = fileStore.getAll();
            
            request.onsuccess = function(e) {
                const files = e.target.result;
                const gallery = document.getElementById('gallery-items');
                gallery.innerHTML = '';
                
                // Filtrar archivos según el filtro seleccionado
                let filteredFiles = files;
                
                if (filter === 'image') {
                    filteredFiles = files.filter(file => file.type === 'image');
                } else if (filter === 'video') {
                    filteredFiles = files.filter(file => file.type === 'video');
                } else if (filter === 'audio') {
                    filteredFiles = files.filter(file => file.type === 'audio');
                } else if (filter === 'document') {
                    filteredFiles = files.filter(file => file.type === 'document');
                } else if (filter === 'mine') {
                    filteredFiles = files.filter(file => file.userId === currentUser.email);
                } else {
                    // 'all' - mostrar solo archivos públicos o del usuario actual
                    filteredFiles = files.filter(file => file.isPublic || file.userId === currentUser.email || isDeveloper);
                }
                
                // Ordenar por fecha (más reciente primero)
                filteredFiles.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Mostrar archivos
                if (filteredFiles.length === 0) {
                    gallery.innerHTML = '<div class="col-12 text-center py-5"><i class="bi bi-folder-x" style="font-size: 3rem;"></i><p class="mt-3">No hay archivos para mostrar</p></div>';
                    return;
                }
                
                filteredFiles.forEach(file => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-lg-3';
                    
                    const card = document.createElement('div');
                    card.className = 'card file-card h-100';
                    
                    const isOwner = file.userId === currentUser.email;
                    const canDelete = isOwner || isDeveloper;
                    
                    // Determinar icono según tipo
                    let iconClass, previewContent;
                    
                    switch(file.type) {
                        case 'image':
                            iconClass = 'bi bi-image';
                            previewContent = `<img src="${file.data}" class="card-img-top file-preview" alt="${file.title}">`;
                            break;
                        case 'video':
                            iconClass = 'bi bi-film';
                            previewContent = `
                                <video class="card-img-top file-preview" controls>
                                    <source src="${file.data}" type="video/mp4">
                                    Tu navegador no soporta videos.
                                </video>
                            `;
                            break;
                        case 'audio':
                            iconClass = 'bi bi-music-note-beamed';
                            previewContent = `
                                <audio controls class="w-100 mt-3">
                                    <source src="${file.data}" type="audio/mpeg">
                                    Tu navegador no soporta audio.
                                </audio>
                            `;
                            break;
                        case 'document':
                            iconClass = 'bi bi-file-earmark-pdf';
                            previewContent = `<div class="text-center py-4"><i class="bi bi-file-earmark-pdf file-icon" style="font-size: 5rem;"></i></div>`;
                            break;
                    }
                    
                    card.innerHTML = `
                        <div class="card-body d-flex flex-column">
                            ${previewContent}
                            <h5 class="card-title mt-2">${file.title}</h5>
                            <p class="card-text text-muted small">${file.description || 'Sin descripción'}</p>
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-secondary">${file.type}</span>
                                    <span class="badge ${file.isPublic ? 'bg-success' : 'bg-warning'}">
                                        ${file.isPublic ? 'Público' : 'Privado'}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-person"></i> ${file.userName}
                                    </small>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> ${formatDate(file.createdAt)}
                                    </small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <button class="btn btn-sm btn-outline-primary like-btn" data-file-id="${file.id}">
                                        <i class="bi bi-hand-thumbs-up${file.likes > 0 ? '-fill liked' : ''}"></i> ${file.likes}
                                    </button>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary view-btn" data-file-id="${file.id}">
                                            <i class="bi bi-eye"></i> Ver
                                        </button>
                                        ${canDelete ? `
                                        <button class="btn btn-sm btn-outline-danger delete-btn" data-file-id="${file.id}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    col.appendChild(card);
                    gallery.appendChild(col);
                });
                
                // Agregar event listeners a los botones
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        viewFile(this.getAttribute('data-file-id'));
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        confirmDeleteFile(this.getAttribute('data-file-id'));
                    });
                });
                
                document.querySelectorAll('.like-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        likeFile(this.getAttribute('data-file-id'));
                    });
                });
            };
        }

        // Ver archivo en modal
        function viewFile(fileId) {
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const request = fileStore.get(Number(fileId));
            
            request.onsuccess = function(e) {
                const file = e.target.result;
                if (!file) return;
                
                const modal = new bootstrap.Modal(document.getElementById('fileModal'));
                const modalTitle = document.getElementById('file-modal-title');
                const modalContent = document.getElementById('file-modal-content');
                const modalDescription = document.getElementById('file-modal-description');
                const modalType = document.getElementById('file-modal-type');
                const modalVisibility = document.getElementById('file-modal-visibility');
                const modalUser = document.getElementById('file-modal-user');
                const modalDate = document.getElementById('file-modal-date');
                const modalLikes = document.getElementById('file-modal-likes');
                const modalLikeBtn = document.getElementById('file-modal-like');
                const modalDownloadBtn = document.getElementById('file-modal-download');
                const modalDeleteBtn = document.getElementById('file-modal-delete');
                
                // Configurar contenido según tipo de archivo
                let contentHtml = '';
                
                switch(file.type) {
                    case 'image':
                        contentHtml = `<img src="${file.data}" class="img-fluid" alt="${file.title}">`;
                        break;
                    case 'video':
                        contentHtml = `
                            <video controls class="w-100">
                                <source src="${file.data}" type="video/mp4">
                                Tu navegador no soporta videos.
                            </video>
                        `;
                        break;
                    case 'audio':
                        contentHtml = `
                            <audio controls class="w-100">
                                <source src="${file.data}" type="audio/mpeg">
                                Tu navegador no soporta audio.
                            </audio>
                        `;
                        break;
                    case 'document':
                        contentHtml = `
                            <iframe src="${file.data}" class="w-100" height="500" style="border: none;"></iframe>
                        `;
                        break;
                }
                
                // Configurar modal
                modalTitle.textContent = file.title;
                modalContent.innerHTML = contentHtml;
                modalDescription.textContent = file.description || 'Sin descripción';
                modalType.textContent = file.type;
                modalVisibility.textContent = file.isPublic ? 'Público' : 'Privado';
                modalVisibility.className = `badge ${file.isPublic ? 'bg-success' : 'bg-warning'}`;
                modalUser.textContent = file.userName;
                modalDate.textContent = formatDate(file.createdAt);
                modalLikes.textContent = file.likes;
                
                // Configurar botón de like
                modalLikeBtn.onclick = function() {
                    likeFile(file.id);
                    modal.hide();
                };
                
                // Configurar botón de descarga
                modalDownloadBtn.onclick = function() {
                    downloadFile(file);
                };
                
                // Mostrar botón de eliminar solo si es el dueño o desarrollador
                const isOwner = file.userId === currentUser.email;
                if (isOwner || isDeveloper) {
                    modalDeleteBtn.style.display = 'inline-block';
                    modalDeleteBtn.onclick = function() {
                        modal.hide();
                        confirmDeleteFile(file.id);
                    };
                } else {
                    modalDeleteBtn.style.display = 'none';
                }
                
                modal.show();
            };
        }

        // Dar like a un archivo
        function likeFile(fileId) {
            // Verificar si el usuario ya dio like a este archivo
            const likeTransaction = db.transaction(['likes'], 'readonly');
            const likeStore = likeTransaction.objectStore('likes');
            const likeIndex = likeStore.index('fileId');
            const likeRequest = likeIndex.get([Number(fileId), currentUser.email]);
            
            likeRequest.onsuccess = function(e) {
                const existingLike = e.target.result;
                
                if (existingLike) {
                    // El usuario ya dio like, quitar el like
                    const deleteTransaction = db.transaction(['likes', 'files'], 'readwrite');
                    const deleteLikeStore = deleteTransaction.objectStore('likes');
                    const updateFileStore = deleteTransaction.objectStore('files');
                    
                    // Eliminar el like
                    deleteLikeStore.delete(existingLike.id);
                    
                    // Decrementar el contador de likes en el archivo
                    const fileRequest = updateFileStore.get(Number(fileId));
                    
                    fileRequest.onsuccess = function(e) {
                        const file = e.target.result;
                        if (file) {
                            file.likes = Math.max(0, file.likes - 1);
                            updateFileStore.put(file);
                            
                            // Recargar la galería
                            loadGallery();
                        }
                    };
                } else {
                    // El usuario no ha dado like, agregar like
                    const addTransaction = db.transaction(['likes', 'files'], 'readwrite');
                    const addLikeStore = addTransaction.objectStore('likes');
                    const updateFileStore = addTransaction.objectStore('files');
                    
                    // Agregar el like
                    const newLike = {
                        fileId: Number(fileId),
                        userId: currentUser.email,
                        createdAt: new Date()
                    };
                    
                    addLikeStore.add(newLike);
                    
                    // Incrementar el contador de likes en el archivo
                    const fileRequest = updateFileStore.get(Number(fileId));
                    
                    fileRequest.onsuccess = function(e) {
                        const file = e.target.result;
                        if (file) {
                            file.likes = (file.likes || 0) + 1;
                            updateFileStore.put(file);
                            
                            // Recargar la galería
                            loadGallery();
                        }
                    };
                }
            };
        }

        // Descargar archivo
        function downloadFile(file) {
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Confirmar eliminación de archivo
        function confirmDeleteFile(fileId) {
            showConfirmModal(
                'Confirmar eliminación',
                '¿Estás seguro de que deseas eliminar este archivo? Esta acción no se puede deshacer.',
                function() {
                    deleteFile(fileId);
                }
            );
        }

        // Eliminar archivo
        function deleteFile(fileId) {
            const transaction = db.transaction(['files', 'likes', 'shared'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            const likeStore = transaction.objectStore('likes');
            const sharedStore = transaction.objectStore('shared');
            
            // Eliminar el archivo
            fileStore.delete(Number(fileId));
            
            // Eliminar todos los likes asociados al archivo
            const likeIndex = likeStore.index('fileId');
            const likeRequest = likeIndex.openCursor(IDBKeyRange.only(Number(fileId)));
            
            likeRequest.onsuccess = function(e) {
                const cursor = e.target.result;
                if (cursor) {
                    likeStore.delete(cursor.primaryKey);
                    cursor.continue();
                }
            };
            
            // Eliminar todos los compartidos asociados al archivo
            const sharedIndex = sharedStore.index('fileId');
            const sharedRequest = sharedIndex.openCursor(IDBKeyRange.only(Number(fileId)));
            
            sharedRequest.onsuccess = function(e) {
                const cursor = e.target.result;
                if (cursor) {
                    sharedStore.delete(cursor.primaryKey);
                    cursor.continue();
                }
            };
            
            transaction.oncomplete = function() {
                showAlert('Archivo eliminado correctamente', 'success');
                loadGallery();
            };
            
            transaction.onerror = function() {
                showAlert('Error al eliminar el archivo', 'danger');
            };
        }

        // Cargar usuarios para compartir
        function loadUsersForSharing() {
            const transaction = db.transaction(['users'], 'readonly');
            const userStore = transaction.objectStore('users');
            const request = userStore.getAll();
            
            request.onsuccess = function(e) {
                const users = e.target.result;
                const select = document.getElementById('share-user');
                
                // Limpiar opciones excepto la primera
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Agregar usuarios (excluyendo al usuario actual y usuarios bloqueados)
                users.forEach(user => {
                    if (user.email !== currentUser.email && !user.isBlocked) {
                        const option = document.createElement('option');
                        option.value = user.email;
                        option.textContent = `${user.fullName} (${user.email})`;
                        select.appendChild(option);
                    }
                });
                
                // Cargar archivos que se pueden compartir (solo los del usuario actual)
                loadUserFilesForSharing();
            };
        }

        // Cargar archivos del usuario para compartir
        function loadUserFilesForSharing() {
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const index = fileStore.index('userId');
            const request = index.getAll(currentUser.email);
            
            request.onsuccess = function(e) {
                const files = e.target.result;
                const select = document.getElementById('share-file');
                
                // Limpiar opciones excepto la primera
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Agregar archivos
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.id;
                    option.textContent = `${file.title} (${file.type})`;
                    select.appendChild(option);
                });
            };
        }

        // Compartir archivo con otro usuario
        function shareFile() {
            const userEmail = document.getElementById('share-user').value;
            const fileId = document.getElementById('share-file').value;
            
            if (!userEmail || !fileId) {
                showAlert('Debes seleccionar un usuario y un archivo', 'danger');
                return;
            }
            
            const transaction = db.transaction(['shared'], 'readwrite');
            const sharedStore = transaction.objectStore('shared');
            
            const newShare = {
                fileId: Number(fileId),
                fromUser: currentUser.email,
                toUser: userEmail,
                createdAt: new Date()
            };
            
            const request = sharedStore.add(newShare);
            
            request.onsuccess = function() {
                showAlert('Archivo compartido correctamente', 'success');
                document.getElementById('share-user').value = '';
                document.getElementById('share-file').value = '';
            };
            
            request.onerror = function() {
                showAlert('Error al compartir el archivo', 'danger');
            };
        }

        // Cargar todos los usuarios (solo para desarrollador)
        function loadAllUsers() {
            if (!isDeveloper) return;
            
            const transaction = db.transaction(['users'], 'readonly');
            const userStore = transaction.objectStore('users');
            const request = userStore.getAll();
            
            request.onsuccess = function(e) {
                const users = e.target.result;
                const table = document.getElementById('users-table');
                table.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    
                    // Resaltar al desarrollador
                    const isDev = user.password === 'Enzema0097@&';
                    if (isDev) {
                        row.classList.add('table-warning');
                    }
                    
                    row.innerHTML = `
                        <td>${user.fullName} ${isDev ? '<span class="badge bg-dark">Desarrollador</span>' : ''}</td>
                        <td>${user.email}</td>
                        <td>${user.phone}</td>
                        <td>
                            <span class="badge ${user.isBlocked ? 'bg-danger' : 'bg-success'}">
                                ${user.isBlocked ? 'Bloqueado' : 'Activo'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary edit-user-btn" data-user-email="${user.email}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn ${user.isBlocked ? 'btn-outline-success' : 'btn-outline-warning'} block-user-btn" data-user-email="${user.email}">
                                    <i class="bi ${user.isBlocked ? 'bi-unlock' : 'bi-lock'}"></i>
                                </button>
                                ${!isDev ? `
                                <button class="btn btn-outline-danger delete-user-btn" data-user-email="${user.email}">
                                    <i class="bi bi-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
                
                // Agregar event listeners a los botones
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        editUser(this.getAttribute('data-user-email'));
                    });
                });
                
                document.querySelectorAll('.block-user-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        toggleBlockUser(this.getAttribute('data-user-email'));
                    });
                });
                
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        confirmDeleteUser(this.getAttribute('data-user-email'));
                    });
                });
            };
        }

        // Editar usuario
        function editUser(email) {
            const transaction = db.transaction(['users'], 'readonly');
            const userStore = transaction.objectStore('users');
            const request = userStore.get(email);
            
            request.onsuccess = function(e) {
                const user = e.target.result;
                if (!user) return;
                
                showConfirmModal(
                    'Editar usuario',
                    `
                    <form id="edit-user-form">
                        <div class="mb-3">
                            <label for="edit-full-name" class="form-label">Nombre completo</label>
                            <input type="text" class="form-control" id="edit-full-name" value="${user.fullName}" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit-email" value="${user.email}" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-phone" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="edit-phone" value="${user.phone}" required>
                        </div>
                    </form>
                    `,
                    function() {
                        const newName = document.getElementById('edit-full-name').value.trim();
                        const newEmail = document.getElementById('edit-email').value.trim();
                        const newPhone = document.getElementById('edit-phone').value.trim();
                        
                        if (!newName || !newEmail || !newPhone) {
                            showAlert('Todos los campos son obligatorios', 'danger');
                            return;
                        }
                        
                        // Actualizar usuario
                        const updateTransaction = db.transaction(['users'], 'readwrite');
                        const updateStore = updateTransaction.objectStore('users');
                        
                        // Primero eliminar el usuario antiguo
                        updateStore.delete(user.email);
                        
                        // Luego agregar el usuario actualizado
                        user.fullName = newName;
                        user.email = newEmail;
                        user.phone = newPhone;
                        
                        updateStore.add(user);
                        
                        updateTransaction.oncomplete = function() {
                            showAlert('Usuario actualizado correctamente', 'success');
                            loadAllUsers();
                            
                            // Si es el usuario actual, actualizar la sesión
                            if (user.email === currentUser.email) {
                                currentUser = user;
                                showWelcomeMessage(user);
                            }
                        };
                        
                        updateTransaction.onerror = function() {
                            showAlert('Error al actualizar el usuario', 'danger');
                        };
                    },
                    'Guardar'
                );
            };
        }

        // Bloquear/Desbloquear usuario
        function toggleBlockUser(email) {
            const transaction = db.transaction(['users'], 'readwrite');
            const userStore = transaction.objectStore('users');
            const request = userStore.get(email);
            
            request.onsuccess = function(e) {
                const user = e.target.result;
                if (!user) return;
                
                const action = user.isBlocked ? 'desbloquear' : 'bloquear';
                
                showConfirmModal(
                    'Confirmar acción',
                    `¿Estás seguro de que deseas ${action} al usuario ${user.fullName} (${user.email})?`,
                    function() {
                        user.isBlocked = !user.isBlocked;
                        userStore.put(user);
                        
                        showAlert(`Usuario ${action}do correctamente`, 'success');
                        loadAllUsers();
                    }
                );
            };
        }

        // Confirmar eliminación de usuario
        function confirmDeleteUser(email) {
            const transaction = db.transaction(['users'], 'readonly');
            const userStore = transaction.objectStore('users');
            const request = userStore.get(email);
            
            request.onsuccess = function(e) {
                const user = e.target.result;
                if (!user) return;
                
                showConfirmModal(
                    'Confirmar eliminación',
                    `¿Estás seguro de que deseas eliminar al usuario ${user.fullName} (${user.email})? Esta acción no se puede deshacer.`,
                    function() {
                        deleteUser(email);
                    }
                );
            };
        }

        // Eliminar usuario
        function deleteUser(email) {
            const transaction = db.transaction(['users', 'files', 'likes', 'shared', 'folders'], 'readwrite');
            const userStore = transaction.objectStore('users');
            const fileStore = transaction.objectStore('files');
            const likeStore = transaction.objectStore('likes');
            const sharedStore = transaction.objectStore('shared');
            const folderStore = transaction.objectStore('folders');
            
            // Eliminar el usuario
            userStore.delete(email);
            
            // Eliminar todos los archivos del usuario
            const fileIndex = fileStore.index('userId');
            const fileRequest = fileIndex.openCursor(IDBKeyRange.only(email));
            
            fileRequest.onsuccess = function(e) {
                const cursor = e.target.result;
                if (cursor) {
                    // Eliminar likes asociados a este archivo
                    const likeIndex = likeStore.index('fileId');
                    const likeRequest = likeIndex.openCursor(IDBKeyRange.only(cursor.value.id));
                    
                    likeRequest.onsuccess = function(e) {
                        const likeCursor = e.target.result;
                        if (likeCursor) {
                            likeStore.delete(likeCursor.primaryKey);
                            likeCursor.continue();
                        }
                    };
                    
                    // Eliminar compartidos asociados a este archivo
                    const sharedIndex = sharedStore.index('fileId');
                    const sharedRequest = sharedIndex.openCursor(IDBKeyRange.only(cursor.value.id));
                    
                    sharedRequest.onsuccess = function(e) {
                        const sharedCursor = e.target.result;
                        if (sharedCursor) {
                            sharedStore.delete(sharedCursor.primaryKey);
                            sharedCursor.continue();
                        }
                    };
                    
                    // Finalmente eliminar el archivo
                    fileStore.delete(cursor.primaryKey);
                    cursor.continue();
                }
            };
            
            // Eliminar todos los likes del usuario
            const userLikeIndex = likeStore.index('userId');
            const userLikeRequest = userLikeIndex.openCursor(IDBKeyRange.only(email));
            
            userLikeRequest.onsuccess = function(e) {
                const cursor = e.target.result;
                if (cursor) {
                    likeStore.delete(cursor.primaryKey);
                    cursor.continue();
                }
            };
            
            // Eliminar todos los compartidos del usuario
            const fromSharedIndex = sharedStore.index('fromUser');
            const fromSharedRequest = fromSharedIndex.openCursor(IDBKeyRange.only(email));
            
            fromSharedRequest.onsuccess = function(e) {
                const cursor = e.target.result;
                if (cursor) {
                    sharedStore.delete(cursor.primaryKey);
                    cursor.continue();
                }
            };
            
            const toSharedIndex = sharedStore.index('toUser');
            const toSharedRequest = toSharedIndex.openCursor(IDBKeyRange.only(email));
            
            toSharedRequest.onsuccess = function(e) {
                const cursor = e.target.result;
                if (cursor) {
                    sharedStore.delete(cursor.primaryKey);
                    cursor.continue();
                }
            };
            
            // Eliminar todas las carpetas del usuario
            const folderIndex = folderStore.index('userId');
            const folderRequest = folderIndex.openCursor(IDBKeyRange.only(email));
            
            folderRequest.onsuccess = function(e) {
                const cursor = e.target.result;
                if (cursor) {
                    folderStore.delete(cursor.primaryKey);
                    cursor.continue();
                }
            };
            
            transaction.oncomplete = function() {
                showAlert('Usuario eliminado correctamente', 'success');
                loadAllUsers();
            };
            
            transaction.onerror = function() {
                showAlert('Error al eliminar el usuario', 'danger');
            };
        }

        // Mostrar/ocultar panel de ayuda
        function toggleHelpPanel() {
            const panel = document.getElementById('help-panel');
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
            }
        }

        // Mostrar ayuda por email
        function showEmailHelp() {
            helpMethod = 'email';
            document.getElementById('help-email-container').style.display = 'block';
            document.getElementById('help-phone-container').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('helpModal'));
            modal.show();
        }

        // Mostrar ayuda por WhatsApp
        function showWhatsAppHelp() {
            helpMethod = 'whatsapp';
            document.getElementById('help-email-container').style.display = 'none';
            document.getElementById('help-phone-container').style.display = 'block';
            
            const modal = new bootstrap.Modal(document.getElementById('helpModal'));
            modal.show();
        }

        // Enviar solicitud de ayuda
        function sendHelpRequest() {
            const name = document.getElementById('help-name').value.trim();
            const contact = helpMethod === 'email' 
                ? document.getElementById('help-email').value.trim()
                : document.getElementById('help-phone').value.trim();
            
            if (!name || !contact) {
                showAlert('Todos los campos son obligatorios', 'danger');
                return;
            }
            
            if (helpMethod === 'email') {
                if (!contact.includes('@')) {
                    showAlert('Debe proporcionar un email válido', 'danger');
                    return;
                }
                
                const subject = `Consulta de ${name} sobre mYpuB`;
                const body = `Hola desarrollador,\n\nTengo una consulta sobre la aplicación mYpuB:\n\n[Describe tu consulta aquí]\n\nMis datos para respuesta:\nNombre: ${name}\nEmail: ${contact}\n\nGracias.`;
                
                window.location.href = `mailto:enzemajr@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            } else {
                if (!/^[0-9]+$/.test(contact)) {
                    showAlert('Debe proporcionar un número de teléfono válido', 'danger');
                    return;
                }
                
                const message = `Hola desarrollador, tengo una consulta sobre la aplicación mYpuB. Mi nombre es ${name} y mi número es ${contact}.`;
                window.location.href = `https://wa.me/+240222084663?text=${encodeURIComponent(message)}`;
            }
            
            bootstrap.Modal.getInstance(document.getElementById('helpModal')).hide();
            showAlert('Redirigiendo para enviar tu consulta...', 'info');
        }

        // Mostrar modal de confirmación
        function showConfirmModal(title, message, callback, btnText = 'Confirmar') {
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-body').innerHTML = message;
            document.getElementById('confirm-modal-btn').textContent = btnText;
            
            // Limpiar event listeners anteriores
            const confirmBtn = document.getElementById('confirm-modal-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', function() {
                if (typeof callback === 'function') {
                    callback();
                }
                modal.hide();
            });
            
            modal.show();
        }

        // Mostrar alerta
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.role = 'alert';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insertar al principio del body
            document.body.insertBefore(alert, document.body.firstChild);
            
            // Eliminar después de 5 segundos
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 5000);
        }

        // Limpiar formulario
        function clearForm(formId) {
            const form = document.getElementById(formId);
            if (form) {
                form.querySelectorAll('input, textarea, select').forEach(element => {
                    if (element.type !== 'button' && element.type !== 'submit') {
                        element.value = '';
                    }
                });
            }
        }

        // Formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
    </script>
</body>
</html>
