<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Universitario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo-preview {
            max-width: 150px;
            max-height: 150px;
            margin: 0 auto;
            display: block;
        }
        .hidden {
            display: none;
        }
        .module-section {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .folder-card {
            margin-bottom: 15px;
        }
        .document-actions {
            margin-top: 10px;
        }
        .password-toggle {
            cursor: pointer;
        }
        .activity-log {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Encabezado con logo -->
        <div class="row mb-4">
            <div class="col-12 logo-container">
                <img id="facultyLogo" src="" alt="Logo de la facultad" class="logo-preview">
                <h1 id="facultyName">Gestor Universitario</h1>
            </div>
        </div>

        <!-- Sistema de autenticación -->
        <div id="authSection" class="row">
            <div class="col-md-6 offset-md-3">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="authTabs">
                            <li class="nav-item">
                                <a class="nav-link active" id="login-tab" data-bs-toggle="tab" href="#login">Iniciar Sesión</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="register-tab" data-bs-toggle="tab" href="#register">Registrarse</a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="authTabsContent">
                            <div class="tab-pane fade show active" id="login">
                                <form id="loginForm">
                                    <div class="mb-3">
                                        <label for="loginEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="loginEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="loginPassword" class="form-label">Contraseña</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="loginPassword" required>
                                            <button class="btn btn-outline-secondary password-toggle" type="button" data-target="loginPassword">
                                                <i class="bi bi-eye"></i> Mostrar
                                            </button>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Iniciar Sesión</button>
                                </form>
                            </div>
                            <div class="tab-pane fade" id="register">
                                <form id="registerForm">
                                    <div class="mb-3">
                                        <label for="registerName" class="form-label">Nombre Completo</label>
                                        <input type="text" class="form-control" id="registerName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerAddress" class="form-label">Dirección</label>
                                        <input type="text" class="form-control" id="registerAddress" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerPhone" class="form-label">Teléfono</label>
                                        <div class="input-group">
                                            <select class="form-select" id="registerPhonePrefix" style="max-width: 120px;">
                                                <option value="+240">+240 (GQ)</option>
                                                <option value="+34">+34 (ES)</option>
                                                <option value="+1">+1 (US)</option>
                                                <option value="+33">+33 (FR)</option>
                                            </select>
                                            <input type="tel" class="form-control" id="registerPhone" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="registerEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerPassword" class="form-label">Contraseña</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="registerPassword" required>
                                            <button class="btn btn-outline-secondary password-toggle" type="button" data-target="registerPassword">
                                                <i class="bi bi-eye"></i> Mostrar
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">
                                            12 caracteres: 6 letras (primera mayúscula), 4 números y 2 símbolos (@#&)
                                        </small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="registerRole" class="form-label">Rol</label>
                                        <select class="form-select" id="registerRole" required>
                                            <option value="user">Usuario</option>
                                            <option value="admin">Administrador</option>
                                            <option value="secretary">Secretaría General</option>
                                            <option value="department">Departamento</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="departmentSelectContainer" style="display: none;">
                                        <label for="registerDepartment" class="form-label">Departamento</label>
                                        <select class="form-select" id="registerDepartment">
                                            <!-- Se llenará dinámicamente -->
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Registrarse</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aplicación principal (visible después del login) -->
        <div id="appSection" class="hidden">
            <!-- Barra de navegación -->
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">Gestor Universitario</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-module="dashboard">Inicio</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-module="configuration">Configuración</a>
                            </li>
                            <li class="nav-item" id="secretaryNavItem">
                                <a class="nav-link" href="#" data-module="secretary">Secretaría General</a>
                            </li>
                            <li class="nav-item" id="departmentNavItem">
                                <a class="nav-link" href="#" data-module="department">Departamento</a>
                            </li>
                            <li class="nav-item" id="controlNavItem">
                                <a class="nav-link" href="#" data-module="control">Control</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-module="informate">Infórmate</a>
                            </li>
                        </ul>
                        <ul class="navbar-nav ms-auto">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                    <span id="currentUserName"></span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" id="changePasswordBtn">Cambiar Contraseña</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" id="logoutBtn">Cerrar Sesión</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Contenido principal -->
            <div class="row">
                <div class="col-12">
                    <!-- Módulo: Dashboard -->
                    <div id="dashboardModule" class="module-section">
                        <h2>Bienvenido <span id="welcomeUserName"></span></h2>
                        <p id="welcomeUserRole"></p>
                        <div class="row mt-4" id="quickStats">
                            <!-- Se llenará dinámicamente con estadísticas -->
                        </div>
                    </div>

                    <!-- Módulo: Configuración -->
                    <div id="configurationModule" class="module-section hidden">
                        <h2>Configuración</h2>
                        <form id="configurationForm">
                            <div class="mb-3">
                                <label for="facultyNameInput" class="form-label">Nombre de la Facultad</label>
                                <input type="text" class="form-control" id="facultyNameInput" required>
                            </div>
                            <div class="mb-3">
                                <label for="facultyLogoInput" class="form-label">Logotipo de la Universidad</label>
                                <input type="file" class="form-control" id="facultyLogoInput" accept="image/*">
                                <small class="form-text text-muted">Seleccione una imagen para el logotipo</small>
                            </div>
                            <div class="mb-3">
                                <label for="facultyEmail" class="form-label">Email de la Facultad</label>
                                <input type="email" class="form-control" id="facultyEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="facultyPhone" class="form-label">Teléfono de la Facultad</label>
                                <input type="tel" class="form-control" id="facultyPhone" required>
                            </div>
                            <div class="mb-3">
                                <label for="academicYear" class="form-label">Año Académico</label>
                                <select class="form-select" id="academicYear" required>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Guardar Configuración</button>
                        </form>
                    </div>

                    <!-- Módulo: Secretaría General -->
                    <div id="secretaryModule" class="module-section hidden">
                        <h2>Secretaría General</h2>
                        <div class="mb-4">
                            <h4>Gestión de Departamentos</h4>
                            <form id="departmentForm" class="row g-3">
                                <div class="col-md-8">
                                    <label for="departmentName" class="form-label">Nombre del Departamento</label>
                                    <input type="text" class="form-control" id="departmentName" required>
                                </div>
                                <div class="col-md-4 align-self-end">
                                    <button type="submit" class="btn btn-primary">Crear Departamento</button>
                                </div>
                            </form>
                        </div>
                        <div>
                            <h4>Departamentos Existentes</h4>
                            <div class="table-responsive">
                                <table class="table table-striped" id="departmentsTable">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Módulo: Departamento -->
                    <div id="departmentModule" class="module-section hidden">
                        <h2 id="currentDepartmentTitle">Departamento</h2>
                        <div class="mb-4">
                            <h4>Gestión de Carpetas</h4>
                            <form id="folderForm" class="row g-3">
                                <div class="col-md-4">
                                    <label for="folderName" class="form-label">Nombre de la Carpeta</label>
                                    <input type="text" class="form-control" id="folderName" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="folderAcademicYear" class="form-label">Año Académico</label>
                                    <select class="form-select" id="folderAcademicYear" required>
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="folderPassword" class="form-label">Contraseña de Acceso</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="folderPassword" required>
                                        <button class="btn btn-outline-secondary password-toggle" type="button" data-target="folderPassword">
                                            <i class="bi bi-eye"></i> Mostrar
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2 align-self-end">
                                    <button type="submit" class="btn btn-primary">Crear Carpeta</button>
                                </div>
                            </form>
                        </div>
                        <div>
                            <h4>Carpetas Existentes</h4>
                            <div class="row" id="foldersContainer">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Módulo: Gestión de Documentos (modal) -->
                    <div class="modal fade" id="documentsModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="documentsModalTitle">Documentos</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="uploadDocumentForm">
                                        <div class="mb-3">
                                            <label for="documentFile" class="form-label">Seleccionar PDF</label>
                                            <input type="file" class="form-control" id="documentFile" accept=".pdf" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Subir Documento</button>
                                    </form>
                                    <hr>
                                    <h6>Documentos en esta carpeta</h6>
                                    <div class="table-responsive">
                                        <table class="table" id="documentsTable">
                                            <thead>
                                                <tr>
                                                    <th>Nombre</th>
                                                    <th>Tamaño</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Se llenará dinámicamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Módulo: Control -->
                    <div id="controlModule" class="module-section hidden">
                        <h2>Control de Actividades</h2>
                        <div class="alert alert-info">
                            <strong>Nota:</strong> Solo el administrador puede acceder a este módulo.
                        </div>
                        <div class="activity-log">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Fecha/Hora</th>
                                        <th>Usuario</th>
                                        <th>Rol</th>
                                        <th>Departamento</th>
                                        <th>Acción</th>
                                        <th>Detalles</th>
                                    </tr>
                                </thead>
                                <tbody id="activityLogTable">
                                    <!-- Se llenará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Módulo: Infórmate -->
                    <div id="informateModule" class="module-section hidden">
                        <h2>Infórmate</h2>
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>Acerca de la Aplicación</h5>
                            </div>
                            <div class="card-body">
                                <p>Esta aplicación está diseñada para la gestión de documentos en una facultad universitaria, permitiendo la organización por departamentos y carpetas, con control de acceso basado en roles.</p>
                                <h6>¿Para qué sirve?</h6>
                                <ul>
                                    <li>Gestión centralizada de documentos académicos</li>
                                    <li>Organización por departamentos y años académicos</li>
                                    <li>Control de acceso seguro con diferentes roles</li>
                                    <li>Seguimiento de todas las actividades realizadas</li>
                                </ul>
                                <h6>¿Cómo se utiliza?</h6>
                                <ol>
                                    <li>Inicie sesión con sus credenciales</li>
                                    <li>Navegue entre los diferentes módulos según su rol</li>
                                    <li>En Configuración, establezca los datos de la facultad</li>
                                    <li>En Secretaría General, cree y gestione departamentos</li>
                                    <li>En Departamento, cree carpetas y suba documentos</li>
                                </ol>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h5>Información del Desarrollador</h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item"><strong>Nombre completo:</strong> Tarciano ENZEMA NCHAMA</li>
                                    <li class="list-group-item"><strong>Formación académica:</strong> Finalista universitario de la UNGE</li>
                                    <li class="list-group-item"><strong>Facultad:</strong> Ciencias económicas gestión y administración</li>
                                    <li class="list-group-item"><strong>Departamento:</strong> Informática de gestión empresarial</li>
                                    <li class="list-group-item"><strong>Contacto:</strong> enzemajr@gmail.com</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Modal: Cambiar Contraseña -->
                    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Cambiar Contraseña</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="changePasswordForm">
                                        <div class="mb-3">
                                            <label for="currentPassword" class="form-label">Contraseña Actual</label>
                                            <input type="password" class="form-control" id="currentPassword" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">Nueva Contraseña</label>
                                            <input type="password" class="form-control" id="newPassword" required>
                                            <small class="form-text text-muted">
                                                12 caracteres: 6 letras (primera mayúscula), 4 números y 2 símbolos (@#&)
                                            </small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="confirmPassword" class="form-label">Confirmar Nueva Contraseña</label>
                                            <input type="password" class="form-control" id="confirmPassword" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal: Renombrar Documento -->
                    <div class="modal fade" id="renameDocumentModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Renombrar Documento</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="renameDocumentForm">
                                        <input type="hidden" id="renameDocumentId">
                                        <div class="mb-3">
                                            <label for="newDocumentName" class="form-label">Nuevo Nombre</label>
                                            <input type="text" class="form-control" id="newDocumentName" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Renombrar</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal: Acceso a Carpeta -->
                    <div class="modal fade" id="folderAccessModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Acceso a Carpeta</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="folderAccessForm">
                                        <input type="hidden" id="accessFolderId">
                                        <div class="mb-3">
                                            <label for="accessPassword" class="form-label">Contraseña de la Carpeta</label>
                                            <input type="password" class="form-control" id="accessPassword" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Acceder</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
    <script>
        // Variables globales
        let db;
        let currentUser = null;
        let currentDepartment = null;
        let accessedFolders = {}; // Almacena las carpetas a las que se ha accedido

        // Inicialización de la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeDB();
            setupEventListeners();
            checkAuthState();
            generateAcademicYears();
        });

        // Inicializar IndexedDB
        function initializeDB() {
            const request = indexedDB.open('UniversityManagementDB', 1);

            request.onupgradeneeded = function(event) {
                const db = event.target.result;

                // Objeto para configuración de la facultad
                if (!db.objectStoreNames.contains('configuration')) {
                    const configStore = db.createObjectStore('configuration', { keyPath: 'id' });
                }

                // Objeto para usuarios
                if (!db.objectStoreNames.contains('users')) {
                    const usersStore = db.createObjectStore('users', { keyPath: 'email' });
                    usersStore.createIndex('email', 'email', { unique: true });
                }

                // Objeto para departamentos
                if (!db.objectStoreNames.contains('departments')) {
                    const deptStore = db.createObjectStore('departments', { keyPath: 'id', autoIncrement: true });
                    deptStore.createIndex('name', 'name', { unique: true });
                }

                // Objeto para carpetas
                if (!db.objectStoreNames.contains('folders')) {
                    const foldersStore = db.createObjectStore('folders', { keyPath: 'id', autoIncrement: true });
                    foldersStore.createIndex('departmentId', 'departmentId', { unique: false });
                    foldersStore.createIndex('academicYear', 'academicYear', { unique: false });
                }

                // Objeto para documentos (PDFs)
                if (!db.objectStoreNames.contains('documents')) {
                    const docsStore = db.createObjectStore('documents', { keyPath: 'id', autoIncrement: true });
                    docsStore.createIndex('folderId', 'folderId', { unique: false });
                }

                // Objeto para logs de actividad
                if (!db.objectStoreNames.contains('activityLogs')) {
                    const logsStore = db.createObjectStore('activityLogs', { keyPath: 'id', autoIncrement: true });
                    logsStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                loadInitialData();
            };

            request.onerror = function(event) {
                console.error('Error al abrir la base de datos:', event.target.error);
                showAlert('Error al inicializar la base de datos', 'danger');
            };
        }

        // Cargar datos iniciales
        function loadInitialData() {
            // Verificar si ya existe configuración
            const transaction = db.transaction(['configuration'], 'readonly');
            const store = transaction.objectStore('configuration');
            const request = store.get(1);

            request.onsuccess = function(event) {
                const config = event.target.result;
                if (config) {
                    // Actualizar UI con la configuración existente
                    if (config.logo) {
                        document.getElementById('facultyLogo').src = config.logo;
                    }
                    if (config.name) {
                        document.getElementById('facultyName').textContent = config.name;
                        document.getElementById('facultyNameInput').value = config.name;
                    }
                    if (config.email) {
                        document.getElementById('facultyEmail').value = config.email;
                    }
                    if (config.phone) {
                        document.getElementById('facultyPhone').value = config.phone;
                    }
                    if (config.academicYear) {
                        document.getElementById('academicYear').value = config.academicYear;
                    }
                }
            };
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Autenticación
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('changePasswordBtn').addEventListener('click', showChangePasswordModal);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);

            // Navegación
            document.querySelectorAll('[data-module]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showModule(this.getAttribute('data-module'));
                });
            });

            // Configuración
            document.getElementById('configurationForm').addEventListener('submit', saveConfiguration);
            document.getElementById('facultyLogoInput').addEventListener('change', handleLogoUpload);

            // Secretaría General
            document.getElementById('departmentForm').addEventListener('submit', createDepartment);
            document.getElementById('registerRole').addEventListener('change', handleRoleChange);

            // Departamento
            document.getElementById('folderForm').addEventListener('submit', createFolder);
            document.getElementById('uploadDocumentForm').addEventListener('submit', uploadDocument);
            document.getElementById('folderAccessForm').addEventListener('submit', verifyFolderAccess);
            document.getElementById('renameDocumentForm').addEventListener('submit', renameDocument);

            // Mostrar/ocultar contraseñas
            document.querySelectorAll('.password-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    if (input.type === 'password') {
                        input.type = 'text';
                        this.innerHTML = '<i class="bi bi-eye-slash"></i> Ocultar';
                    } else {
                        input.type = 'password';
                        this.innerHTML = '<i class="bi bi-eye"></i> Mostrar';
                    }
                });
            });
        }

        // Generar años académicos (desde 2010 hasta el año actual + 5)
        function generateAcademicYears() {
            const currentYear = new Date().getFullYear();
            const yearSelects = [
                document.getElementById('academicYear'),
                document.getElementById('folderAcademicYear')
            ];

            yearSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '';
                    for (let year = 2010; year <= currentYear + 5; year++) {
                        const option = document.createElement('option');
                        option.value = `${year}-${year + 1}`;
                        option.textContent = `${year}/${year + 1}`;
                        select.appendChild(option);
                    }
                }
            });
        }

        // Manejar el cambio de rol en el registro
        function handleRoleChange() {
            const role = this.value;
            const departmentContainer = document.getElementById('departmentSelectContainer');

            if (role === 'department') {
                departmentContainer.style.display = 'block';
                loadDepartmentsForRegistration();
            } else {
                departmentContainer.style.display = 'none';
            }
        }

        // Cargar departamentos para el registro
        function loadDepartmentsForRegistration() {
            const transaction = db.transaction(['departments'], 'readonly');
            const store = transaction.objectStore('departments');
            const request = store.getAll();

            request.onsuccess = function(event) {
                const departments = event.target.result;
                const select = document.getElementById('registerDepartment');
                select.innerHTML = '<option value="">Seleccione un departamento</option>';

                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
            };
        }

        // Verificar estado de autenticación
        function checkAuthState() {
            const authSection = document.getElementById('authSection');
            const appSection = document.getElementById('appSection');

            // Por defecto, mostrar solo la sección de autenticación
            authSection.classList.remove('hidden');
            appSection.classList.add('hidden');

            // Verificar si hay un usuario en localStorage
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                showApp();
            }
        }

        // Mostrar la aplicación después del login
        function showApp() {
            const authSection = document.getElementById('authSection');
            const appSection = document.getElementById('appSection');

            authSection.classList.add('hidden');
            appSection.classList.remove('hidden');

            // Actualizar UI con información del usuario
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('welcomeUserName').textContent = currentUser.name;
            document.getElementById('welcomeUserRole').textContent = `Rol: ${getRoleName(currentUser.role)}`;

            // Mostrar/ocultar elementos según el rol
            toggleNavItems();

            // Cargar dashboard
            showModule('dashboard');
            loadQuickStats();
        }

        // Mostrar/ocultar elementos de navegación según el rol
        function toggleNavItems() {
            const isAdmin = currentUser.role === 'admin';
            const isSecretary = currentUser.role === 'secretary';
            const isDepartment = currentUser.role === 'department';

            document.getElementById('secretaryNavItem').style.display = (isAdmin || isSecretary) ? 'block' : 'none';
            document.getElementById('departmentNavItem').style.display = (isAdmin || isSecretary || isDepartment) ? 'block' : 'none';
            document.getElementById('controlNavItem').style.display = isAdmin ? 'block' : 'none';

            if (isDepartment) {
                currentDepartment = currentUser.departmentId;
                document.getElementById('currentDepartmentTitle').textContent = currentUser.departmentName;
            }
        }

        // Obtener nombre del rol
        function getRoleName(role) {
            const roles = {
                'admin': 'Administrador',
                'secretary': 'Secretaría General',
                'department': 'Departamento',
                'user': 'Usuario'
            };
            return roles[role] || role;
        }

        // Mostrar un módulo específico
        function showModule(moduleName) {
            // Ocultar todos los módulos primero
            document.querySelectorAll('.module-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Verificar permisos para el módulo de control
            if (moduleName === 'control' && currentUser.role !== 'admin') {
                showAlert('No tienes permiso para acceder a este módulo. Por favor, contacta al administrador: enzemajr@gmail.com', 'danger');
                return;
            }

            // Mostrar el módulo solicitado
            const module = document.getElementById(`${moduleName}Module`);
            if (module) {
                module.classList.remove('hidden');

                // Cargar datos específicos del módulo
                switch (moduleName) {
                    case 'dashboard':
                        loadQuickStats();
                        break;
                    case 'secretary':
                        loadDepartments();
                        break;
                    case 'department':
                        if (currentUser.role === 'department') {
                            loadFolders(currentUser.departmentId);
                        } else if (currentDepartment) {
                            loadFolders(currentDepartment);
                        }
                        break;
                    case 'control':
                        loadActivityLogs();
                        break;
                }
            }
        }

        // Manejar el inicio de sesión
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const transaction = db.transaction(['users'], 'readonly');
            const store = transaction.objectStore('users');
            const request = store.get(email);

            request.onsuccess = function(event) {
                const user = event.target.result;
                if (user && verifyPassword(password, user.password)) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showApp();
                    logActivity('login', `El usuario ${user.name} ha iniciado sesión`);
                } else {
                    showAlert('Email o contraseña incorrectos', 'danger');
                }
            };

            request.onerror = function(event) {
                console.error('Error al buscar usuario:', event.target.error);
                showAlert('Error al iniciar sesión', 'danger');
            };
        }

        // Manejar el registro
        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const address = document.getElementById('registerAddress').value;
            const phonePrefix = document.getElementById('registerPhonePrefix').value;
            const phone = document.getElementById('registerPhone').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('registerRole').value;
            const departmentId = document.getElementById('registerDepartment').value;
            const departmentName = document.getElementById('registerDepartment').options[document.getElementById('registerDepartment').selectedIndex]?.text;

            // Validar contraseña según el rol
            if (!validatePassword(password, role)) {
                showAlert('La contraseña no cumple con los requisitos para el rol seleccionado', 'danger');
                return;
            }

            // Validar teléfono (simulación)
            if (!phone || phone.length < 8) {
                showAlert('Por favor ingrese un número de teléfono válido', 'danger');
                return;
            }

            const user = {
                name,
                address,
                phone: `${phonePrefix} ${phone}`,
                email,
                password: hashPassword(password),
                role,
                departmentId: role === 'department' ? parseInt(departmentId) : null,
                departmentName: role === 'department' ? departmentName : null,
                createdAt: new Date().toISOString()
            };

            const transaction = db.transaction(['users'], 'readwrite');
            const store = transaction.objectStore('users');
            const request = store.add(user);

            request.onsuccess = function() {
                showAlert('Usuario registrado exitosamente. Ahora puede iniciar sesión.', 'success');
                document.getElementById('registerForm').reset();
                document.getElementById('login-tab').click();
            };

            request.onerror = function(event) {
                if (event.target.error.name === 'ConstraintError') {
                    showAlert('El email ya está registrado', 'danger');
                } else {
                    console.error('Error al registrar usuario:', event.target.error);
                    showAlert('Error al registrar usuario', 'danger');
                }
            };
        }

        // Validar contraseña según el rol
        function validatePassword(password, role) {
            // Formato general: 6 letras (primera mayúscula) + 4 números + 2 símbolos (@#&)
            const generalRegex = /^[A-Z][a-z]{5}\d{4}[@#&]{2}$/;
            
            if (!generalRegex.test(password)) {
                return false;
            }

            // Validaciones específicas por rol
            const prefix = password.substring(0, 6);
            
            switch (role) {
                case 'admin':
                    return prefix === 'Admini';
                case 'secretary':
                    return prefix === 'Secret';
                case 'department':
                    return prefix === 'Depart';
                case 'user':
                    return true;
                default:
                    return false;
            }
        }

        // Manejar el cierre de sesión
        function handleLogout() {
            logActivity('logout', `El usuario ${currentUser.name} ha cerrado sesión`);
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('appSection').classList.add('hidden');
            document.getElementById('loginForm').reset();
        }

        // Mostrar modal para cambiar contraseña
        function showChangePasswordModal() {
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            modal.show();
        }

        // Manejar el cambio de contraseña
        function handleChangePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Verificar contraseña actual
            if (!verifyPassword(currentPassword, currentUser.password)) {
                showAlert('La contraseña actual es incorrecta', 'danger');
                return;
            }

            // Validar nueva contraseña
            if (!validatePassword(newPassword, currentUser.role)) {
                showAlert('La nueva contraseña no cumple con los requisitos para su rol', 'danger');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('Las contraseñas no coinciden', 'danger');
                return;
            }

            // Actualizar contraseña
            const transaction = db.transaction(['users'], 'readwrite');
            const store = transaction.objectStore('users');
            const request = store.get(currentUser.email);

            request.onsuccess = function(event) {
                const user = event.target.result;
                user.password = hashPassword(newPassword);

                const updateRequest = store.put(user);
                updateRequest.onsuccess = function() {
                    currentUser.password = user.password;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showAlert('Contraseña cambiada exitosamente', 'success');
                    document.getElementById('changePasswordForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                    
                    logActivity('password_change', `El usuario ${currentUser.name} cambió su contraseña`);
                };

                updateRequest.onerror = function(event) {
                    console.error('Error al actualizar contraseña:', event.target.error);
                    showAlert('Error al cambiar la contraseña', 'danger');
                };
            };
        }

        // Guardar configuración de la facultad
        function saveConfiguration(e) {
            e.preventDefault();
            const name = document.getElementById('facultyNameInput').value;
            const email = document.getElementById('facultyEmail').value;
            const phone = document.getElementById('facultyPhone').value;
            const academicYear = document.getElementById('academicYear').value;
            const logo = document.getElementById('facultyLogo').src;

            const config = {
                id: 1,
                name,
                email,
                phone,
                academicYear,
                logo,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.email
            };

            const transaction = db.transaction(['configuration'], 'readwrite');
            const store = transaction.objectStore('configuration');
            const request = store.put(config);

            request.onsuccess = function() {
                document.getElementById('facultyName').textContent = name;
                showAlert('Configuración guardada exitosamente', 'success');
                logActivity('configuration_update', `El usuario ${currentUser.name} actualizó la configuración de la facultad`);
            };

            request.onerror = function(event) {
                console.error('Error al guardar configuración:', event.target.error);
                showAlert('Error al guardar la configuración', 'danger');
            };
        }

        // Manejar la carga del logo
        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('facultyLogo').src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Crear un nuevo departamento
        function createDepartment(e) {
            e.preventDefault();
            const name = document.getElementById('departmentName').value;

            const department = {
                name,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.email
            };

            const transaction = db.transaction(['departments'], 'readwrite');
            const store = transaction.objectStore('departments');
            const request = store.add(department);

            request.onsuccess = function() {
                showAlert('Departamento creado exitosamente', 'success');
                document.getElementById('departmentForm').reset();
                loadDepartments();
                logActivity('department_create', `El usuario ${currentUser.name} creó el departamento "${name}"`);
            };

            request.onerror = function(event) {
                if (event.target.error.name === 'ConstraintError') {
                    showAlert('Ya existe un departamento con ese nombre', 'danger');
                } else {
                    console.error('Error al crear departamento:', event.target.error);
                    showAlert('Error al crear el departamento', 'danger');
                }
            };
        }

        // Cargar lista de departamentos
        function loadDepartments() {
            const transaction = db.transaction(['departments'], 'readonly');
            const store = transaction.objectStore('departments');
            const request = store.getAll();

            request.onsuccess = function(event) {
                const departments = event.target.result;
                const tbody = document.querySelector('#departmentsTable tbody');
                tbody.innerHTML = '';

                departments.forEach(dept => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${dept.name}</td>
                        <td>
                            <button class="btn btn-sm btn-primary select-dept" data-id="${dept.id}" data-name="${dept.name}">Seleccionar</button>
                            ${currentUser.role === 'admin' || currentUser.role === 'secretary' ? 
                              `<button class="btn btn-sm btn-danger delete-dept ms-2" data-id="${dept.id}">Eliminar</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Agregar event listeners a los botones
                document.querySelectorAll('.select-dept').forEach(btn => {
                    btn.addEventListener('click', function() {
                        currentDepartment = parseInt(this.getAttribute('data-id'));
                        document.getElementById('currentDepartmentTitle').textContent = this.getAttribute('data-name');
                        showModule('department');
                        loadFolders(currentDepartment);
                    });
                });

                document.querySelectorAll('.delete-dept').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deptId = parseInt(this.getAttribute('data-id'));
                        if (confirm('¿Está seguro de eliminar este departamento? Esta acción no se puede deshacer.')) {
                            deleteDepartment(deptId);
                        }
                    });
                });
            };
        }

        // Eliminar un departamento
        function deleteDepartment(deptId) {
            const transaction = db.transaction(['departments', 'folders', 'documents'], 'readwrite');
            const deptStore = transaction.objectStore('departments');
            const foldersStore = transaction.objectStore('folders');
            const docsStore = transaction.objectStore('documents');

            // Primero, obtener el nombre del departamento para el log
            const getRequest = deptStore.get(deptId);
            let deptName = '';

            getRequest.onsuccess = function(event) {
                deptName = event.target.result.name;

                // Eliminar todos los documentos de las carpetas de este departamento
                const foldersIndex = foldersStore.index('departmentId');
                const foldersRequest = foldersIndex.getAll(deptId);

                foldersRequest.onsuccess = function(event) {
                    const folders = event.target.result;
                    folders.forEach(folder => {
                        const docsIndex = docsStore.index('folderId');
                        const docsRequest = docsIndex.getAll(folder.id);

                        docsRequest.onsuccess = function(event) {
                            const docs = event.target.result;
                            docs.forEach(doc => {
                                docsStore.delete(doc.id);
                            });
                        };

                        // Eliminar la carpeta
                        foldersStore.delete(folder.id);
                    });

                    // Finalmente, eliminar el departamento
                    deptStore.delete(deptId);
                    
                    // Actualizar UI
                    if (currentDepartment === deptId) {
                        currentDepartment = null;
                    }
                    loadDepartments();
                    showAlert('Departamento eliminado exitosamente', 'success');
                    logActivity('department_delete', `El usuario ${currentUser.name} eliminó el departamento "${deptName}"`);
                };
            };

            transaction.onerror = function(event) {
                console.error('Error al eliminar departamento:', event.target.error);
                showAlert('Error al eliminar el departamento', 'danger');
            };
        }

        // Crear una nueva carpeta
        function createFolder(e) {
            e.preventDefault();
            const name = document.getElementById('folderName').value;
            const academicYear = document.getElementById('folderAcademicYear').value;
            const password = document.getElementById('folderPassword').value;

            if (!currentDepartment) {
                showAlert('No se ha seleccionado un departamento', 'danger');
                return;
            }

            const folder = {
                departmentId: currentDepartment,
                name,
                academicYear,
                password: hashPassword(password),
                createdAt: new Date().toISOString(),
                createdBy: currentUser.email
            };

            const transaction = db.transaction(['folders'], 'readwrite');
            const store = transaction.objectStore('folders');
            const request = store.add(folder);

            request.onsuccess = function() {
                showAlert('Carpeta creada exitosamente', 'success');
                document.getElementById('folderForm').reset();
                loadFolders(currentDepartment);
                logActivity('folder_create', `El usuario ${currentUser.name} creó la carpeta "${name}" en el departamento ${getDepartmentName(currentDepartment)}`);
            };

            request.onerror = function(event) {
                console.error('Error al crear carpeta:', event.target.error);
                showAlert('Error al crear la carpeta', 'danger');
            };
        }

        // Cargar carpetas de un departamento
        function loadFolders(departmentId) {
            const transaction = db.transaction(['folders'], 'readonly');
            const store = transaction.objectStore('folders');
            const index = store.index('departmentId');
            const request = index.getAll(departmentId);

            request.onsuccess = function(event) {
                const folders = event.target.result;
                const container = document.getElementById('foldersContainer');
                container.innerHTML = '';

                if (folders.length === 0) {
                    container.innerHTML = '<div class="col-12"><p>No hay carpetas creadas en este departamento.</p></div>';
                    return;
                }

                folders.forEach(folder => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4';
                    col.innerHTML = `
                        <div class="card folder-card">
                            <div class="card-body">
                                <h5 class="card-title">${folder.name}</h5>
                                <p class="card-text">
                                    <small class="text-muted">Año académico: ${folder.academicYear}</small>
                                </p>
                                <button class="btn btn-sm btn-primary access-folder" data-id="${folder.id}">Acceder</button>
                                ${currentUser.role === 'admin' || currentUser.role === 'secretary' ? 
                                  `<button class="btn btn-sm btn-danger delete-folder ms-2" data-id="${folder.id}">Eliminar</button>` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });

                // Agregar event listeners a los botones
                document.querySelectorAll('.access-folder').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const folderId = parseInt(this.getAttribute('data-id'));
                        showFolderAccessModal(folderId);
                    });
                });

                document.querySelectorAll('.delete-folder').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const folderId = parseInt(this.getAttribute('data-id'));
                        if (confirm('¿Está seguro de eliminar esta carpeta y todos sus documentos? Esta acción no se puede deshacer.')) {
                            deleteFolder(folderId);
                        }
                    });
                });
            };
        }

        // Mostrar modal de acceso a carpeta
        function showFolderAccessModal(folderId) {
            // Si el usuario es admin o secretaría, no necesita contraseña
            if (currentUser.role === 'admin' || currentUser.role === 'secretary') {
                showDocumentsModal(folderId);
                return;
            }

            // Si ya se accedió a esta carpeta en esta sesión, no pedir contraseña de nuevo
            if (accessedFolders[folderId]) {
                showDocumentsModal(folderId);
                return;
            }

            document.getElementById('accessFolderId').value = folderId;
            const modal = new bootstrap.Modal(document.getElementById('folderAccessModal'));
            modal.show();
        }

        // Verificar acceso a carpeta
        function verifyFolderAccess(e) {
            e.preventDefault();
            const folderId = parseInt(document.getElementById('accessFolderId').value);
            const password = document.getElementById('accessPassword').value;

            const transaction = db.transaction(['folders'], 'readonly');
            const store = transaction.objectStore('folders');
            const request = store.get(folderId);

            request.onsuccess = function(event) {
                const folder = event.target.result;
                if (verifyPassword(password, folder.password)) {
                    accessedFolders[folderId] = true;
                    bootstrap.Modal.getInstance(document.getElementById('folderAccessModal')).hide();
                    showDocumentsModal(folderId);
                    document.getElementById('folderAccessForm').reset();
                } else {
                    showAlert('Contraseña incorrecta', 'danger');
                }
            };

            request.onerror = function(event) {
                console.error('Error al verificar acceso:', event.target.error);
                showAlert('Error al verificar acceso', 'danger');
            };
        }

        // Mostrar modal de documentos
        function showDocumentsModal(folderId) {
            const modal = new bootstrap.Modal(document.getElementById('documentsModal'));
            document.getElementById('documentsModalTitle').textContent = `Documentos en carpeta`;
            document.getElementById('uploadDocumentForm').setAttribute('data-folder-id', folderId);
            
            // Cargar documentos de la carpeta
            loadDocuments(folderId);
            modal.show();
        }

        // Subir un documento
        function uploadDocument(e) {
            e.preventDefault();
            const fileInput = document.getElementById('documentFile');
            const folderId = parseInt(this.getAttribute('data-folder-id'));
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showAlert('Por favor seleccione un archivo PDF', 'danger');
                return;
            }

            const file = fileInput.files[0];
            if (file.type !== 'application/pdf') {
                showAlert('Solo se permiten archivos PDF', 'danger');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const documentData = {
                    folderId,
                    name: file.name.replace('.pdf', ''),
                    fileName: file.name,
                    size: file.size,
                    data: event.target.result,
                    uploadedAt: new Date().toISOString(),
                    uploadedBy: currentUser.email
                };

                const transaction = db.transaction(['documents'], 'readwrite');
                const store = transaction.objectStore('documents');
                const request = store.add(documentData);

                request.onsuccess = function() {
                    showAlert('Documento subido exitosamente', 'success');
                    fileInput.value = '';
                    loadDocuments(folderId);
                    logActivity('document_upload', 
                        `El usuario ${currentUser.name} subió el documento "${file.name}" en la carpeta ${getFolderName(folderId)} del departamento ${getDepartmentNameFromFolder(folderId)}`);
                };

                request.onerror = function(event) {
                    console.error('Error al subir documento:', event.target.error);
                    showAlert('Error al subir el documento', 'danger');
                };
            };
            reader.readAsDataURL(file);
        }

        // Cargar documentos de una carpeta
        function loadDocuments(folderId) {
            const transaction = db.transaction(['documents'], 'readonly');
            const store = transaction.objectStore('documents');
            const index = store.index('folderId');
            const request = index.getAll(folderId);

            request.onsuccess = function(event) {
                const documents = event.target.result;
                const tbody = document.querySelector('#documentsTable tbody');
                tbody.innerHTML = '';

                if (documents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3">No hay documentos en esta carpeta.</td></tr>';
                    return;
                }

                documents.forEach(doc => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${doc.name}</td>
                        <td>${formatFileSize(doc.size)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary download-doc" data-id="${doc.id}" data-name="${doc.fileName}">Descargar</button>
                            <button class="btn btn-sm btn-secondary rename-doc ms-2" data-id="${doc.id}" data-name="${doc.name}">Renombrar</button>
                            <button class="btn btn-sm btn-info print-doc ms-2" data-id="${doc.id}">Imprimir</button>
                            ${currentUser.role !== 'user' ? 
                              `<button class="btn btn-sm btn-danger delete-doc ms-2" data-id="${doc.id}" data-name="${doc.name}">Eliminar</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Agregar event listeners a los botones
                document.querySelectorAll('.download-doc').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const docId = parseInt(this.getAttribute('data-id'));
                        const docName = this.getAttribute('data-name');
                        downloadDocument(docId, docName);
                    });
                });

                document.querySelectorAll('.rename-doc').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const docId = parseInt(this.getAttribute('data-id'));
                        const currentName = this.getAttribute('data-name');
                        showRenameDocumentModal(docId, currentName);
                    });
                });

                document.querySelectorAll('.print-doc').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const docId = parseInt(this.getAttribute('data-id'));
                        printDocument(docId);
                    });
                });

                document.querySelectorAll('.delete-doc').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const docId = parseInt(this.getAttribute('data-id'));
                        const docName = this.getAttribute('data-name');
                        if (confirm(`¿Está seguro de eliminar el documento "${docName}"?`)) {
                            deleteDocument(docId, docName);
                        }
                    });
                });
            };
        }

        // Mostrar modal para renombrar documento
        function showRenameDocumentModal(docId, currentName) {
            document.getElementById('renameDocumentId').value = docId;
            document.getElementById('newDocumentName').value = currentName;
            const modal = new bootstrap.Modal(document.getElementById('renameDocumentModal'));
            modal.show();
        }

        // Renombrar documento
        function renameDocument(e) {
            e.preventDefault();
            const docId = parseInt(document.getElementById('renameDocumentId').value);
            const newName = document.getElementById('newDocumentName').value;

            const transaction = db.transaction(['documents'], 'readwrite');
            const store = transaction.objectStore('documents');
            const request = store.get(docId);

            request.onsuccess = function(event) {
                const doc = event.target.result;
                const oldName = doc.name;
                doc.name = newName;

                const updateRequest = store.put(doc);
                updateRequest.onsuccess = function() {
                    bootstrap.Modal.getInstance(document.getElementById('renameDocumentModal')).hide();
                    document.getElementById('renameDocumentForm').reset();
                    
                    // Recargar documentos
                    const folderId = doc.folderId;
                    loadDocuments(folderId);
                    
                    logActivity('document_rename', 
                        `El usuario ${currentUser.name} renombró el documento "${oldName}" a "${newName}" en la carpeta ${getFolderName(folderId)} del departamento ${getDepartmentNameFromFolder(folderId)}`);
                };

                updateRequest.onerror = function(event) {
                    console.error('Error al renombrar documento:', event.target.error);
                    showAlert('Error al renombrar el documento', 'danger');
                };
            };
        }

        // Descargar documento
        function downloadDocument(docId, docName) {
            const transaction = db.transaction(['documents'], 'readonly');
            const store = transaction.objectStore('documents');
            const request = store.get(docId);

            request.onsuccess = function(event) {
                const doc = event.target.result;
                const link = document.createElement('a');
                link.href = doc.data;
                link.download = docName || doc.fileName;
                link.click();
                
                logActivity('document_download', 
                    `El usuario ${currentUser.name} descargó el documento "${doc.name}" de la carpeta ${getFolderName(doc.folderId)} del departamento ${getDepartmentNameFromFolder(doc.folderId)}`);
            };
        }

        // Imprimir documento
        function printDocument(docId) {
            const transaction = db.transaction(['documents'], 'readonly');
            const store = transaction.objectStore('documents');
            const request = store.get(docId);

            request.onsuccess = function(event) {
                const doc = event.target.result;
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = doc.data;
                document.body.appendChild(iframe);
                
                iframe.onload = function() {
                    setTimeout(() => {
                        iframe.contentWindow.print();
                        document.body.removeChild(iframe);
                        
                        logActivity('document_print', 
                            `El usuario ${currentUser.name} imprimió el documento "${doc.name}" de la carpeta ${getFolderName(doc.folderId)} del departamento ${getDepartmentNameFromFolder(doc.folderId)}`);
                    }, 500);
                };
            };
        }

        // Eliminar documento
        function deleteDocument(docId, docName) {
            const transaction = db.transaction(['documents'], 'readwrite');
            const store = transaction.objectStore('documents');
            const request = store.get(docId);

            request.onsuccess = function(event) {
                const doc = event.target.result;
                const deleteRequest = store.delete(docId);

                deleteRequest.onsuccess = function() {
                    showAlert('Documento eliminado exitosamente', 'success');
                    loadDocuments(doc.folderId);
                    
                    logActivity('document_delete', 
                        `El usuario ${currentUser.name} eliminó el documento "${docName}" de la carpeta ${getFolderName(doc.folderId)} del departamento ${getDepartmentNameFromFolder(doc.folderId)}`);
                };

                deleteRequest.onerror = function(event) {
                    console.error('Error al eliminar documento:', event.target.error);
                    showAlert('Error al eliminar el documento', 'danger');
                };
            };
        }

        // Eliminar carpeta
        function deleteFolder(folderId) {
            const transaction = db.transaction(['folders', 'documents'], 'readwrite');
            const foldersStore = transaction.objectStore('folders');
            const docsStore = transaction.objectStore('documents');

            // Primero, obtener el nombre de la carpeta para el log
            const getRequest = foldersStore.get(folderId);
            let folderName = '';

            getRequest.onsuccess = function(event) {
                folderName = event.target.result.name;
                const departmentName = getDepartmentName(event.target.result.departmentId);

                // Eliminar todos los documentos de esta carpeta
                const docsIndex = docsStore.index('folderId');
                const docsRequest = docsIndex.getAll(folderId);

                docsRequest.onsuccess = function(event) {
                    const docs = event.target.result;
                    docs.forEach(doc => {
                        docsStore.delete(doc.id);
                    });

                    // Finalmente, eliminar la carpeta
                    foldersStore.delete(folderId);
                    
                    // Actualizar UI
                    loadFolders(currentDepartment);
                    showAlert('Carpeta eliminada exitosamente', 'success');
                    logActivity('folder_delete', 
                        `El usuario ${currentUser.name} eliminó la carpeta "${folderName}" del departamento ${departmentName}`);
                };
            };

            transaction.onerror = function(event) {
                console.error('Error al eliminar carpeta:', event.target.error);
                showAlert('Error al eliminar la carpeta', 'danger');
            };
        }

        // Cargar logs de actividad
        function loadActivityLogs() {
            const transaction = db.transaction(['activityLogs'], 'readonly');
            const store = transaction.objectStore('activityLogs');
            const index = store.index('timestamp');
            const request = index.getAll();

            request.onsuccess = function(event) {
                const logs = event.target.result.reverse(); // Más recientes primero
                const tbody = document.getElementById('activityLogTable');
                tbody.innerHTML = '';

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No hay actividades registradas.</td></tr>';
                    return;
                }

                logs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDateTime(log.timestamp)}</td>
                        <td>${log.userName}</td>
                        <td>${getRoleName(log.userRole)}</td>
                        <td>${log.department || 'N/A'}</td>
                        <td>${log.action}</td>
                        <td>${log.details}</td>
                    `;
                    tbody.appendChild(tr);
                });
            };
        }

        // Registrar actividad
        function logActivity(action, details, department = null) {
            if (!currentUser) return;

            const log = {
                timestamp: new Date().toISOString(),
                userName: currentUser.name,
                userRole: currentUser.role,
                action,
                details,
                department: department || (currentDepartment ? getDepartmentName(currentDepartment) : null)
            };

            const transaction = db.transaction(['activityLogs'], 'readwrite');
            const store = transaction.objectStore('activityLogs');
            store.add(log);
        }

        // Cargar estadísticas rápidas
        function loadQuickStats() {
            Promise.all([
                countRecords('departments'),
                countRecords('folders'),
                countRecords('documents')
            ]).then(results => {
                const statsContainer = document.getElementById('quickStats');
                statsContainer.innerHTML = `
                    <div class="col-md-4">
                        <div class="card text-white bg-primary mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Departamentos</h5>
                                <p class="card-text display-6">${results[0]}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-white bg-success mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Carpetas</h5>
                                <p class="card-text display-6">${results[1]}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-white bg-info mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Documentos</h5>
                                <p class="card-text display-6">${results[2]}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // Contar registros en un object store
        function countRecords(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.count();

                request.onsuccess = function() {
                    resolve(request.result);
                };

                request.onerror = function(event) {
                    console.error(`Error al contar registros en ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Obtener nombre de departamento
        function getDepartmentName(deptId) {
            return new Promise((resolve, reject) => {
                if (!deptId) resolve('N/A');

                const transaction = db.transaction(['departments'], 'readonly');
                const store = transaction.objectStore('departments');
                const request = store.get(deptId);

                request.onsuccess = function(event) {
                    resolve(event.target.result?.name || 'N/A');
                };

                request.onerror = function(event) {
                    console.error('Error al obtener nombre de departamento:', event.target.error);
                    reject('N/A');
                };
            });
        }

        // Obtener nombre de departamento desde una carpeta
        function getDepartmentNameFromFolder(folderId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['folders'], 'readonly');
                const store = transaction.objectStore('folders');
                const request = store.get(folderId);

                request.onsuccess = function(event) {
                    const folder = event.target.result;
                    if (folder) {
                        getDepartmentName(folder.departmentId).then(resolve).catch(reject);
                    } else {
                        resolve('N/A');
                    }
                };

                request.onerror = function(event) {
                    console.error('Error al obtener carpeta:', event.target.error);
                    reject('N/A');
                };
            });
        }

        // Obtener nombre de carpeta
        function getFolderName(folderId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['folders'], 'readonly');
                const store = transaction.objectStore('folders');
                const request = store.get(folderId);

                request.onsuccess = function(event) {
                    resolve(event.target.result?.name || 'N/A');
                };

                request.onerror = function(event) {
                    console.error('Error al obtener nombre de carpeta:', event.target.error);
                    reject('N/A');
                };
            });
        }

        // Funciones de utilidad
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString();
        }

        function verifyPassword(inputPassword, storedHash) {
            return hashPassword(inputPassword) === storedHash;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.role = 'alert';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.prepend(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 5000);
        }
    </script>
</body>
</html>
