<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mYpuB - Almacenamiento en la Nube</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .brand-font {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            font-weight: bold;
            color: #212529;
        }
        .password-strength {
            height: 5px;
            width: 100%;
            background-color: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        .password-weak {
            background-color: #dc3545;
            width: 25%;
        }
        .password-medium {
            background-color: #fd7e14;
            width: 50%;
        }
        .password-strong {
            background-color: #ffc107;
            width: 75%;
        }
        .password-very-strong {
            background-color: #198754;
            width: 100%;
        }
        .file-card {
            transition: transform 0.2s;
        }
        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .video-play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: rgba(255,255,255,0.8);
        }
        #help-panel {
            position: absolute;
            right: 0;
            top: 100%;
            z-index: 1000;
            display: none;
            min-width: 250px;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        .file-thumbnail {
            height: 150px;
            object-fit: cover;
        }
        .video-thumbnail {
            position: relative;
            height: 150px;
            background-color: #000;
            background-position: center;
            background-repeat: no-repeat;
            background-size: contain;
            cursor: pointer;
        }
        .app-section {
            display: none;
        }
        .active-section {
            display: block;
        }
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .auth-card {
            width: 100%;
            max-width: 500px;
        }
        #app-container {
            display: none;
        }
        .folder-breadcrumb {
            background-color: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }
        .folder-breadcrumb a {
            text-decoration: none;
            color: #0d6efd;
            cursor: pointer;
        }
        .progress {
            height: 5px;
        }
        .storage-progress {
            margin-top: 5px;
        }
        .upload-progress {
            margin-top: 10px;
            display: none;
        }
        .chunk-progress {
            margin-top: 5px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Register Container (shown first) -->
    <div id="register-container" class="auth-container">
        <div class="card shadow-sm auth-card">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Regístrate en <span class="brand-font">mYpuB</span></h2>
                    <button id="register-help-button" class="btn btn-link text-primary">
                        <i class="bi bi-question-circle" style="font-size: 1.5rem;"></i>
                    </button>
                    <div id="register-help-panel" class="card shadow" style="display: none; position: absolute; right: 20px; top: 80px; z-index: 1000;">
                        <div class="card-body p-2">
                            <button id="register-email-help" class="btn btn-link text-decoration-none w-100 text-start">
                                <i class="bi bi-envelope me-2"></i>Ayuda por Email
                            </button>
                            <button id="register-whatsapp-help" class="btn btn-link text-decoration-none w-100 text-start">
                                <i class="bi bi-whatsapp me-2"></i>Ayuda por WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
                <form id="register-form">
                    <div class="mb-3">
                        <label for="full-name" class="form-label">Nombre completo</label>
                        <input type="text" class="form-control" id="full-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Correo electrónico (Gmail)</label>
                        <input type="email" class="form-control" id="email" required>
                        <div class="invalid-feedback">Debe ser una dirección de Gmail válida</div>
                    </div>
                    <div class="mb-3">
                        <label for="gender" class="form-label">Género</label>
                        <select class="form-select" id="gender" required>
                            <option value="" selected disabled>Selecciona tu género</option>
                            <option value="Hombre">Hombre</option>
                            <option value="Mujer">Mujer</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="row mb-3">
                        <div class="col-3">
                            <label for="phone-prefix" class="form-label">Prefijo</label>
                            <input type="text" class="form-control" id="phone-prefix" value="240" required>
                        </div>
                        <div class="col-9">
                            <label for="phone" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="password" required>
                        <small class="form-text text-muted">Debe contener 6 letras (1 mayúscula), 4 números y 2 símbolos (@#&)</small>
                        <div class="password-strength mt-1"></div>
                        <div class="invalid-feedback">La contraseña no cumple con los requisitos</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirm-password" class="form-label">Confirmar contraseña</label>
                        <input type="password" class="form-control" id="confirm-password" required>
                        <div class="invalid-feedback">Las contraseñas no coinciden</div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Registrarse</button>
                        <button type="button" id="switch-to-login" class="btn btn-link text-decoration-none">¿Ya tienes cuenta? Inicia sesión</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Login Container (hidden initially) -->
    <div id="login-container" class="auth-container" style="display: none;">
        <div class="card shadow-sm auth-card">
            <div class="card-body p-4">
                <h2 class="text-center mb-4">Inicie la sesión en <span class="brand-font">mYpuB</span></h2>
                <form id="login-form">
                    <div class="mb-3">
                        <label for="login-email" class="form-label">Correo electrónico</label>
                        <input type="email" class="form-control" id="login-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="login-password" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Iniciar sesión</button>
                        <button type="button" id="switch-to-register" class="btn btn-link text-decoration-none">¿No tienes cuenta? Regístrate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- App Container (hidden initially) -->
    <div id="app-container" class="container-fluid p-0" style="display: none;">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand brand-font" href="#">mYpuB</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="upload">SUBIR TU</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="gallery">GALERÍA</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="share">COMPARTIR</a>
                        </li>
                        <li class="nav-item" id="users-nav-item" style="display: none;">
                            <a class="nav-link" href="#" data-section="users">USUARIOS</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="info">INFORMACIÓN</a>
                        </li>
                    </ul>
                    <div class="d-flex align-items-center">
                        <div class="dropdown">
                            <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle me-1"></i>
                                <span id="welcome-message"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><span class="dropdown-item-text small" id="storage-info">Almacenamiento: <span id="storage-used">0</span> GB / <span id="storage-total">100</span> GB</span></li>
                                <li><div class="progress storage-progress mx-2">
                                    <div id="storage-progress-bar" class="progress-bar" role="progressbar"></div>
                                </div></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión</button></li>
                            </ul>
                        </div>
                        <button id="help-button" class="btn btn-link text-white ms-2">
                            <i class="bi bi-question-circle" style="font-size: 1.5rem;"></i>
                        </button>
                        <div id="help-panel" class="card shadow">
                            <div class="card-body p-2">
                                <button id="email-help" class="btn btn-link text-decoration-none w-100 text-start">
                                    <i class="bi bi-envelope me-2"></i>Ayuda por Email
                                </button>
                                <button id="whatsapp-help" class="btn btn-link text-decoration-none w-100 text-start">
                                    <i class="bi bi-whatsapp me-2"></i>Ayuda por WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container py-4">
            <!-- Upload Section -->
            <div id="upload-section" class="app-section active-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-cloud-arrow-up me-2"></i>Subir archivo</h5>
                    </div>
                    <div class="card-body">
                        <form id="upload-form">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="file-type" class="form-label">Tipo de archivo</label>
                                    <select class="form-select" id="file-type" required>
                                        <option value="" selected disabled>Selecciona un tipo</option>
                                        <option value="image">Imagen</option>
                                        <option value="video">Video</option>
                                        <option value="audio">Audio</option>
                                        <option value="document">Documento (PDF)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="file-folder" class="form-label">Carpeta</label>
                                    <div class="input-group">
                                        <select class="form-select" id="file-folder">
                                            <option value="">Sin carpeta (raíz)</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" id="create-folder-btn">
                                            <i class="bi bi-folder-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="file-input" class="form-label">Archivo</label>
                                <input class="form-control" type="file" id="file-input" required>
                            </div>
                            <div class="mb-3">
                                <label for="file-title" class="form-label">Título (opcional)</label>
                                <input type="text" class="form-control" id="file-title" placeholder="Si no se proporciona, se usará el nombre del archivo">
                            </div>
                            <div class="mb-3">
                                <label for="file-description" class="form-label">Descripción (opcional)</label>
                                <textarea class="form-control" id="file-description" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Visibilidad</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="visibility" id="public-visibility" value="public" checked>
                                    <label class="form-check-label" for="public-visibility">
                                        Público (visible para todos los usuarios)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="visibility" id="private-visibility" value="private">
                                    <label class="form-check-label" for="private-visibility">
                                        Privado (solo visible para ti)
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Permisos</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="allow-comments" checked>
                                    <label class="form-check-label" for="allow-comments">
                                        Permitir comentarios
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="allow-download" checked>
                                    <label class="form-check-label" for="allow-download">
                                        Permitir descargas
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="allow-likes" checked>
                                    <label class="form-check-label" for="allow-likes">
                                        Permitir "me gusta"
                                    </label>
                                </div>
                            </div>
                            <div class="upload-progress" id="upload-progress">
                                <div class="d-flex justify-content-between">
                                    <small>Progreso total:</small>
                                    <small id="upload-percentage">0%</small>
                                </div>
                                <div class="progress mb-2">
                                    <div id="upload-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div class="chunk-progress" id="chunk-progress">
                                    <div class="d-flex justify-content-between">
                                        <small>Fragmento actual:</small>
                                        <small id="chunk-percentage">0%</small>
                                    </div>
                                    <div class="progress">
                                        <div id="chunk-progress-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" id="upload-btn">
                                <i class="bi bi-upload me-1"></i>Subir archivo
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Gallery Section -->
            <div id="gallery-section" class="app-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-collection me-2"></i>Galería de archivos</h5>
                        <div>
                            <button id="create-folder-gallery-btn" class="btn btn-outline-secondary btn-sm me-2">
                                <i class="bi bi-folder-plus"></i> Nueva carpeta
                            </button>
                            <button id="refresh-gallery" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="folder-breadcrumb" class="folder-breadcrumb mb-3">
                            <a class="root-folder">Raíz</a>
                        </div>
                        <div class="row" id="gallery-content">
                            <!-- Files and folders will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Share Section -->
            <div id="share-section" class="app-section">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="bi bi-share me-2"></i>Compartir archivo</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="share-user" class="form-label">Usuario</label>
                                    <select class="form-select" id="share-user" required>
                                        <option value="" selected disabled>Selecciona un usuario</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="share-file" class="form-label">Archivo</label>
                                    <select class="form-select" id="share-file" required>
                                        <option value="" selected disabled>Selecciona un archivo</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="share-message" class="form-label">Mensaje (opcional)</label>
                                    <textarea class="form-control" id="share-message" rows="3"></textarea>
                                </div>
                                <button id="share-btn" class="btn btn-primary">
                                    <i class="bi bi-send me-1"></i>Compartir
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Archivos compartidos contigo</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Archivo</th>
                                                <th>De</th>
                                                <th>Fecha</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="shared-files-list">
                                            <tr>
                                                <td colspan="4" class="text-center py-3 text-muted">
                                                    No tienes archivos compartidos contigo
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" class="app-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Gestión de usuarios</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Género</th>
                                        <th>Teléfono</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="users-list">
                                    <tr>
                                        <td colspan="6" class="text-center py-3 text-muted">
                                            No hay usuarios registrados
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Section -->
            <div id="info-section" class="app-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Información sobre mYpuB</h5>
                    </div>
                    <div class="card-body">
                        <h5 class="mb-3">Acerca de la aplicación</h5>
                        <p>mYpuB es una aplicación de almacenamiento en la nube desarrollada por Tarciano ENZEMA NCHAMA como proyecto demostrativo.</p>
                        
                        <h5 class="mb-3 mt-4">Características principales</h5>
                        <ul>
                            <li>Almacenamiento de archivos (imágenes, videos, audio y documentos PDF)</li>
                            <li>Organización en carpetas</li>
                            <li>Compartir archivos con otros usuarios</li>
                            <li>Sistema de comentarios y "me gusta"</li>
                            <li>Gestión de usuarios (para desarrolladores)</li>
                        </ul>
                        
                        <h5 class="mb-3 mt-4">Requisitos de contraseña</h5>
                        <p>Para registrarse, la contraseña debe cumplir con los siguientes requisitos:</p>
                        <ul>
                            <li>6 letras (1 mayúscula y 5 minúsculas)</li>
                            <li>4 números</li>
                            <li>2 símbolos (@, # o &)</li>
                            <li>Longitud total de 12 caracteres</li>
                        </ul>
                        
                        <h5 class="mb-3 mt-4">Contacto</h5>
                        <p>Para soporte técnico o más información, contacta al desarrollador:</p>
                        <p><i class="bi bi-envelope me-2"></i>enzemajr@gmail.com</p>
                        <p><i class="bi bi-whatsapp me-2"></i>+240 222 084 663</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Folder Modal -->
    <div class="modal fade" id="createFolderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Crear nueva carpeta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-folder-form">
                        <div class="mb-3">
                            <label for="folder-name" class="form-label">Nombre de la carpeta</label>
                            <input type="text" class="form-control" id="folder-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Visibilidad</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="folder-visibility" id="folder-public" value="public" checked>
                                <label class="form-check-label" for="folder-public">
                                    Pública (visible para todos los usuarios)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="folder-visibility" id="folder-private" value="private">
                                <label class="form-check-label" for="folder-private">
                                    Privada (solo visible para ti)
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirm-create-folder">Crear carpeta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="preview-file-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="preview-file-content">
                    <!-- File content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="download-file-btn" style="display: none;">
                        <i class="bi bi-download"></i> Descargar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="toast-header">
            <strong id="toast-title" class="me-auto"></strong>
            <small id="toast-time"></small>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toast-message"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Database Class using IndexedDB
        class IndexedDBWrapper {
            constructor(dbName, version) {
                this.dbName = dbName;
                this.version = version;
                this.db = null;
            }

            async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Create object stores if they don't exist
                        if (!db.objectStoreNames.contains('users')) {
                            const usersStore = db.createObjectStore('users', { keyPath: 'id' });
                            usersStore.createIndex('email', 'email', { unique: true });
                        }
                        
                        if (!db.objectStoreNames.contains('files')) {
                            const filesStore = db.createObjectStore('files', { keyPath: 'id' });
                            filesStore.createIndex('ownerId', 'ownerId');
                            filesStore.createIndex('folderId', 'folderId');
                        }
                        
                        if (!db.objectStoreNames.contains('folders')) {
                            const foldersStore = db.createObjectStore('folders', { keyPath: 'id' });
                            foldersStore.createIndex('ownerId', 'ownerId');
                            foldersStore.createIndex('parentId', 'parentId');
                        }
                        
                        if (!db.objectStoreNames.contains('shares')) {
                            const sharesStore = db.createObjectStore('shares', { keyPath: 'id' });
                            sharesStore.createIndex('fromUserId', 'fromUserId');
                            sharesStore.createIndex('toUserId', 'toUserId');
                            sharesStore.createIndex('fileId', 'fileId');
                        }
                        
                        if (!db.objectStoreNames.contains('comments')) {
                            const commentsStore = db.createObjectStore('comments', { keyPath: 'id' });
                            commentsStore.createIndex('fileId', 'fileId');
                            commentsStore.createIndex('userId', 'userId');
                        }
                        
                        if (!db.objectStoreNames.contains('likes')) {
                            const likesStore = db.createObjectStore('likes', { keyPath: 'id' });
                            likesStore.createIndex('fileId', 'fileId');
                            likesStore.createIndex('userId', 'userId');
                        }
                    };
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    
                    request.onerror = (event) => {
                        reject(`Error opening database: ${event.target.error}`);
                    };
                });
            }

            async add(storeName, item) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(item);
                    
                    request.onsuccess = () => resolve(item);
                    request.onerror = (event) => reject(`Error adding item: ${event.target.error}`);
                });
            }

            async get(storeName, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(`Error getting item: ${event.target.error}`);
                });
            }

            async getAll(storeName, indexName = null, key = null) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    
                    let request;
                    if (indexName && key !== null) {
                        const index = store.index(indexName);
                        request = index.getAll(key);
                    } else if (indexName) {
                        const index = store.index(indexName);
                        request = index.getAll();
                    } else {
                        request = store.getAll();
                    }
                    
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(`Error getting items: ${event.target.error}`);
                });
            }

            async update(storeName, key, updates) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    // First get the item
                    const getRequest = store.get(key);
                    
                    getRequest.onsuccess = () => {
                        const item = getRequest.result;
                        if (!item) {
                            reject('Item not found');
                            return;
                        }
                        
                        // Apply updates
                        const updatedItem = { ...item, ...updates };
                        
                        // Put it back
                        const putRequest = store.put(updatedItem);
                        
                        putRequest.onsuccess = () => resolve(updatedItem);
                        putRequest.onerror = (event) => reject(`Error updating item: ${event.target.error}`);
                    };
                    
                    getRequest.onerror = (event) => reject(`Error getting item for update: ${event.target.error}`);
                });
            }

            async delete(storeName, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = (event) => reject(`Error deleting item: ${event.target.error}`);
                });
            }

            async count(storeName, indexName = null, key = null) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    
                    let request;
                    if (indexName && key !== null) {
                        const index = store.index(indexName);
                        request = index.count(key);
                    } else if (indexName) {
                        const index = store.index(indexName);
                        request = index.count();
                    } else {
                        request = store.count();
                    }
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(`Error counting items: ${event.target.error}`);
                });
            }

            async clear(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = (event) => reject(`Error clearing store: ${event.target.error}`);
                });
            }
        }

        // Main Application Class
        class mYpuBApp {
            constructor() {
                this.db = new IndexedDBWrapper('mYpuB_DB', 1);
                this.currentUser = null;
                this.currentFolderId = null;
                this.chunkSize = 5 * 1024 * 1024; // 5MB chunks for large files
                this.initElements();
                this.initEventListeners();
                this.initializeApp();
            }

            async initializeApp() {
                try {
                    await this.db.open();
                    await this.initializeDeveloper();
                    
                    // Mostrar siempre primero el formulario de registro
                    this.showRegisterForm();
                    
                    // Verificar si hay un usuario logueado para mostrar directamente el login
                    const loggedInUser = localStorage.getItem('mYpuB_currentUser');
                    if (loggedInUser) {
                        const userData = JSON.parse(loggedInUser);
                        const dbUser = await this.db.get('users', userData.id);
                        
                        if (dbUser && dbUser.password === userData.password) {
                            this.currentUser = dbUser;
                            this.showLoginForm();
                        }
                    }
                } catch (error) {
                    console.error('Error initializing app:', error);
                    this.showToast('Error', 'No se pudo inicializar la aplicación', 'danger');
                }
            }

            async initializeDeveloper() {
                const developer = {
                    id: 'dev-001',
                    fullName: 'Tarciano ENZEMA NCHAMA',
                    email: 'enzemajr@gmail.com',
                    gender: 'Hombre',
                    phonePrefix: '240',
                    phone: '222084663',
                    password: 'Enzema0097@&',
                    storageLimit: 1000, // Unlimited storage for developer
                    isDeveloper: true,
                    status: 'active',
                    registeredAt: new Date().toISOString()
                };
                
                try {
                    // Check if developer already exists
                    const existingDev = await this.db.get('users', developer.id);
                    if (!existingDev) {
                        await this.db.add('users', developer);
                    }
                } catch (error) {
                    console.error('Error initializing developer:', error);
                }
            }

            initElements() {
                // Auth elements
                this.loginContainer = document.getElementById('login-container');
                this.registerContainer = document.getElementById('register-container');
                this.loginForm = document.getElementById('login-form');
                this.registerForm = document.getElementById('register-form');
                this.switchToLogin = document.getElementById('switch-to-login');
                this.switchToRegister = document.getElementById('switch-to-register');
                this.registerHelpButton = document.getElementById('register-help-button');
                this.registerHelpPanel = document.getElementById('register-help-panel');
                this.registerEmailHelp = document.getElementById('register-email-help');
                this.registerWhatsappHelp = document.getElementById('register-whatsapp-help');
                
                // Form fields
                this.fullName = document.getElementById('full-name');
                this.email = document.getElementById('email');
                this.gender = document.getElementById('gender');
                this.phonePrefix = document.getElementById('phone-prefix');
                this.phone = document.getElementById('phone');
                this.password = document.getElementById('password');
                this.confirmPassword = document.getElementById('confirm-password');
                this.loginEmail = document.getElementById('login-email');
                this.loginPassword = document.getElementById('login-password');
                
                // App elements
                this.appContainer = document.getElementById('app-container');
                this.welcomeMessage = document.getElementById('welcome-message');
                this.storageUsed = document.getElementById('storage-used');
                this.storageTotal = document.getElementById('storage-total');
                this.storageProgressBar = document.getElementById('storage-progress-bar');
                this.logoutBtn = document.getElementById('logout-btn');
                
                // Section elements
                this.appSections = document.querySelectorAll('.app-section');
                this.navLinks = document.querySelectorAll('[data-section]');
                this.usersNavItem = document.getElementById('users-nav-item');
                
                // Upload section
                this.uploadForm = document.getElementById('upload-form');
                this.fileType = document.getElementById('file-type');
                this.fileInput = document.getElementById('file-input');
                this.fileTitle = document.getElementById('file-title');
                this.fileDescription = document.getElementById('file-description');
                this.fileFolder = document.getElementById('file-folder');
                this.createFolderBtn = document.getElementById('create-folder-btn');
                this.uploadProgress = document.getElementById('upload-progress');
                this.uploadProgressBar = document.getElementById('upload-progress-bar');
                this.uploadPercentage = document.getElementById('upload-percentage');
                this.chunkProgress = document.getElementById('chunk-progress');
                this.chunkProgressBar = document.getElementById('chunk-progress-bar');
                this.chunkPercentage = document.getElementById('chunk-percentage');
                this.uploadBtn = document.getElementById('upload-btn');
                
                // Gallery section
                this.galleryContent = document.getElementById('gallery-content');
                this.refreshGallery = document.getElementById('refresh-gallery');
                this.createFolderGalleryBtn = document.getElementById('create-folder-gallery-btn');
                this.folderBreadcrumb = document.getElementById('folder-breadcrumb');
                
                // Share section
                this.shareUser = document.getElementById('share-user');
                this.shareFile = document.getElementById('share-file');
                this.shareMessage = document.getElementById('share-message');
                this.shareBtn = document.getElementById('share-btn');
                this.sharedFilesList = document.getElementById('shared-files-list');
                
                // Users section
                this.usersList = document.getElementById('users-list');
                
                // Create folder modal
                this.folderName = document.getElementById('folder-name');
                this.confirmCreateFolder = document.getElementById('confirm-create-folder');
                
                // File preview modal
                this.previewFileTitle = document.getElementById('preview-file-title');
                this.previewFileContent = document.getElementById('preview-file-content');
                this.downloadFileBtn = document.getElementById('download-file-btn');
                
                // Help elements
                this.helpButton = document.getElementById('help-button');
                this.helpPanel = document.getElementById('help-panel');
                this.emailHelp = document.getElementById('email-help');
                this.whatsappHelp = document.getElementById('whatsapp-help');
                
                // Toast
                this.toast = new bootstrap.Toast(document.getElementById('toast'));
                this.toastTitle = document.getElementById('toast-title');
                this.toastMessage = document.getElementById('toast-message');
                this.toastTime = document.getElementById('toast-time');
                
                // Modals
                this.createFolderModal = new bootstrap.Modal(document.getElementById('createFolderModal'));
                this.filePreviewModal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
            }

            initEventListeners() {
                // Auth events
                this.switchToLogin.addEventListener('click', () => this.showLoginForm());
                this.switchToRegister.addEventListener('click', () => this.showRegisterForm());
                this.loginForm.addEventListener('submit', (e) => this.handleLoginSubmit(e));
                this.registerForm.addEventListener('submit', (e) => this.handleRegisterSubmit(e));
                this.password.addEventListener('input', () => this.checkPasswordStrength());
                this.registerHelpButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.registerHelpPanel.style.display = this.registerHelpPanel.style.display === 'block' ? 'none' : 'block';
                });
                
                // Register help buttons
                this.registerEmailHelp.addEventListener('click', () => {
                    window.location.href = 'mailto:enzemajr@gmail.com?subject=Ayuda%20con%20registro%20en%20mYpuB';
                });
                
                this.registerWhatsappHelp.addEventListener('click', () => {
                    window.open('https://wa.me/240222084663?text=Necesito%20ayuda%20con%20el%20registro%20en%20mYpuB', '_blank');
                });
                
                // App events
                this.logoutBtn.addEventListener('click', () => this.logout());
                this.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showSection(link.getAttribute('data-section'));
                    });
                });
                
                // Upload events
                this.uploadForm.addEventListener('submit', (e) => this.handleFileUpload(e));
                this.createFolderBtn.addEventListener('click', () => this.showCreateFolderModal());
                this.createFolderGalleryBtn.addEventListener('click', () => this.showCreateFolderModal());
                
                // Gallery events
                this.refreshGallery.addEventListener('click', () => this.loadGallery(this.currentFolderId));
                
                // Share events
                this.shareBtn.addEventListener('click', () => this.shareFileWithUser());
                
                // Create folder modal events
                this.confirmCreateFolder.addEventListener('click', () => this.createFolder());
                
                // Help panel events
                this.helpButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.helpPanel.style.display = this.helpPanel.style.display === 'block' ? 'none' : 'block';
                });
                
                this.emailHelp.addEventListener('click', () => {
                    window.location.href = 'mailto:enzemajr@gmail.com?subject=Ayuda%20con%20mYpuB';
                });
                
                this.whatsappHelp.addEventListener('click', () => {
                    window.open('https://wa.me/240222084663?text=Necesito%20ayuda%20con%20mYpuB', '_blank');
                });
                
                // Close help panels when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.registerHelpButton.contains(e.target) && !this.registerHelpPanel.contains(e.target)) {
                        this.registerHelpPanel.style.display = 'none';
                    }
                    
                    if (!this.helpButton.contains(e.target) && !this.helpPanel.contains(e.target)) {
                        this.helpPanel.style.display = 'none';
                    }
                });
            }

            // Auth methods
            showLoginForm() {
                this.loginContainer.style.display = 'flex';
                this.registerContainer.style.display = 'none';
                this.appContainer.style.display = 'none';
                this.loginEmail.value = '';
                this.loginPassword.value = '';
            }

            showRegisterForm() {
                this.registerContainer.style.display = 'flex';
                this.loginContainer.style.display = 'none';
                this.appContainer.style.display = 'none';
                this.fullName.value = '';
                this.email.value = '';
                this.gender.value = '';
                this.phonePrefix.value = '240';
                this.phone.value = '';
                this.password.value = '';
                this.confirmPassword.value = '';
                this.registerHelpPanel.style.display = 'none';
            }

            async showApp() {
                this.loginContainer.style.display = 'none';
                this.registerContainer.style.display = 'none';
                this.appContainer.style.display = 'block';
                
                // Show welcome message based on gender
                let welcomeMsg = '';
                if (this.currentUser.gender === 'Hombre') {
                    welcomeMsg = `Bienvenido a <span class="brand-font">mYpuB</span> Sr. ${this.currentUser.fullName.split(' ')[0]}`;
                } else if (this.currentUser.gender === 'Mujer') {
                    welcomeMsg = `Bienvenida a <span class="brand-font">mYpuB</span> Sra. ${this.currentUser.fullName.split(' ')[0]}`;
                } else {
                    welcomeMsg = `Gracias por utilizar <span class="brand-font">mYpuB</span>`;
                }
                this.welcomeMessage.innerHTML = welcomeMsg;
                
                // Update storage info
                await this.updateStorageInfo();
                
                // Show developer controls if user is developer
                if (this.currentUser.isDeveloper) {
                    this.usersNavItem.style.display = 'block';
                } else {
                    this.usersNavItem.style.display = 'none';
                }
                
                // Load initial section
                this.showSection('upload');
            }

            checkPasswordStrength() {
                const password = this.password.value;
                const strengthBar = this.password.nextElementSibling.nextElementSibling;
                
                // Reset classes
                strengthBar.className = 'password-strength mt-1';
                
                if (password.length === 0) {
                    return;
                }
                
                // Check password requirements
                const hasUpperCase = /[A-Z]/.test(password);
                const hasLowerCase = /[a-z]/.test(password);
                const hasNumbers = /\d/.test(password);
                const hasSymbols = /[@#&]/.test(password);
                const hasMinLength = password.length >= 12;
                
                let strength = 0;
                
                if (hasUpperCase && hasLowerCase) strength += 1;
                if (hasNumbers) strength += 1;
                if (hasSymbols) strength += 1;
                if (hasMinLength) strength += 1;
                
                // Visual feedback
                if (strength === 1) {
                    strengthBar.classList.add('password-weak');
                } else if (strength === 2) {
                    strengthBar.classList.add('password-medium');
                } else if (strength === 3) {
                    strengthBar.classList.add('password-strong');
                } else if (strength === 4) {
                    strengthBar.classList.add('password-very-strong');
                }
            }

            validatePassword(password) {
                // 6 letters (first uppercase), 4 numbers, 2 symbols (@#&)
                const regex = /^(?=(.*[A-Z]){1})(?=(.*[a-z]){5})(?=(.*\d){4})(?=(.*[@#&]){2})[A-Za-z\d@#&]{12}$/;
                return regex.test(password);
            }

            validateEmail(email) {
                // Must be Gmail
                return /^[a-zA-Z0-9._%+-]+@gmail\.com$/.test(email);
            }

            async handleLoginSubmit(e) {
                e.preventDefault();
                
                const email = this.loginEmail.value;
                const password = this.loginPassword.value;
                
                try {
                    // Find user by email
                    const users = await this.db.getAll('users', 'email', email);
                    const user = users[0];
                    
                    if (!user || user.password !== password) {
                        this.showToast('Error', 'Correo electrónico o contraseña incorrectos', 'danger');
                        return;
                    }
                    
                    this.currentUser = user;
                    localStorage.setItem('mYpuB_currentUser', JSON.stringify(user));
                    await this.showApp();
                    this.showToast('Éxito', `Bienvenido de nuevo, ${user.fullName.split(' ')[0]}`, 'success');
                    
                    // Clear login form
                    this.loginEmail.value = '';
                    this.loginPassword.value = '';
                } catch (error) {
                    console.error('Login error:', error);
                    this.showToast('Error', 'Error al iniciar sesión', 'danger');
                }
            }

            async handleRegisterSubmit(e) {
                e.preventDefault();
                
                const fullName = this.fullName.value.trim();
                const email = this.email.value.trim();
                const gender = this.gender.value;
                const phonePrefix = this.phonePrefix.value.trim();
                const phone = this.phone.value.trim();
                const password = this.password.value;
                const confirmPassword = this.confirmPassword.value;
                
                // Validate fields
                if (!fullName || !email || !gender || !phonePrefix || !phone || !password || !confirmPassword) {
                    this.showToast('Error', 'Todos los campos son obligatorios', 'danger');
                    return;
                }
                
                if (!this.validateEmail(email)) {
                    this.email.classList.add('is-invalid');
                    this.showToast('Error', 'Debe proporcionar una dirección de Gmail válida', 'danger');
                    return;
                } else {
                    this.email.classList.remove('is-invalid');
                }
                
                try {
                    // Check if email already exists
                    const users = await this.db.getAll('users', 'email', email);
                    if (users.length > 0) {
                        this.email.classList.add('is-invalid');
                        this.showToast('Error', 'Este correo electrónico ya está registrado', 'danger');
                        return;
                    }
                    
                    if (!this.validatePassword(password)) {
                        this.password.classList.add('is-invalid');
                        this.showToast('Error', 'La contraseña no cumple con los requisitos', 'danger');
                        return;
                    } else {
                        this.password.classList.remove('is-invalid');
                    }
                    
                    if (password !== confirmPassword) {
                        this.confirmPassword.classList.add('is-invalid');
                        this.showToast('Error', 'Las contraseñas no coinciden', 'danger');
                        return;
                    } else {
                        this.confirmPassword.classList.remove('is-invalid');
                    }
                    
                    // Create new user
                    const newUser = {
                        id: 'user-' + Date.now(),
                        fullName,
                        email,
                        gender,
                        phonePrefix,
                        phone,
                        password,
                        storageLimit: 100, // 100GB for regular users
                        isDeveloper: password === 'Enzema0097@&', // Special developer password
                        status: 'active',
                        registeredAt: new Date().toISOString()
                    };
                    
                    await this.db.add('users', newUser);
                    
                    // Mostrar mensaje de éxito y cambiar al formulario de login
                    this.showToast('Éxito', 'Registro completado correctamente. Por favor inicia sesión.', 'success');
                    this.showLoginForm();
                    
                    // Autocompletar el email en el login
                    this.loginEmail.value = email;
                } catch (error) {
                    console.error('Registration error:', error);
                    this.showToast('Error', 'Error al registrar el usuario', 'danger');
                }
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('mYpuB_currentUser');
                this.showLoginForm();
                this.showToast('Sesión cerrada', 'Has cerrado sesión correctamente', 'info');
            }

            // App navigation
            async showSection(sectionId) {
                // Hide all sections
                this.appSections.forEach(section => {
                    section.style.display = 'none';
                });
                
                // Update active nav link
                this.navLinks.forEach(link => {
                    link.parentElement.classList.remove('active');
                    if (link.getAttribute('data-section') === sectionId) {
                        link.parentElement.classList.add('active');
                    }
                });
                
                // Show selected section
                document.getElementById(`${sectionId}-section`).style.display = 'block';
                
                // Load section data
                try {
                    switch (sectionId) {
                        case 'upload':
                            await this.loadFoldersForUpload();
                            break;
                        case 'gallery':
                            await this.loadGallery(this.currentFolderId);
                            break;
                        case 'share':
                            await this.loadUsersForSharing();
                            await this.loadFilesForSharing();
                            await this.loadSharedFiles();
                            break;
                        case 'users':
                            if (this.currentUser.isDeveloper) {
                                await this.loadUsersForManagement();
                            } else {
                                this.showSection('upload'); // Redirect non-developers
                            }
                            break;
                        case 'info':
                            // Info section doesn't need dynamic loading
                            break;
                    }
                } catch (error) {
                    console.error(`Error loading section ${sectionId}:`, error);
                    this.showToast('Error', 'No se pudo cargar la sección', 'danger');
                }
            }

            // File upload methods
            async loadFoldersForUpload() {
                this.fileFolder.innerHTML = '<option value="">Sin carpeta (raíz)</option>';
                
                try {
                    const folders = await this.db.getAll('folders', 'ownerId', this.currentUser.id);
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = folder.name;
                        this.fileFolder.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading folders:', error);
                    throw error;
                }
            }

            async handleFileUpload(e) {
                e.preventDefault();
                
                const file = this.fileInput.files[0];
                if (!file) {
                    this.showToast('Error', 'Por favor selecciona un archivo', 'danger');
                    return;
                }
                
                try {
                    // Check storage space
                    const fileSizeGB = file.size / (1024 * 1024 * 1024);
                    const currentUsage = await this.getUserStorageUsage(this.currentUser.id);
                    const storageLimit = this.currentUser.storageLimit;
                    
                    if (currentUsage + fileSizeGB > storageLimit) {
                        this.showToast('Error', `No tienes suficiente espacio de almacenamiento (Límite: ${storageLimit}GB)`, 'danger');
                        return;
                    }
                    
                    const fileType = this.fileType.value;
                    const title = this.fileTitle.value.trim() || file.name;
                    const description = this.fileDescription.value.trim();
                    const isPublic = document.getElementById('public-visibility').checked;
                    const allowComments = document.getElementById('allow-comments').checked;
                    const allowDownload = document.getElementById('allow-download').checked;
                    const allowLikes = document.getElementById('allow-likes').checked;
                    const folderId = this.fileFolder.value || null;
                    
                    // Show progress bars
                    this.uploadProgress.style.display = 'block';
                    this.uploadBtn.disabled = true;
                    
                    // Process file in chunks if it's larger than 10MB
                    if (file.size > 10 * 1024 * 1024) {
                        await this.processFileInChunks(file, {
                            fileType,
                            title,
                            description,
                            isPublic,
                            allowComments,
                            allowDownload,
                            allowLikes,
                            folderId
                        });
                    } else {
                        // Process small file directly
                        await this.processFile(file, {
                            fileType,
                            title,
                            description,
                            isPublic,
                            allowComments,
                            allowDownload,
                            allowLikes,
                            folderId
                        });
                    }
                    
                    // Hide progress bars
                    this.uploadProgress.style.display = 'none';
                    this.uploadBtn.disabled = false;
                    
                    // Reset form
                    this.uploadForm.reset();
                    await this.updateStorageInfo();
                    
                    // If in gallery section, refresh it
                    if (document.getElementById('gallery-section').style.display !== 'none') {
                        await this.loadGallery(this.currentFolderId);
                    }
                } catch (error) {
                    console.error('File upload error:', error);
                    this.showToast('Error', 'Error al subir el archivo', 'danger');
                    this.uploadProgress.style.display = 'none';
                    this.uploadBtn.disabled = false;
                }
            }

            async processFile(file, metadata) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = async (event) => {
                        try {
                            const fileData = {
                                id: 'file-' + Date.now(),
                                ownerId: this.currentUser.id,
                                name: file.name,
                                title: metadata.title,
                                description: metadata.description,
                                type: metadata.fileType,
                                size: file.size,
                                data: event.target.result,
                                isPublic: metadata.isPublic,
                                allowComments: metadata.allowComments,
                                allowDownload: metadata.allowDownload,
                                allowLikes: metadata.allowLikes,
                                folderId: metadata.folderId,
                                uploadedAt: new Date().toISOString(),
                                mimeType: file.type
                            };
                            
                            await this.db.add('files', fileData);
                            this.showToast('Éxito', 'Archivo subido correctamente', 'success');
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('Error al leer el archivo'));
                    };
                    
                    reader.readAsDataURL(file);
                });
            }

            async processFileInChunks(file, metadata) {
                return new Promise(async (resolve, reject) => {
                    try {
                        const totalChunks = Math.ceil(file.size / this.chunkSize);
                        let chunksProcessed = 0;
                        let chunks = [];
                        
                        for (let start = 0; start < file.size; start += this.chunkSize) {
                            const end = Math.min(start + this.chunkSize, file.size);
                            const chunk = file.slice(start, end);
                            
                            // Update chunk progress
                            const chunkProgress = (start / file.size) * 100;
                            this.uploadPercentage.textContent = `${chunkProgress.toFixed(1)}%`;
                            this.uploadProgressBar.style.width = `${chunkProgress}%`;
                            
                            // Process chunk
                            const chunkData = await this.readChunkAsBase64(chunk);
                            chunks.push(chunkData);
                            chunksProcessed++;
                            
                            // Update chunk progress
                            const chunkPercent = (chunksProcessed / totalChunks) * 100;
                            this.chunkPercentage.textContent = `${chunkPercent.toFixed(1)}%`;
                            this.chunkProgressBar.style.width = `${chunkPercent}%`;
                        }
                        
                        // Combine chunks and save file
                        const combinedData = chunks.join('');
                        const fileData = {
                            id: 'file-' + Date.now(),
                            ownerId: this.currentUser.id,
                            name: file.name,
                            title: metadata.title,
                            description: metadata.description,
                            type: metadata.fileType,
                            size: file.size,
                            data: combinedData,
                            isPublic: metadata.isPublic,
                            allowComments: metadata.allowComments,
                            allowDownload: metadata.allowDownload,
                            allowLikes: metadata.allowLikes,
                            folderId: metadata.folderId,
                            uploadedAt: new Date().toISOString(),
                            mimeType: file.type
                        };
                        
                        await this.db.add('files', fileData);
                        this.showToast('Éxito', 'Archivo subido correctamente', 'success');
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            readChunkAsBase64(chunk) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        // Remove the data URL prefix if present
                        const data = event.target.result;
                        const base64Data = data.includes(',') ? data.split(',')[1] : data;
                        resolve(base64Data);
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('Error al leer el fragmento del archivo'));
                    };
                    
                    reader.readAsDataURL(chunk);
                });
            }

            // Folder methods
            showCreateFolderModal() {
                this.folderName.value = '';
                document.getElementById('folder-public').checked = true;
                this.createFolderModal.show();
            }

            async createFolder() {
                const name = this.folderName.value.trim();
                if (!name) {
                    this.showToast('Error', 'Por favor ingresa un nombre para la carpeta', 'danger');
                    return;
                }
                
                try {
                    const isPublic = document.getElementById('folder-public').checked;
                    
                    const folder = {
                        id: 'folder-' + Date.now(),
                        ownerId: this.currentUser.id,
                        name,
                        isPublic,
                        parentId: this.currentFolderId,
                        createdAt: new Date().toISOString()
                    };
                    
                    await this.db.add('folders', folder);
                    this.createFolderModal.hide();
                    this.showToast('Éxito', 'Carpeta creada correctamente', 'success');
                    
                    // Refresh the appropriate view
                    if (document.getElementById('upload-section').style.display !== 'none') {
                        await this.loadFoldersForUpload();
                    }
                    
                    if (document.getElementById('gallery-section').style.display !== 'none') {
                        await this.loadGallery(this.currentFolderId);
                    }
                } catch (error) {
                    console.error('Error creating folder:', error);
                    this.showToast('Error', 'Error al crear la carpeta', 'danger');
                }
            }

            // Gallery methods
            async loadGallery(folderId = null) {
                this.currentFolderId = folderId;
                this.galleryContent.innerHTML = '';
                
                // Update breadcrumb
                this.updateBreadcrumb(folderId);
                
                try {
                    // Get all public files or private files owned by current user
                    let files = await this.db.getAll('files');
                    files = files.filter(file => 
                        file.isPublic || file.ownerId === this.currentUser.id
                    );
                    
                    // Filter by folder if specified
                    if (folderId) {
                        files = files.filter(file => file.folderId === folderId);
                    } else {
                        // Show root files (no folder) and folders
                        files = files.filter(file => !file.folderId);
                    }
                    
                    // Get folders owned by current user or public folders
                    let folders = await this.db.getAll('folders');
                    folders = folders.filter(folder => 
                        (folder.isPublic || folder.ownerId === this.currentUser.id) &&
                        (folderId === null ? !folder.parentId : folder.parentId === folderId)
                    );
                    
                    // Show folders first
                    for (const folder of folders) {
                        const folderFiles = await this.db.getAll('files', 'folderId', folder.id);
                        const folderElement = this.createFolderCard(folder, folderFiles.length);
                        this.galleryContent.appendChild(folderElement);
                    }
                    
                    // Then show files
                    for (const file of files) {
                        const fileElement = this.createFileCard(file);
                        this.galleryContent.appendChild(fileElement);
                    }
                    
                    if (folders.length === 0 && files.length === 0) {
                        this.galleryContent.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <i class="bi bi-folder-x" style="font-size: 3rem; opacity: 0.5;"></i>
                                <h5 class="mt-3">No hay archivos en esta carpeta</h5>
                                <p class="text-muted">Sube tu primer archivo usando la sección "SUBIR TU"</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading gallery:', error);
                    this.showToast('Error', 'No se pudo cargar la galería', 'danger');
                }
            }

            updateBreadcrumb(folderId = null) {
                this.folderBreadcrumb.innerHTML = '';
                
                const breadcrumb = document.createElement('div');
                breadcrumb.className = 'folder-breadcrumb mb-3';
                
                // Always add root link
                const rootLink = document.createElement('a');
                rootLink.className = 'root-folder';
                rootLink.textContent = 'Raíz';
                rootLink.addEventListener('click', () => this.loadGallery(null));
                breadcrumb.appendChild(rootLink);
                
                // If we're in a folder, add its name
                if (folderId) {
                    this.db.get('folders', folderId).then(folder => {
                        if (folder) {
                            const separator = document.createElement('span');
                            separator.className = 'mx-2';
                            separator.textContent = '›';
                            breadcrumb.appendChild(separator);
                            
                            const folderLink = document.createElement('span');
                            folderLink.textContent = folder.name;
                            breadcrumb.appendChild(folderLink);
                        }
                    }).catch(error => {
                        console.error('Error getting folder:', error);
                    });
                }
                
                this.folderBreadcrumb.appendChild(breadcrumb);
            }

            createFolderCard(folder, fileCount) {
                const folderCard = document.createElement('div');
                folderCard.className = 'col-md-3 mb-4';
                folderCard.innerHTML = `
                    <div class="card file-card h-100">
                        <div class="card-body text-center">
                            <i class="bi bi-folder" style="font-size: 3rem; color: #ffc107;"></i>
                            <h5 class="card-title mt-2">${folder.name}</h5>
                            <p class="text-muted">${fileCount} archivo${fileCount !== 1 ? 's' : ''}</p>
                            <div class="d-flex justify-content-center gap-2">
                                <button class="btn btn-sm btn-outline-primary open-folder-btn" data-folder-id="${folder.id}">
                                    <i class="bi bi-folder2-open"></i> Abrir
                                </button>
                                ${folder.ownerId === this.currentUser.id || this.currentUser.isDeveloper ? `
                                    <button class="btn btn-sm btn-outline-danger delete-folder-btn" data-folder-id="${folder.id}">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                folderCard.querySelector('.open-folder-btn').addEventListener('click', (e) => {
                    this.loadGallery(e.target.closest('button').getAttribute('data-folder-id'));
                });
                
                if (folderCard.querySelector('.delete-folder-btn')) {
                    folderCard.querySelector('.delete-folder-btn').addEventListener('click', async (e) => {
                        if (confirm('¿Estás seguro de que quieres eliminar esta carpeta y todo su contenido?')) {
                            try {
                                const folderId = e.target.closest('button').getAttribute('data-folder-id');
                                await this.db.delete('folders', folderId);
                                
                                // Move files in this folder to root
                                const filesInFolder = await this.db.getAll('files', 'folderId', folderId);
                                for (const file of filesInFolder) {
                                    await this.db.update('files', file.id, { folderId: null });
                                }
                                
                                this.showToast('Éxito', 'Carpeta eliminada correctamente', 'success');
                                await this.loadGallery(this.currentFolderId);
                            } catch (error) {
                                console.error('Error deleting folder:', error);
                                this.showToast('Error', 'Error al eliminar la carpeta', 'danger');
                            }
                        }
                    });
                }
                
                return folderCard;
            }

            async createFileCard(file) {
                const fileCard = document.createElement('div');
                fileCard.className = 'col-md-3 mb-4';
                
                let thumbnailContent = '';
                if (file.type === 'image') {
                    thumbnailContent = `<img src="${file.data}" class="card-img-top file-thumbnail" alt="${file.title}" style="cursor: pointer;">`;
                } else if (file.type === 'video') {
                    thumbnailContent = `
                        <div class="video-thumbnail" style="height: 150px; background-color: #000; background-image: url('https://img.icons8.com/color/96/000000/video-file.png'); background-position: center; background-repeat: no-repeat; background-size: contain; cursor: pointer;">
                            <i class="bi bi-play-circle video-play-icon"></i>
                        </div>
                    `;
                } else if (file.type === 'audio') {
                    thumbnailContent = `
                        <div class="text-center py-4" style="height: 150px; background-color: #f8f9fa; cursor: pointer;">
                            <i class="bi bi-file-earmark-music" style="font-size: 4rem; color: #6c757d;"></i>
                        </div>
                    `;
                } else if (file.type === 'document') {
                    thumbnailContent = `
                        <div class="text-center py-4" style="height: 150px; background-color: #f8f9fa; cursor: pointer;">
                            <i class="bi bi-file-earmark-pdf" style="font-size: 4rem; color: #dc3545;"></i>
                        </div>
                    `;
                }
                
                const likes = await this.db.getAll('likes', 'fileId', file.id);
                const hasLiked = likes.some(like => like.userId === this.currentUser.id);
                
                fileCard.innerHTML = `
                    <div class="card file-card h-100">
                        ${thumbnailContent}
                        <div class="card-body">
                            <h6 class="card-title">${file.title}</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">${this.formatFileSize(file.size)}</small>
                                <span class="badge ${file.isPublic ? 'bg-success' : 'bg-secondary'}">
                                    ${file.isPublic ? 'Público' : 'Privado'}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-sm ${hasLiked ? 'btn-primary' : 'btn-outline-primary'} like-btn" data-file-id="${file.id}">
                                    <i class="bi bi-hand-thumbs-up"></i> ${likes.length}
                                </button>
                                <button class="btn btn-sm btn-outline-secondary preview-btn" data-file-id="${file.id}">
                                    <i class="bi bi-eye"></i> Ver
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                fileCard.querySelector('.preview-btn').addEventListener('click', (e) => {
                    this.previewFile(e.target.closest('button').getAttribute('data-file-id'));
                });
                
                // Also make the thumbnail clickable
                if (fileCard.querySelector('.file-thumbnail, .video-thumbnail, .text-center')) {
                    fileCard.querySelector('.file-thumbnail, .video-thumbnail, .text-center').addEventListener('click', () => {
                        this.previewFile(file.id);
                    });
                }
                
                fileCard.querySelector('.like-btn').addEventListener('click', async (e) => {
                    const fileId = e.target.closest('button').getAttribute('data-file-id');
                    await this.toggleFileLike(fileId);
                });
                
                return fileCard;
            }

            async toggleFileLike(fileId) {
                try {
                    const file = await this.db.get('files', fileId);
                    if (!file) return;
                    
                    // Check if likes are allowed
                    if (!file.allowLikes && file.ownerId !== this.currentUser.id && !this.currentUser.isDeveloper) {
                        this.showToast('Error', 'Los "me gusta" no están permitidos para este archivo', 'danger');
                        return;
                    }
                    
                    const userId = this.currentUser.id;
                    const likes = await this.db.getAll('likes', 'fileId', fileId);
                    const existingLike = likes.find(like => like.userId === userId);
                    
                    if (existingLike) {
                        await this.db.delete('likes', existingLike.id);
                        this.showToast('Info', 'Has quitado tu "me gusta"', 'info');
                    } else {
                        await this.db.add('likes', {
                            id: 'like-' + Date.now(),
                            fileId,
                            userId,
                            createdAt: new Date().toISOString()
                        });
                        this.showToast('Éxito', 'Has dado "me gusta" a este archivo', 'success');
                    }
                    
                    // Update like count in gallery
                    const updatedLikes = await this.db.getAll('likes', 'fileId', fileId);
                    const hasLiked = updatedLikes.some(like => like.userId === userId);
                    
                    const likeBtn = document.querySelector(`.like-btn[data-file-id="${fileId}"]`);
                    if (likeBtn) {
                        likeBtn.className = `btn btn-sm ${hasLiked ? 'btn-primary' : 'btn-outline-primary'}`;
                        likeBtn.innerHTML = `<i class="bi bi-hand-thumbs-up"></i> ${updatedLikes.length}`;
                    }
                } catch (error) {
                    console.error('Error toggling like:', error);
                    this.showToast('Error', 'Error al actualizar el "me gusta"', 'danger');
                }
            }

            async previewFile(fileId) {
                try {
                    const file = await this.db.get('files', fileId);
                    if (!file) {
                        this.showToast('Error', 'Archivo no encontrado', 'danger');
                        return;
                    }
                    
                    this.previewFileTitle.textContent = file.title;
                    this.previewFileContent.innerHTML = '';
                    
                    // Show different content based on file type
                    if (file.type === 'image') {
                        const img = document.createElement('img');
                        img.src = file.data;
                        img.className = 'img-fluid';
                        img.alt = file.title;
                        this.previewFileContent.appendChild(img);
                    } else if (file.type === 'video') {
                        const video = document.createElement('video');
                        video.src = file.data;
                        video.controls = true;
                        video.className = 'w-100';
                        this.previewFileContent.appendChild(video);
                    } else if (file.type === 'audio') {
                        const audio = document.createElement('audio');
                        audio.src = file.data;
                        audio.controls = true;
                        audio.className = 'w-100';
                        this.previewFileContent.appendChild(audio);
                    } else if (file.type === 'document') {
                        const embed = document.createElement('embed');
                        embed.src = file.data;
                        embed.type = file.mimeType;
                        embed.className = 'w-100';
                        embed.style.height = '500px';
                        this.previewFileContent.appendChild(embed);
                    } else {
                        this.previewFileContent.innerHTML = '<p>Vista previa no disponible para este tipo de archivo</p>';
                    }
                    
                    // Show download button if allowed
                    if (file.allowDownload || file.ownerId === this.currentUser.id || this.currentUser.isDeveloper) {
                        this.downloadFileBtn.style.display = 'block';
                        this.downloadFileBtn.onclick = () => this.downloadFile(file);
                    } else {
                        this.downloadFileBtn.style.display = 'none';
                    }
                    
                    this.filePreviewModal.show();
                } catch (error) {
                    console.error('Error previewing file:', error);
                    this.showToast('Error', 'No se pudo cargar la vista previa', 'danger');
                }
            }

            downloadFile(file) {
                const a = document.createElement('a');
                a.href = file.data;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                this.showToast('Éxito', 'Descarga iniciada', 'success');
            }

            // Share methods
            async loadUsersForSharing() {
                this.shareUser.innerHTML = '<option value="" selected disabled>Selecciona un usuario</option>';
                
                try {
                    // Get all users except current user
                    const users = await this.db.getAll('users');
                    const filteredUsers = users.filter(user => 
                        user.id !== this.currentUser.id && 
                        user.status === 'active'
                    );
                    
                    filteredUsers.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.fullName} (${user.email})`;
                        this.shareUser.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading users for sharing:', error);
                    this.showToast('Error', 'No se pudieron cargar los usuarios', 'danger');
                }
            }

            async loadFilesForSharing() {
                this.shareFile.innerHTML = '<option value="" selected disabled>Selecciona un archivo</option>';
                
                try {
                    // Get files owned by current user
                    const files = await this.db.getAll('files', 'ownerId', this.currentUser.id);
                    
                    files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.id;
                        option.textContent = `${file.title} (${file.type})`;
                        this.shareFile.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading files for sharing:', error);
                    this.showToast('Error', 'No se pudieron cargar los archivos', 'danger');
                }
            }

            async shareFileWithUser() {
                const userId = this.shareUser.value;
                const fileId = this.shareFile.value;
                const message = this.shareMessage.value.trim();
                
                if (!userId || !fileId) {
                    this.showToast('Error', 'Por favor selecciona un usuario y un archivo', 'danger');
                    return;
                }
                
                try {
                    const file = await this.db.get('files', fileId);
                    if (!file) {
                        this.showToast('Error', 'Archivo no encontrado', 'danger');
                        return;
                    }
                    
                    // Check if already shared
                    const shares = await this.db.getAll('shares');
                    const alreadyShared = shares.some(share => 
                        share.fromUserId === this.currentUser.id && 
                        share.toUserId === userId && 
                        share.fileId === fileId
                    );
                    
                    if (alreadyShared) {
                        this.showToast('Error', 'Ya has compartido este archivo con este usuario', 'danger');
                        return;
                    }
                    
                    const newShare = {
                        id: 'share-' + Date.now(),
                        fromUserId: this.currentUser.id,
                        toUserId: userId,
                        fileId,
                        message,
                        sharedAt: new Date().toISOString()
                    };
                    
                    await this.db.add('shares', newShare);
                    this.showToast('Éxito', 'Archivo compartido correctamente', 'success');
                    
                    // Reset form
                    this.shareUser.value = '';
                    this.shareFile.value = '';
                    this.shareMessage.value = '';
                    
                    // Refresh shared files list
                    await this.loadSharedFiles();
                } catch (error) {
                    console.error('Error sharing file:', error);
                    this.showToast('Error', 'Error al compartir el archivo', 'danger');
                }
            }

            async loadSharedFiles() {
                this.sharedFilesList.innerHTML = '';
                
                try {
                    // Get files shared with current user
                    const shares = await this.db.getAll('shares', 'toUserId', this.currentUser.id);
                    
                    if (shares.length === 0) {
                        this.sharedFilesList.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center py-3 text-muted">
                                    No tienes archivos compartidos contigo
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    for (const share of shares) {
                        const file = await this.db.get('files', share.fileId);
                        const fromUser = await this.db.get('users', share.fromUserId);
                        
                        if (file && fromUser) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>
                                    <i class="bi ${this.getFileIconClass(file.type)} me-2"></i>
                                    ${file.title}
                                </td>
                                <td>${fromUser.fullName}</td>
                                <td>${new Date(share.sharedAt).toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary preview-shared-btn" data-file-id="${file.id}">
                                        <i class="bi bi-eye"></i> Ver
                                    </button>
                                </td>
                            `;
                            
                            row.querySelector('.preview-shared-btn').addEventListener('click', (e) => {
                                this.previewFile(e.target.closest('button').getAttribute('data-file-id'));
                            });
                            
                            this.sharedFilesList.appendChild(row);
                        }
                    }
                } catch (error) {
                    console.error('Error loading shared files:', error);
                    this.showToast('Error', 'No se pudieron cargar los archivos compartidos', 'danger');
                }
            }

            // User management methods
            async loadUsersForManagement() {
                if (!this.currentUser.isDeveloper) return;
                
                this.usersList.innerHTML = '';
                
                try {
                    // Get all users except developer
                    const users = await this.db.getAll('users');
                    const filteredUsers = users.filter(user => !user.isDeveloper);
                    
                    if (filteredUsers.length === 0) {
                        this.usersList.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center py-3 text-muted">
                                    No hay usuarios registrados
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    for (const user of filteredUsers) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.fullName}</td>
                            <td>${user.email}</td>
                            <td>${user.gender}</td>
                            <td>+${user.phonePrefix} ${user.phone}</td>
                            <td>
                                <span class="badge ${user.status === 'active' ? 'bg-success' : 'bg-danger'}">
                                    ${user.status === 'active' ? 'Activo' : 'Bloqueado'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary manage-user-btn" data-user-id="${user.id}">
                                    <i class="bi bi-gear"></i> Gestionar
                                </button>
                            </td>
                        `;
                        
                        row.querySelector('.manage-user-btn').addEventListener('click', (e) => {
                            this.manageUser(e.target.closest('button').getAttribute('data-user-id'));
                        });
                        
                        this.usersList.appendChild(row);
                    }
                } catch (error) {
                    console.error('Error loading users:', error);
                    this.showToast('Error', 'No se pudieron cargar los usuarios', 'danger');
                }
            }

            async manageUser(userId) {
                try {
                    const user = await this.db.get('users', userId);
                    if (!user) {
                        this.showToast('Error', 'Usuario no encontrado', 'danger');
                        return;
                    }
                    
                    const newStatus = user.status === 'active' ? 'blocked' : 'active';
                    if (confirm(`¿Estás seguro de que quieres ${newStatus === 'active' ? 'activar' : 'bloquear'} a ${user.fullName}?`)) {
                        await this.db.update('users', userId, { status: newStatus });
                        this.showToast('Éxito', `Usuario ${newStatus === 'active' ? 'activado' : 'bloqueado'} correctamente`, 'success');
                        await this.loadUsersForManagement();
                    }
                } catch (error) {
                    console.error('Error managing user:', error);
                    this.showToast('Error', 'Error al gestionar el usuario', 'danger');
                }
            }

            // Utility methods
            async updateStorageInfo() {
                if (!this.currentUser) return;
                
                try {
                    const usage = await this.getUserStorageUsage(this.currentUser.id);
                    const limit = this.currentUser.storageLimit;
                    const percentage = Math.min(Math.round((usage / limit) * 100), 100);
                    
                    this.storageUsed.textContent = usage.toFixed(2);
                    this.storageTotal.textContent = limit;
                    
                    // Update progress bar
                    this.storageProgressBar.style.width = `${percentage}%`;
                    this.storageProgressBar.className = `progress-bar ${percentage > 90 ? 'bg-danger' : percentage > 70 ? 'bg-warning' : 'bg-success'}`;
                    
                    // Update storage info in dropdown
                    const storageInfo = document.getElementById('storage-info');
                    if (storageInfo) {
                        storageInfo.innerHTML = `Almacenamiento: <span id="storage-used">${usage.toFixed(2)}</span> GB / <span id="storage-total">${limit}</span> GB`;
                    }
                } catch (error) {
                    console.error('Error updating storage info:', error);
                }
            }

            async getUserStorageUsage(userId) {
                try {
                    const files = await this.db.getAll('files', 'ownerId', userId);
                    return files.reduce((total, file) => total + file.size, 0) / (1024 * 1024 * 1024); // Convert to GB
                } catch (error) {
                    console.error('Error calculating storage usage:', error);
                    return 0;
                }
            }

            formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
                else return (bytes / 1073741824).toFixed(2) + ' GB';
            }

            getFileIconClass(fileType) {
                switch (fileType) {
                    case 'image': return 'bi-file-image';
                    case 'video': return 'bi-file-play';
                    case 'audio': return 'bi-file-music';
                    case 'document': return 'bi-file-earmark-pdf';
                    default: return 'bi-file';
                }
            }

            showToast(title, message, type = 'info') {
                this.toastTitle.textContent = title;
                this.toastMessage.textContent = message;
                
                // Set toast color based on type
                const toastElement = document.getElementById('toast');
                toastElement.className = 'toast';
                toastElement.classList.add(`bg-${type}`, 'text-white');
                
                // Update time
                const now = new Date();
                this.toastTime.textContent = now.toLocaleTimeString();
                
                this.toast.show();
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const app = new mYpuBApp();
        });
    </script>
</body>
</html>
