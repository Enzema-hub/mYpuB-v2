<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mYpuB - Gestión de Archivos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .georgia-bold {
            font-family: Georgia, serif;
            font-weight: bold;
            color: black;
        }
        .file-card {
            transition: transform 0.2s;
        }
        .file-card:hover {
            transform: scale(1.03);
        }
        .sidebar {
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        .main-content {
            padding: 20px;
        }
        .file-preview {
            max-height: 200px;
            object-fit: contain;
        }
        .password-strength {
            height: 5px;
            margin-top: 5px;
        }
        .strength-0 {
            background-color: #dc3545;
            width: 20%;
        }
        .strength-1 {
            background-color: #fd7e14;
            width: 40%;
        }
        .strength-2 {
            background-color: #ffc107;
            width: 60%;
        }
        .strength-3 {
            background-color: #28a745;
            width: 80%;
        }
        .strength-4 {
            background-color: #20c997;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Pantalla de inicio -->
    <div id="welcome-screen" class="container-fluid d-flex flex-column justify-content-center align-items-center vh-100">
        <div class="card shadow-lg p-5 text-center" style="width: 100%; max-width: 600px;">
            <h1 class="georgia-bold mb-4">Bienvenido a <span class="georgia-bold">mYpuB</span></h1>
            <p class="mb-4">La plataforma para compartir y gestionar tus archivos multimedia</p>
            <div class="d-grid gap-3">
                <button id="login-btn" class="btn btn-primary btn-lg">Iniciar Sesión</button>
                <button id="register-btn" class="btn btn-outline-primary btn-lg">Registrarse</button>
            </div>
        </div>
    </div>

    <!-- Formulario de registro -->
    <div id="register-screen" class="container-fluid d-none flex-column justify-content-center align-items-center vh-100">
        <div class="card shadow-lg p-5" style="width: 100%; max-width: 600px;">
            <button id="back-from-register" class="btn btn-outline-secondary mb-3 align-self-start">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
            <h2 class="text-center mb-4">Regístrate en <span class="georgia-bold">mYpuB</span></h2>
            
            <form id="register-form">
                <div class="mb-3">
                    <label for="fullname" class="form-label">Nombre completo</label>
                    <input type="text" class="form-control" id="fullname" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Correo electrónico (Gmail)</label>
                    <input type="email" class="form-control" id="email" required>
                    <div class="invalid-feedback">Debe ser una dirección de Gmail válida</div>
                </div>
                <div class="mb-3">
                    <label for="gender" class="form-label">Sexo</label>
                    <select class="form-select" id="gender" required>
                        <option value="" selected disabled>Seleccione...</option>
                        <option value="Hombre">Hombre</option>
                        <option value="Mujer">Mujer</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="phone" class="form-label">Teléfono (con prefijo)</label>
                    <div class="input-group">
                        <span class="input-group-text">+</span>
                        <input type="tel" class="form-control" id="phone" required>
                    </div>
                    <div class="invalid-feedback">Ingrese un número de teléfono válido con prefijo</div>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="password" required>
                    <div class="password-strength" id="password-strength"></div>
                    <small class="form-text text-muted">
                        La contraseña debe tener 12 caracteres: 6 letras (primera mayúscula), 4 números y 2 símbolos (@#&)
                    </small>
                    <div class="invalid-feedback">La contraseña no cumple con los requisitos</div>
                </div>
                <div class="mb-3">
                    <label for="confirm-password" class="form-label">Confirmar contraseña</label>
                    <input type="password" class="form-control" id="confirm-password" required>
                    <div class="invalid-feedback">Las contraseñas no coinciden</div>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button type="submit" class="btn btn-primary">Registrarse</button>
                    <button type="button" id="help-btn" class="btn btn-outline-info">Ayuda</button>
                </div>
            </form>
            
            <div id="help-panel" class="card mt-3 d-none">
                <div class="card-body">
                    <h5 class="card-title">Ayuda y Soporte</h5>
                    <div class="d-grid gap-2">
                        <button id="email-help" class="btn btn-outline-primary">Enviar consulta por Email</button>
                        <button id="whatsapp-help" class="btn btn-outline-success">Enviar consulta por WhatsApp</button>
                    </div>
                </div>
            </div>
            
            <div id="email-help-form" class="card mt-3 d-none">
                <div class="card-body">
                    <h5 class="card-title">Consulta por Email</h5>
                    <div class="mb-3">
                        <label for="help-name" class="form-label">Nombre completo</label>
                        <input type="text" class="form-control" id="help-name">
                    </div>
                    <div class="mb-3">
                        <label for="help-email" class="form-label">Email para respuesta</label>
                        <input type="email" class="form-control" id="help-email">
                    </div>
                    <button id="send-email-help" class="btn btn-primary">Enviar al desarrollador</button>
                </div>
            </div>
            
            <div id="whatsapp-help-form" class="card mt-3 d-none">
                <div class="card-body">
                    <h5 class="card-title">Consulta por WhatsApp</h5>
                    <div class="mb-3">
                        <label for="whatsapp-name" class="form-label">Nombre completo</label>
                        <input type="text" class="form-control" id="whatsapp-name">
                    </div>
                    <div class="mb-3">
                        <label for="whatsapp-number" class="form-label">Número de WhatsApp</label>
                        <input type="tel" class="form-control" id="whatsapp-number">
                    </div>
                    <button id="send-whatsapp-help" class="btn btn-success">Enviar al desarrollador</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de login -->
    <div id="login-screen" class="container-fluid d-none flex-column justify-content-center align-items-center vh-100">
        <div class="card shadow-lg p-5" style="width: 100%; max-width: 500px;">
            <button id="back-from-login" class="btn btn-outline-secondary mb-3 align-self-start">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
            <h2 class="text-center mb-4">Inicie la sesión en <span class="georgia-bold">mYpuB</span></h2>
            
            <form id="login-form">
                <div class="mb-3">
                    <label for="login-email" class="form-label">Correo electrónico</label>
                    <input type="email" class="form-control" id="login-email" required>
                </div>
                <div class="mb-3">
                    <label for="login-password" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="login-password" required>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button type="submit" class="btn btn-primary">Iniciar Sesión</button>
                    <button type="button" id="login-help-btn" class="btn btn-outline-info">Ayuda</button>
                </div>
            </form>
            
            <div id="login-help-panel" class="card mt-3 d-none">
                <div class="card-body">
                    <h5 class="card-title">Ayuda y Soporte</h5>
                    <div class="d-grid gap-2">
                        <button id="login-email-help" class="btn btn-outline-primary">Enviar consulta por Email</button>
                        <button id="login-whatsapp-help" class="btn btn-outline-success">Enviar consulta por WhatsApp</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel principal -->
    <div id="main-app" class="container-fluid d-none">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="text-center mb-4">
                    <h3 class="georgia-bold">mYpuB</h3>
                    <p class="text-muted">Bienvenido, <span id="username-display"></span></p>
                </div>
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="upload-tab">
                            <i class="bi bi-upload me-2"></i> SUBIR TU
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="gallery-tab">
                            <i class="bi bi-images me-2"></i> GALERÍA
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="share-tab">
                            <i class="bi bi-share me-2"></i> COMPARTIR
                        </a>
                    </li>
                    <li class="nav-item d-none" id="users-management-item">
                        <a class="nav-link" href="#" id="users-tab">
                            <i class="bi bi-people me-2"></i> GESTIÓN DE USUARIOS
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="info-tab">
                            <i class="bi bi-info-circle me-2"></i> INFÓRMATE
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <a class="nav-link text-danger" href="#" id="logout-btn">
                            <i class="bi bi-box-arrow-right me-2"></i> Cerrar Sesión
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Upload Section -->
                <div id="upload-section">
                    <h3 class="mb-4"><i class="bi bi-upload me-2"></i> SUBIR ARCHIVOS</h3>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <form id="upload-form">
                                <div class="mb-3">
                                    <label for="file-type" class="form-label">Tipo de archivo</label>
                                    <select class="form-select" id="file-type" required>
                                        <option value="" selected disabled>Seleccione...</option>
                                        <option value="image">Imagen</option>
                                        <option value="video">Video</option>
                                        <option value="audio">Música (MP3)</option>
                                        <option value="document">Documento (PDF)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="file-upload" class="form-label">Seleccionar archivo</label>
                                    <input class="form-control" type="file" id="file-upload" required>
                                </div>
                                <div class="mb-3">
                                    <label for="file-title" class="form-label">Título</label>
                                    <input type="text" class="form-control" id="file-title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="file-description" class="form-label">Descripción</label>
                                    <textarea class="form-control" id="file-description" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Visibilidad</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="visibility" id="public-visibility" value="public" checked>
                                        <label class="form-check-label" for="public-visibility">
                                            Público (visible para todos los usuarios)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="visibility" id="private-visibility" value="private">
                                        <label class="form-check-label" for="private-visibility">
                                            Privado (solo visible para mí)
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="allow-comments">
                                    <label class="form-check-label" for="allow-comments">Permitir comentarios</label>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="allow-download" checked>
                                    <label class="form-check-label" for="allow-download">Permitir descarga</label>
                                </div>
                                <button type="submit" class="btn btn-primary">Subir Archivo</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Gallery Section -->
                <div id="gallery-section" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-images me-2"></i> GALERÍA</h3>
                        <button class="btn btn-outline-primary" id="create-folder-btn">
                            <i class="bi bi-folder-plus"></i> Crear Carpeta
                        </button>
                    </div>
                    
                    <div class="card mb-4 d-none" id="create-folder-card">
                        <div class="card-body">
                            <form id="folder-form">
                                <div class="mb-3">
                                    <label for="folder-name" class="form-label">Nombre de la carpeta</label>
                                    <input type="text" class="form-control" id="folder-name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Visibilidad</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="folder-visibility" id="folder-public" value="public" checked>
                                        <label class="form-check-label" for="folder-public">
                                            Pública (visible para todos los usuarios)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="folder-visibility" id="folder-private" value="private">
                                        <label class="form-check-label" for="folder-private">
                                            Privada (solo visible para mí)
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary me-2">Crear</button>
                                <button type="button" class="btn btn-outline-secondary" id="cancel-folder">Cancelar</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <ul class="nav nav-tabs" id="gallery-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" data-type="all">Todos</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-type="image">Imágenes</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-type="video">Videos</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-type="audio">Música</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-type="document">Documentos</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-type="my-files">Mis Archivos</a>
                            </li>
                        </ul>
                    </div>
                    
                    <div id="folders-container" class="row mb-4"></div>
                    
                    <div id="files-container" class="row"></div>
                </div>
                
                <!-- Share Section -->
                <div id="share-section" class="d-none">
                    <h3 class="mb-4"><i class="bi bi-share me-2"></i> COMPARTIR ARCHIVOS</h3>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <form id="share-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="share-user" class="form-label">Seleccionar usuario</label>
                                        <select class="form-select" id="share-user" required>
                                            <option value="" selected disabled>Seleccione un usuario...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="share-file" class="form-label">Seleccionar archivo</label>
                                        <select class="form-select" id="share-file" required>
                                            <option value="" selected disabled>Seleccione un archivo...</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Compartir Archivo</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Archivos compartidos conmigo</h5>
                            <div id="shared-files-container" class="row"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Users Management Section -->
                <div id="users-section" class="d-none">
                    <h3 class="mb-4"><i class="bi bi-people me-2"></i> GESTIÓN DE USUARIOS</h3>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Email</th>
                                            <th>Teléfono</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Info Section -->
                <div id="info-section" class="d-none">
                    <h3 class="mb-4"><i class="bi bi-info-circle me-2"></i> INFÓRMATE</h3>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Sobre <span class="georgia-bold">mYpuB</span></h5>
                            <p class="card-text">
                                <span class="georgia-bold">mYpuB</span> es una plataforma para compartir y gestionar archivos multimedia 
                                como imágenes, videos, música y documentos. Los usuarios pueden subir sus archivos, 
                                organizarlos en carpetas, compartirlos con otros usuarios y controlar la visibilidad 
                                de sus contenidos.
                            </p>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Cómo usar <span class="georgia-bold">mYpuB</span></h5>
                            <ol>
                                <li>Regístrate con tu cuenta de Gmail</li>
                                <li>Inicia sesión con tus credenciales</li>
                                <li>Sube archivos desde la sección "SUBIR TU"</li>
                                <li>Organiza tus archivos en carpetas desde "GALERÍA"</li>
                                <li>Comparte archivos con otros usuarios desde "COMPARTIR"</li>
                                <li>Gestiona la visibilidad y permisos de tus archivos</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Sobre el desarrollador</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item"><strong>Nombre completo:</strong> Tarciano ENZEMA NCHAMA</li>
                                <li class="list-group-item"><strong>Formación académica:</strong> Finalista universitario de la UNGE</li>
                                <li class="list-group-item"><strong>Facultad:</strong> Ciencias económicas gestión y administración</li>
                                <li class="list-group-item"><strong>Departamento:</strong> Informática de gestión empresarial</li>
                                <li class="list-group-item"><strong>Contacto:</strong> enzemajr@gmail.com</li>
                                <li class="list-group-item"><strong>Fecha final del desarrollo:</strong> 06/07/2025</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div class="modal fade" id="fileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="filePreviewContent"></div>
                    <p id="fileModalDescription" class="mt-3"></p>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span class="badge bg-secondary" id="fileModalVisibility"></span>
                            <span class="badge bg-info ms-2" id="fileModalType"></span>
                        </div>
                        <div>
                            <span class="me-3"><i class="bi bi-person"></i> <span id="fileModalOwner"></span></span>
                            <span><i class="bi bi-calendar"></i> <span id="fileModalDate"></span></span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" id="likeBtn">
                                <i class="bi bi-hand-thumbs-up"></i> <span id="likeCount">0</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="dislikeBtn">
                                <i class="bi bi-hand-thumbs-down"></i> <span id="dislikeCount">0</span>
                            </button>
                        </div>
                        <div id="fileActions">
                            <!-- Download button will appear here if allowed -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div id="commentsSection" class="w-100">
                        <h6>Comentarios</h6>
                        <div id="commentsList" class="mb-3"></div>
                        <form id="addCommentForm" class="d-none">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Añadir comentario..." id="commentText" required>
                                <button class="btn btn-primary" type="submit">Enviar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Editar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="user-form">
                        <input type="hidden" id="edit-user-id">
                        <div class="mb-3">
                            <label for="edit-fullname" class="form-label">Nombre completo</label>
                            <input type="text" class="form-control" id="edit-fullname" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-email" class="form-label">Correo electrónico</label>
                            <input type="email" class="form-control" id="edit-email" required readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-gender" class="form-label">Sexo</label>
                            <select class="form-select" id="edit-gender" required>
                                <option value="Hombre">Hombre</option>
                                <option value="Mujer">Mujer</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-phone" class="form-label">Teléfono</label>
                            <div class="input-group">
                                <span class="input-group-text">+</span>
                                <input type="tel" class="form-control" id="edit-phone" required>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="edit-isActive">
                            <label class="form-check-label" for="edit-isActive">Usuario activo</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-user-changes">Guardar Cambios</button>
                    <button type="button" class="btn btn-danger" id="delete-user-btn">Eliminar Usuario</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">Notificación</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Database setup
        const DB_NAME = 'mYpuB_DB';
        const DB_VERSION = 1;
        
        // Object store names
        const USER_STORE = 'users';
        const FILE_STORE = 'files';
        const FOLDER_STORE = 'folders';
        const SHARE_STORE = 'shared_files';
        const COMMENT_STORE = 'comments';
        const LIKE_STORE = 'likes';
        
        let db;
        let currentUser = null;
        let isDeveloper = false;
        
        // Initialize the database
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    console.error('Error opening database:', event.target.error);
                    reject('Error opening database');
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create users store
                    if (!db.objectStoreNames.contains(USER_STORE)) {
                        const userStore = db.createObjectStore(USER_STORE, { keyPath: 'email' });
                        userStore.createIndex('email', 'email', { unique: true });
                    }
                    
                    // Create files store
                    if (!db.objectStoreNames.contains(FILE_STORE)) {
                        const fileStore = db.createObjectStore(FILE_STORE, { keyPath: 'id', autoIncrement: true });
                        fileStore.createIndex('owner', 'owner', { unique: false });
                        fileStore.createIndex('type', 'type', { unique: false });
                        fileStore.createIndex('folderId', 'folderId', { unique: false });
                    }
                    
                    // Create folders store
                    if (!db.objectStoreNames.contains(FOLDER_STORE)) {
                        const folderStore = db.createObjectStore(FOLDER_STORE, { keyPath: 'id', autoIncrement: true });
                        folderStore.createIndex('owner', 'owner', { unique: false });
                    }
                    
                    // Create shared files store
                    if (!db.objectStoreNames.contains(SHARE_STORE)) {
                        const shareStore = db.createObjectStore(SHARE_STORE, { keyPath: 'id', autoIncrement: true });
                        shareStore.createIndex('fileId', 'fileId', { unique: false });
                        shareStore.createIndex('fromUser', 'fromUser', { unique: false });
                        shareStore.createIndex('toUser', 'toUser', { unique: false });
                    }
                    
                    // Create comments store
                    if (!db.objectStoreNames.contains(COMMENT_STORE)) {
                        const commentStore = db.createObjectStore(COMMENT_STORE, { keyPath: 'id', autoIncrement: true });
                        commentStore.createIndex('fileId', 'fileId', { unique: false });
                        commentStore.createIndex('userId', 'userId', { unique: false });
                    }
                    
                    // Create likes store
                    if (!db.objectStoreNames.contains(LIKE_STORE)) {
                        const likeStore = db.createObjectStore(LIKE_STORE, { keyPath: 'id', autoIncrement: true });
                        likeStore.createIndex('fileId', 'fileId', { unique: false });
                        likeStore.createIndex('userId', 'userId', { unique: false });
                        likeStore.createIndex('type', 'type', { unique: false }); // 'like' or 'dislike'
                    }
                };
            });
        }
        
        // Show toast notification
        function showToast(title, message, isError = false) {
            const toastEl = document.getElementById('toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            if (isError) {
                toastEl.classList.add('bg-danger', 'text-white');
            } else {
                toastEl.classList.remove('bg-danger', 'text-white');
            }
            
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
        
        // Validate Gmail
        function isValidGmail(email) {
            const regex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
            return regex.test(email);
        }
        
        // Validate password strength
        function validatePassword(password) {
            // 6 letters (first uppercase), 4 numbers, 2 symbols (@#&)
            const regex = /^(?=(.*[A-Z]){1})(?=(.*[a-z]){5})(?=(.*\d){4})(?=(.*[@#&]){2})[A-Za-z\d@#&]{12}$/;
            return regex.test(password);
        }
        
        // Check password strength visually
        function checkPasswordStrength(password) {
            const strengthBar = document.getElementById('password-strength');
            
            if (!password) {
                strengthBar.className = 'password-strength';
                return;
            }
            
            let strength = 0;
            
            // Check length
            if (password.length >= 8) strength++;
            
            // Check for uppercase letters
            if (/[A-Z]/.test(password)) strength++;
            
            // Check for numbers
            if (/\d/.test(password)) strength++;
            
            // Check for special characters
            if (/[@#&]/.test(password)) strength++;
            
            // Check if it meets our specific requirements
            if (validatePassword(password)) strength = 4;
            
            strengthBar.className = 'password-strength strength-' + strength;
        }
        
        // Validate phone with prefix
        function isValidPhone(phone) {
            return /^\d{1,4}\d{6,}$/.test(phone);
        }
        
        // Register a new user
        async function registerUser(userData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([USER_STORE], 'readwrite');
                const store = transaction.objectStore(USER_STORE);
                
                // Check if user already exists
                const request = store.get(userData.email);
                
                request.onerror = (event) => {
                    reject('Error checking user existence');
                };
                
                request.onsuccess = (event) => {
                    if (event.target.result) {
                        reject('El usuario con este email ya existe');
                    } else {
                        // Add new user
                        const addRequest = store.add(userData);
                        
                        addRequest.onerror = (event) => {
                            reject('Error al registrar usuario');
                        };
                        
                        addRequest.onsuccess = (event) => {
                            resolve(userData);
                        };
                    }
                };
            });
        }
        
        // Login user
        async function loginUser(email, password) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([USER_STORE], 'readonly');
                const store = transaction.objectStore(USER_STORE);
                
                const request = store.get(email);
                
                request.onerror = (event) => {
                    reject('Error al buscar usuario');
                };
                
                request.onsuccess = (event) => {
                    const user = event.target.result;
                    
                    if (!user) {
                        reject('Usuario no encontrado');
                    } else if (user.password !== password) {
                        reject('Contraseña incorrecta');
                    } else {
                        // Check if this is the developer
                        if (password === 'Enzema0097@&') {
                            isDeveloper = true;
                            document.getElementById('users-management-item').classList.remove('d-none');
                        }
                        
                        currentUser = user;
                        resolve(user);
                    }
                };
            });
        }
        
        // Get all users (for developer)
        async function getAllUsers() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([USER_STORE], 'readonly');
                const store = transaction.objectStore(USER_STORE);
                
                const request = store.getAll();
                
                request.onerror = (event) => {
                    reject('Error al obtener usuarios');
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
            });
        }
        
        // Update user
        async function updateUser(userData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([USER_STORE], 'readwrite');
                const store = transaction.objectStore(USER_STORE);
                
                const request = store.put(userData);
                
                request.onerror = (event) => {
                    reject('Error al actualizar usuario');
                };
                
                request.onsuccess = (event) => {
                    resolve(userData);
                };
            });
        }
        
        // Delete user
        async function deleteUser(email) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([USER_STORE], 'readwrite');
                const store = transaction.objectStore(USER_STORE);
                
                const request = store.delete(email);
                
                request.onerror = (event) => {
                    reject('Error al eliminar usuario');
                };
                
                request.onsuccess = (event) => {
                    resolve(true);
                };
            });
        }
        
        // Upload file
        async function uploadFile(fileData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([FILE_STORE], 'readwrite');
                const store = transaction.objectStore(FILE_STORE);
                
                const request = store.add(fileData);
                
                request.onerror = (event) => {
                    reject('Error al subir archivo');
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result); // Returns the ID of the new file
                };
            });
        }
        
        // Get files by type and visibility
        async function getFiles(type = 'all', onlyMine = false) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([FILE_STORE], 'readonly');
                const store = transaction.objectStore(FILE_STORE);
                
                let request;
                
                if (type === 'all' && !onlyMine) {
                    request = store.getAll();
                } else if (type === 'all' && onlyMine) {
                    const index = store.index('owner');
                    request = index.getAll(currentUser.email);
                } else if (onlyMine) {
                    const index = store.index('owner');
                    request = index.getAll(currentUser.email);
                } else {
                    const index = store.index('type');
                    request = index.getAll(type);
                }
                
                request.onerror = (event) => {
                    reject('Error al obtener archivos');
                };
                
                request.onsuccess = async (event) => {
                    let files = event.target.result;
                    
                    // Filter by visibility if not developer
                    if (!isDeveloper && !onlyMine) {
                        files = files.filter(file => {
                            return file.visibility === 'public' || file.owner === currentUser.email;
                        });
                    }
                    
                    // If we're getting all files and not only mine, we might need to filter by type
                    if (type !== 'all' && !onlyMine) {
                        files = files.filter(file => file.type === type);
                    }
                    
                    // Get likes and dislikes for each file
                    for (const file of files) {
                        file.likes = await getLikesCount(file.id, 'like');
                        file.dislikes = await getLikesCount(file.id, 'dislike');
                    }
                    
                    resolve(files);
                };
            });
        }
        
        // Get file by ID
        async function getFileById(fileId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([FILE_STORE], 'readonly');
                const store = transaction.objectStore(FILE_STORE);
                
                const request = store.get(fileId);
                
                request.onerror = (event) => {
                    reject('Error al obtener archivo');
                };
                
                request.onsuccess = async (event) => {
                    const file = event.target.result;
                    
                    if (file) {
                        // Get likes and dislikes
                        file.likes = await getLikesCount(file.id, 'like');
                        file.dislikes = await getLikesCount(file.id, 'dislike');
                    }
                    
                    resolve(file);
                };
            });
        }
        
        // Delete file
        async function deleteFile(fileId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([FILE_STORE], 'readwrite');
                const store = transaction.objectStore(FILE_STORE);
                
                const request = store.delete(fileId);
                
                request.onerror = (event) => {
                    reject('Error al eliminar archivo');
                };
                
                request.onsuccess = (event) => {
                    resolve(true);
                };
            });
        }
        
        // Create folder
        async function createFolder(folderData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([FOLDER_STORE], 'readwrite');
                const store = transaction.objectStore(FOLDER_STORE);
                
                const request = store.add(folderData);
                
                request.onerror = (event) => {
                    reject('Error al crear carpeta');
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result); // Returns the ID of the new folder
                };
            });
        }
        
        // Get folders
        async function getFolders(onlyMine = false) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([FOLDER_STORE], 'readonly');
                const store = transaction.objectStore(FOLDER_STORE);
                
                let request;
                
                if (onlyMine) {
                    const index = store.index('owner');
                    request = index.getAll(currentUser.email);
                } else {
                    request = store.getAll();
                }
                
                request.onerror = (event) => {
                    reject('Error al obtener carpetas');
                };
                
                request.onsuccess = (event) => {
                    let folders = event.target.result;
                    
                    // Filter by visibility if not developer
                    if (!isDeveloper && !onlyMine) {
                        folders = folders.filter(folder => {
                            return folder.visibility === 'public' || folder.owner === currentUser.email;
                        });
                    }
                    
                    resolve(folders);
                };
            });
        }
        
        // Share file with another user
        async function shareFile(shareData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([SHARE_STORE], 'readwrite');
                const store = transaction.objectStore(SHARE_STORE);
                
                const request = store.add(shareData);
                
                request.onerror = (event) => {
                    reject('Error al compartir archivo');
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result); // Returns the ID of the new share
                };
            });
        }
        
        // Get shared files for current user
        async function getSharedFiles() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([SHARE_STORE], 'readonly');
                const store = transaction.objectStore(SHARE_STORE);
                const index = store.index('toUser');
                
                const request = index.getAll(currentUser.email);
                
                request.onerror = (event) => {
                    reject('Error al obtener archivos compartidos');
                };
                
                request.onsuccess = async (event) => {
                    const shares = event.target.result;
                    const files = [];
                    
                    // Get each file details
                    for (const share of shares) {
                        const file = await getFileById(share.fileId);
                        if (file) {
                            file.sharedBy = share.fromUser;
                            files.push(file);
                        }
                    }
                    
                    resolve(files);
                };
            });
        }
        
        // Add comment to file
        async function addComment(commentData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([COMMENT_STORE], 'readwrite');
                const store = transaction.objectStore(COMMENT_STORE);
                
                const request = store.add(commentData);
                
                request.onerror = (event) => {
                    reject('Error al agregar comentario');
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result); // Returns the ID of the new comment
                };
            });
        }
        
        // Get comments for file
        async function getComments(fileId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([COMMENT_STORE], 'readonly');
                const store = transaction.objectStore(COMMENT_STORE);
                const index = store.index('fileId');
                
                const request = index.getAll(fileId);
                
                request.onerror = (event) => {
                    reject('Error al obtener comentarios');
                };
                
                request.onsuccess = async (event) => {
                    const comments = event.target.result;
                    
                    // Get user info for each comment
                    for (const comment of comments) {
                        const user = await getUserByEmail(comment.userId);
                        comment.userName = user ? user.fullname : 'Usuario desconocido';
                    }
                    
                    resolve(comments);
                };
            });
        }
        
        // Add like/dislike to file
        async function addLike(likeData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([LIKE_STORE], 'readwrite');
                const store = transaction.objectStore(LIKE_STORE);
                
                // First check if user already liked/disliked this file
                const index = store.index('fileId');
                const request = index.openCursor(IDBKeyRange.only(likeData.fileId));
                
                let existingLike = null;
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        if (cursor.value.userId === likeData.userId) {
                            existingLike = cursor.value;
                            return;
                        }
                        cursor.continue();
                    } else {
                        // No existing like found or checked all
                        if (existingLike) {
                            // Update existing like
                            if (existingLike.type === likeData.type) {
                                // Same type - remove the like/dislike
                                const deleteRequest = store.delete(existingLike.id);
                                
                                deleteRequest.onerror = (event) => {
                                    reject('Error al eliminar like existente');
                                };
                                
                                deleteRequest.onsuccess = (event) => {
                                    resolve({ action: 'removed', type: likeData.type });
                                };
                            } else {
                                // Different type - update to new type
                                existingLike.type = likeData.type;
                                const updateRequest = store.put(existingLike);
                                
                                updateRequest.onerror = (event) => {
                                    reject('Error al actualizar like existente');
                                };
                                
                                updateRequest.onsuccess = (event) => {
                                    resolve({ action: 'updated', oldType: existingLike.type, newType: likeData.type });
                                };
                            }
                        } else {
                            // Add new like
                            const addRequest = store.add(likeData);
                            
                            addRequest.onerror = (event) => {
                                reject('Error al agregar like');
                            };
                            
                            addRequest.onsuccess = (event) => {
                                resolve({ action: 'added', type: likeData.type });
                            };
                        }
                    }
                };
                
                request.onerror = (event) => {
                    reject('Error al verificar likes existentes');
                };
            });
        }
        
        // Get likes count for file
        async function getLikesCount(fileId, type) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([LIKE_STORE], 'readonly');
                const store = transaction.objectStore(LIKE_STORE);
                const index = store.index('fileId');
                
                const request = index.openCursor(IDBKeyRange.only(fileId));
                let count = 0;
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        if (cursor.value.type === type) {
                            count++;
                        }
                        cursor.continue();
                    } else {
                        resolve(count);
                    }
                };
                
                request.onerror = (event) => {
                    reject('Error al contar likes');
                };
            });
        }
        
        // Get user by email
        async function getUserByEmail(email) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([USER_STORE], 'readonly');
                const store = transaction.objectStore(USER_STORE);
                
                const request = store.get(email);
                
                request.onerror = (event) => {
                    reject('Error al buscar usuario');
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
            });
        }
        
        // Read file as base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // Display files in gallery
        async function displayFiles(files) {
            const container = document.getElementById('files-container');
            container.innerHTML = '';
            
            if (files.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5">No hay archivos para mostrar</div>';
                return;
            }
            
            for (const file of files) {
                const fileCard = document.createElement('div');
                fileCard.className = 'col-md-4 col-lg-3 mb-4';
                
                let previewContent = '';
                let iconClass = '';
                
                switch (file.type) {
                    case 'image':
                        previewContent = `<img src="${file.data}" class="img-fluid rounded file-preview" alt="${file.title}" style="max-height: 150px;">`;
                        iconClass = 'bi-image';
                        break;
                    case 'video':
                        previewContent = `<video class="img-fluid rounded file-preview" style="max-height: 150px;" controls>
                                            <source src="${file.data}" type="video/mp4">
                                            Tu navegador no soporta videos HTML5.
                                        </video>`;
                        iconClass = 'bi-film';
                        break;
                    case 'audio':
                        previewContent = `<audio controls class="w-100">
                                            <source src="${file.data}" type="audio/mpeg">
                                            Tu navegador no soporta audio HTML5.
                                        </audio>`;
                        iconClass = 'bi-music-note-beamed';
                        break;
                    case 'document':
                        previewContent = `<div class="text-center py-4">
                                            <i class="bi bi-file-earmark-pdf" style="font-size: 3rem;"></i>
                                            <p class="mt-2 mb-0">${file.title}</p>
                                        </div>`;
                        iconClass = 'bi-file-earmark-pdf';
                        break;
                }
                
                const owner = await getUserByEmail(file.owner);
                const ownerName = owner ? owner.fullname : 'Usuario desconocido';
                
                fileCard.innerHTML = `
                    <div class="card h-100 file-card shadow-sm">
                        <div class="card-header p-2 d-flex justify-content-between align-items-center">
                            <small class="text-truncate" title="${file.title}">${file.title}</small>
                            <div>
                                <span class="badge bg-secondary">${file.type === 'image' ? 'Imagen' : 
                                    file.type === 'video' ? 'Video' : 
                                    file.type === 'audio' ? 'Música' : 'PDF'}</span>
                                ${file.visibility === 'private' ? '<span class="badge bg-warning ms-1">Privado</span>' : ''}
                            </div>
                        </div>
                        <div class="card-body p-2 d-flex flex-column">
                            <div class="flex-grow-1 d-flex align-items-center justify-content-center mb-2">
                                ${previewContent}
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${ownerName}</small>
                                <div>
                                    <span class="badge bg-light text-dark"><i class="bi bi-hand-thumbs-up"></i> ${file.likes}</span>
                                    <span class="badge bg-light text-dark ms-1"><i class="bi bi-hand-thumbs-down"></i> ${file.dislikes}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer p-2 d-flex justify-content-between">
                            <button class="btn btn-sm btn-outline-primary view-file-btn" data-file-id="${file.id}">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${file.owner === currentUser.email || isDeveloper ? `
                            <button class="btn btn-sm btn-outline-danger delete-file-btn" data-file-id="${file.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(fileCard);
            }
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-file-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const fileId = parseInt(e.target.closest('button').dataset.fileId);
                    await showFileModal(fileId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-file-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const fileId = parseInt(e.target.closest('button').dataset.fileId);
                    if (confirm('¿Estás seguro de que deseas eliminar este archivo?')) {
                        try {
                            await deleteFile(fileId);
                            showToast('Éxito', 'Archivo eliminado correctamente');
                            loadGalleryContent();
                        } catch (error) {
                            showToast('Error', error, true);
                        }
                    }
                });
            });
        }
        
        // Display folders in gallery
        async function displayFolders(folders) {
            const container = document.getElementById('folders-container');
            container.innerHTML = '';
            
            if (folders.length === 0) {
                return;
            }
            
            for (const folder of folders) {
                const folderCard = document.createElement('div');
                folderCard.className = 'col-md-4 col-lg-3 mb-4';
                
                const owner = await getUserByEmail(folder.owner);
                const ownerName = owner ? owner.fullname : 'Usuario desconocido';
                
                folderCard.innerHTML = `
                    <div class="card h-100 file-card shadow-sm">
                        <div class="card-header p-2 d-flex justify-content-between align-items-center">
                            <small class="text-truncate" title="${folder.name}">${folder.name}</small>
                            <div>
                                ${folder.visibility === 'private' ? '<span class="badge bg-warning">Privado</span>' : ''}
                            </div>
                        </div>
                        <div class="card-body p-2 d-flex flex-column">
                            <div class="flex-grow-1 d-flex align-items-center justify-content-center mb-2">
                                <i class="bi bi-folder" style="font-size: 3rem;"></i>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${ownerName}</small>
                            </div>
                        </div>
                        <div class="card-footer p-2 d-flex justify-content-between">
                            <button class="btn btn-sm btn-outline-primary view-folder-btn" data-folder-id="${folder.id}">
                                <i class="bi bi-folder2-open"></i> Abrir
                            </button>
                            ${folder.owner === currentUser.email || isDeveloper ? `
                            <button class="btn btn-sm btn-outline-danger delete-folder-btn" data-folder-id="${folder.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(folderCard);
            }
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-folder-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const folderId = parseInt(e.target.closest('button').dataset.folderId);
                    // Implement folder view functionality
                    showToast('Información', 'Funcionalidad de visualización de carpeta en desarrollo');
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-folder-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const folderId = parseInt(e.target.closest('button').dataset.folderId);
                    if (confirm('¿Estás seguro de que deseas eliminar esta carpeta?')) {
                        try {
                            // First delete all files in this folder
                            const transaction = db.transaction([FILE_STORE], 'readwrite');
                            const fileStore = transaction.objectStore(FILE_STORE);
                            const index = fileStore.index('folderId');
                            const request = index.openCursor(IDBKeyRange.only(folderId));
                            
                            request.onsuccess = (event) => {
                                const cursor = event.target.result;
                                if (cursor) {
                                    cursor.delete();
                                    cursor.continue();
                                }
                            };
                            
                            // Then delete the folder
                            const folderTransaction = db.transaction([FOLDER_STORE], 'readwrite');
                            const folderStore = folderTransaction.objectStore(FOLDER_STORE);
                            folderStore.delete(folderId);
                            
                            showToast('Éxito', 'Carpeta eliminada correctamente');
                            loadGalleryContent();
                        } catch (error) {
                            showToast('Error', error, true);
                        }
                    }
                });
            });
        }
        
        // Show file modal
        async function showFileModal(fileId) {
            const file = await getFileById(fileId);
            if (!file) {
                showToast('Error', 'Archivo no encontrado', true);
                return;
            }
            
            // Check if current user can view this file
            if (file.visibility === 'private' && file.owner !== currentUser.email && !isDeveloper) {
                showToast('Error', 'No tienes permiso para ver este archivo', true);
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('fileModal'));
            const modalTitle = document.getElementById('fileModalTitle');
            const previewContent = document.getElementById('filePreviewContent');
            const description = document.getElementById('fileModalDescription');
            const visibility = document.getElementById('fileModalVisibility');
            const type = document.getElementById('fileModalType');
            const owner = document.getElementById('fileModalOwner');
            const date = document.getElementById('fileModalDate');
            const likeCount = document.getElementById('likeCount');
            const dislikeCount = document.getElementById('dislikeCount');
            const commentsList = document.getElementById('commentsList');
            const addCommentForm = document.getElementById('addCommentForm');
            const fileActions = document.getElementById('fileActions');
            
            // Set modal content
            modalTitle.textContent = file.title;
            description.textContent = file.description || 'Sin descripción';
            visibility.textContent = file.visibility === 'public' ? 'Público' : 'Privado';
            type.textContent = file.type === 'image' ? 'Imagen' : 
                             file.type === 'video' ? 'Video' : 
                             file.type === 'audio' ? 'Música' : 'Documento PDF';
            
            // Get owner info
            const ownerInfo = await getUserByEmail(file.owner);
            owner.textContent = ownerInfo ? ownerInfo.fullname : 'Usuario desconocido';
            
            // Format date
            const uploadDate = new Date(file.uploadDate);
            date.textContent = uploadDate.toLocaleString();
            
            // Set likes and dislikes
            likeCount.textContent = file.likes;
            dislikeCount.textContent = file.dislikes;
            
            // Set preview content
            previewContent.innerHTML = '';
            switch (file.type) {
                case 'image':
                    previewContent.innerHTML = `<img src="${file.data}" class="img-fluid rounded" style="max-height: 400px;" alt="${file.title}">`;
                    break;
                case 'video':
                    previewContent.innerHTML = `<video class="w-100" controls>
                                                <source src="${file.data}" type="video/mp4">
                                                Tu navegador no soporta videos HTML5.
                                              </video>`;
                    break;
                case 'audio':
                    previewContent.innerHTML = `<audio controls class="w-100">
                                                    <source src="${file.data}" type="audio/mpeg">
                                                    Tu navegador no soporta audio HTML5.
                                                </audio>`;
                    break;
                case 'document':
                    previewContent.innerHTML = `<div class="text-center py-4">
                                                <i class="bi bi-file-earmark-pdf" style="font-size: 5rem;"></i>
                                                <p class="mt-3">${file.title}</p>
                                              </div>`;
                    break;
            }
            
            // Set download button if allowed
            fileActions.innerHTML = '';
            if (file.allowDownload || isDeveloper || file.owner === currentUser.email) {
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn btn-sm btn-outline-success';
                downloadBtn.innerHTML = '<i class="bi bi-download"></i> Descargar';
                downloadBtn.addEventListener('click', () => {
                    const a = document.createElement('a');
                    a.href = file.data;
                    a.download = file.title + (file.type === 'image' ? '.jpg' : 
                                 file.type === 'video' ? '.mp4' : 
                                 file.type === 'audio' ? '.mp3' : '.pdf');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
                fileActions.appendChild(downloadBtn);
            }
            
            // Load comments
            const comments = await getComments(fileId);
            commentsList.innerHTML = '';
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<div class="text-muted">No hay comentarios</div>';
            } else {
                comments.forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'mb-2';
                    commentEl.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <strong>${comment.userName}</strong>
                            <small class="text-muted">${new Date(comment.date).toLocaleString()}</small>
                        </div>
                        <div>${comment.text}</div>
                    `;
                    commentsList.appendChild(commentEl);
                });
            }
            
            // Show/hide comment form based on permissions
            if (file.allowComments || isDeveloper || file.owner === currentUser.email) {
                addCommentForm.classList.remove('d-none');
            } else {
                addCommentForm.classList.add('d-none');
            }
            
            // Clear comment form
            document.getElementById('commentText').value = '';
            
            // Set up like/dislike buttons
            document.getElementById('likeBtn').onclick = async () => {
                try {
                    const result = await addLike({
                        fileId: fileId,
                        userId: currentUser.email,
                        type: 'like',
                        date: new Date().toISOString()
                    });
                    
                    // Update counts
                    const updatedFile = await getFileById(fileId);
                    likeCount.textContent = updatedFile.likes;
                    dislikeCount.textContent = updatedFile.dislikes;
                    
                    showToast('Éxito', result.action === 'added' ? 'Like agregado' : 
                                          result.action === 'removed' ? 'Like eliminado' : 'Like actualizado');
                } catch (error) {
                    showToast('Error', error, true);
                }
            };
            
            document.getElementById('dislikeBtn').onclick = async () => {
                try {
                    const result = await addLike({
                        fileId: fileId,
                        userId: currentUser.email,
                        type: 'dislike',
                        date: new Date().toISOString()
                    });
                    
                    // Update counts
                    const updatedFile = await getFileById(fileId);
                    likeCount.textContent = updatedFile.likes;
                    dislikeCount.textContent = updatedFile.dislikes;
                    
                    showToast('Éxito', result.action === 'added' ? 'Dislike agregado' : 
                                          result.action === 'removed' ? 'Dislike eliminado' : 'Dislike actualizado');
                } catch (error) {
                    showToast('Error', error, true);
                }
            };
            
            // Set up comment form
            document.getElementById('addCommentForm').onsubmit = async (e) => {
                e.preventDefault();
                const commentText = document.getElementById('commentText').value.trim();
                
                if (!commentText) return;
                
                try {
                    await addComment({
                        fileId: fileId,
                        userId: currentUser.email,
                        text: commentText,
                        date: new Date().toISOString()
                    });
                    
                    // Reload comments
                    const updatedComments = await getComments(fileId);
                    commentsList.innerHTML = '';
                    
                    if (updatedComments.length === 0) {
                        commentsList.innerHTML = '<div class="text-muted">No hay comentarios</div>';
                    } else {
                        updatedComments.forEach(comment => {
                            const commentEl = document.createElement('div');
                            commentEl.className = 'mb-2';
                            commentEl.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <strong>${comment.userName}</strong>
                                    <small class="text-muted">${new Date(comment.date).toLocaleString()}</small>
                                </div>
                                <div>${comment.text}</div>
                            `;
                            commentsList.appendChild(commentEl);
                        });
                    }
                    
                    document.getElementById('commentText').value = '';
                    showToast('Éxito', 'Comentario agregado');
                } catch (error) {
                    showToast('Error', error, true);
                }
            };
            
            modal.show();
        }
        
        // Display users in management table
        async function displayUsers() {
            const users = await getAllUsers();
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            
            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No hay usuarios registrados</td></tr>';
                return;
            }
            
            for (const user of users) {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.fullname}</td>
                    <td>${user.email}</td>
                    <td>+${user.phone}</td>
                    <td>
                        <span class="badge ${user.isActive ? 'bg-success' : 'bg-danger'}">
                            ${user.isActive ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-user-btn" data-user-email="${user.email}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        ${user.email !== currentUser.email ? `
                        <button class="btn btn-sm btn-outline-danger delete-user-btn ms-1" data-user-email="${user.email}">
                            <i class="bi bi-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
            }
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const userEmail = e.target.closest('button').dataset.userEmail;
                    await showUserModal(userEmail);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const userEmail = e.target.closest('button').dataset.userEmail;
                    
                    if (confirm(`¿Estás seguro de que deseas eliminar al usuario ${userEmail}?`)) {
                        try {
                            // First delete all files by this user
                            const transaction = db.transaction([FILE_STORE], 'readwrite');
                            const fileStore = transaction.objectStore(FILE_STORE);
                            const index = fileStore.index('owner');
                            const request = index.openCursor(IDBKeyRange.only(userEmail));
                            
                            request.onsuccess = (event) => {
                                const cursor = event.target.result;
                                if (cursor) {
                                    cursor.delete();
                                    cursor.continue();
                                }
                            };
                            
                            // Then delete the user
                            await deleteUser(userEmail);
                            showToast('Éxito', 'Usuario eliminado correctamente');
                            displayUsers();
                        } catch (error) {
                            showToast('Error', error, true);
                        }
                    }
                });
            });
        }
        
        // Show user modal for editing
        async function showUserModal(userEmail) {
            const user = await getUserByEmail(userEmail);
            if (!user) {
                showToast('Error', 'Usuario no encontrado', true);
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            document.getElementById('edit-user-id').value = user.email;
            document.getElementById('edit-fullname').value = user.fullname;
            document.getElementById('edit-email').value = user.email;
            document.getElementById('edit-gender').value = user.gender;
            document.getElementById('edit-phone').value = user.phone;
            document.getElementById('edit-isActive').checked = user.isActive !== false;
            
            modal.show();
        }
        
        // Load gallery content based on active tab
        async function loadGalleryContent() {
            const activeTab = document.querySelector('#gallery-tabs .nav-link.active');
            const type = activeTab ? activeTab.dataset.type : 'all';
            
            // Load folders
            const folders = await getFolders();
            await displayFolders(folders);
            
            // Load files
            if (type === 'my-files') {
                const files = await getFiles('all', true);
                await displayFiles(files);
            } else {
                const files = await getFiles(type);
                await displayFiles(files);
            }
        }
        
        // Load share section content
        async function loadShareContent() {
            // Load users for sharing
            const users = await getAllUsers();
            const userSelect = document.getElementById('share-user');
            userSelect.innerHTML = '<option value="" selected disabled>Seleccione un usuario...</option>';
            
            users.forEach(user => {
                if (user.email !== currentUser.email) {
                    const option = document.createElement('option');
                    option.value = user.email;
                    option.textContent = user.fullname;
                    userSelect.appendChild(option);
                }
            });
            
            // Load current user's files for sharing
            const files = await getFiles('all', true);
            const fileSelect = document.getElementById('share-file');
            fileSelect.innerHTML = '<option value="" selected disabled>Seleccione un archivo...</option>';
            
            files.forEach(file => {
                const option = document.createElement('option');
                option.value = file.id;
                option.textContent = file.title;
                fileSelect.appendChild(option);
            });
            
            // Load shared files with current user
            const sharedFiles = await getSharedFiles();
            const sharedContainer = document.getElementById('shared-files-container');
            sharedContainer.innerHTML = '';
            
            if (sharedFiles.length === 0) {
                sharedContainer.innerHTML = '<div class="col-12 text-center text-muted py-3">No tienes archivos compartidos contigo</div>';
                return;
            }
            
            for (const file of sharedFiles) {
                const fileCard = document.createElement('div');
                fileCard.className = 'col-md-4 col-lg-3 mb-4';
                
                let previewContent = '';
                let iconClass = '';
                
                switch (file.type) {
                    case 'image':
                        previewContent = `<img src="${file.data}" class="img-fluid rounded file-preview" alt="${file.title}" style="max-height: 150px;">`;
                        iconClass = 'bi-image';
                        break;
                    case 'video':
                        previewContent = `<video class="img-fluid rounded file-preview" style="max-height: 150px;" controls>
                                            <source src="${file.data}" type="video/mp4">
                                            Tu navegador no soporta videos HTML5.
                                        </video>`;
                        iconClass = 'bi-film';
                        break;
                    case 'audio':
                        previewContent = `<audio controls class="w-100">
                                            <source src="${file.data}" type="audio/mpeg">
                                            Tu navegador no soporta audio HTML5.
                                        </audio>`;
                        iconClass = 'bi-music-note-beamed';
                        break;
                    case 'document':
                        previewContent = `<div class="text-center py-4">
                                            <i class="bi bi-file-earmark-pdf" style="font-size: 3rem;"></i>
                                            <p class="mt-2 mb-0">${file.title}</p>
                                        </div>`;
                        iconClass = 'bi-file-earmark-pdf';
                        break;
                }
                
                const owner = await getUserByEmail(file.sharedBy);
                const ownerName = owner ? owner.fullname : 'Usuario desconocido';
                
                fileCard.innerHTML = `
                    <div class="card h-100 file-card shadow-sm">
                        <div class="card-header p-2 d-flex justify-content-between align-items-center">
                            <small class="text-truncate" title="${file.title}">${file.title}</small>
                            <div>
                                <span class="badge bg-secondary">${file.type === 'image' ? 'Imagen' : 
                                    file.type === 'video' ? 'Video' : 
                                    file.type === 'audio' ? 'Música' : 'PDF'}</span>
                            </div>
                        </div>
                        <div class="card-body p-2 d-flex flex-column">
                            <div class="flex-grow-1 d-flex align-items-center justify-content-center mb-2">
                                ${previewContent}
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Compartido por: ${ownerName}</small>
                            </div>
                        </div>
                        <div class="card-footer p-2 d-flex justify-content-between">
                            <button class="btn btn-sm btn-outline-primary view-file-btn" data-file-id="${file.id}">
                                <i class="bi bi-eye"></i> Ver
                            </button>
                            ${file.allowDownload ? `
                            <button class="btn btn-sm btn-outline-success download-shared-btn" data-file-url="${file.data}" data-file-name="${file.title}${file.type === 'image' ? '.jpg' : 
                                                                                                                                                file.type === 'video' ? '.mp4' : 
                                                                                                                                                file.type === 'audio' ? '.mp3' : '.pdf'}">
                                <i class="bi bi-download"></i> Descargar
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                sharedContainer.appendChild(fileCard);
            }
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-file-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const fileId = parseInt(e.target.closest('button').dataset.fileId);
                    await showFileModal(fileId);
                });
            });
            
            // Add event listeners to download buttons
            document.querySelectorAll('.download-shared-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fileUrl = e.target.closest('button').dataset.fileUrl;
                    const fileName = e.target.closest('button').dataset.fileName;
                    
                    const a = document.createElement('a');
                    a.href = fileUrl;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
            });
        }
        
        // Initialize the application
        async function initApp() {
            try {
                await initDB();
                
                // Setup event listeners for welcome screen
                document.getElementById('login-btn').addEventListener('click', () => {
                    document.getElementById('welcome-screen').classList.add('d-none');
                    document.getElementById('login-screen').classList.remove('d-none');
                });
                
                document.getElementById('register-btn').addEventListener('click', () => {
                    document.getElementById('welcome-screen').classList.add('d-none');
                    document.getElementById('register-screen').classList.remove('d-none');
                });
                
                // Setup event listeners for register screen
                document.getElementById('back-from-register').addEventListener('click', () => {
                    document.getElementById('register-screen').classList.add('d-none');
                    document.getElementById('welcome-screen').classList.remove('d-none');
                });
                
                document.getElementById('password').addEventListener('input', (e) => {
                    checkPasswordStrength(e.target.value);
                });
                
                document.getElementById('help-btn').addEventListener('click', () => {
                    const helpPanel = document.getElementById('help-panel');
                    helpPanel.classList.toggle('d-none');
                    
                    // Hide other panels
                    document.getElementById('email-help-form').classList.add('d-none');
                    document.getElementById('whatsapp-help-form').classList.add('d-none');
                });
                
                document.getElementById('email-help').addEventListener('click', () => {
                    document.getElementById('email-help-form').classList.remove('d-none');
                    document.getElementById('whatsapp-help-form').classList.add('d-none');
                });
                
                document.getElementById('whatsapp-help').addEventListener('click', () => {
                    document.getElementById('whatsapp-help-form').classList.remove('d-none');
                    document.getElementById('email-help-form').classList.add('d-none');
                });
                
                document.getElementById('send-email-help').addEventListener('click', () => {
                    const name = document.getElementById('help-name').value.trim();
                    const email = document.getElementById('help-email').value.trim();
                    
                    if (!name || !email) {
                        showToast('Error', 'Por favor complete todos los campos', true);
                        return;
                    }
                    
                    if (!isValidGmail(email)) {
                        showToast('Error', 'Por favor ingrese un email de Gmail válido', true);
                        return;
                    }
                    
                    const subject = `Consulta de ${name} sobre mYpuB`;
                    const body = `Hola Tarciano,\n\nTengo una consulta sobre la aplicación mYpuB:\n\n[Escribe tu consulta aquí]`;
                    
                    window.location.href = `mailto:enzemajr@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    
                    showToast('Éxito', 'Redirigiendo a tu cliente de email');
                    
                    // Reset form
                    document.getElementById('help-name').value = '';
                    document.getElementById('help-email').value = '';
                    document.getElementById('help-panel').classList.add('d-none');
                    document.getElementById('email-help-form').classList.add('d-none');
                });
                
                document.getElementById('send-whatsapp-help').addEventListener('click', () => {
                    const name = document.getElementById('whatsapp-name').value.trim();
                    const number = document.getElementById('whatsapp-number').value.trim();
                    
                    if (!name || !number) {
                        showToast('Error', 'Por favor complete todos los campos', true);
                        return;
                    }
                    
                    if (!isValidPhone(number)) {
                        showToast('Error', 'Por favor ingrese un número de teléfono válido', true);
                        return;
                    }
                    
                    const message = `Hola Tarciano, soy ${name}. Tengo una consulta sobre la aplicación mYpuB: [Escribe tu consulta aquí]`;
                    
                    window.open(`https://wa.me/+240222084663?text=${encodeURIComponent(message)}`, '_blank');
                    
                    showToast('Éxito', 'Redirigiendo a WhatsApp');
                    
                    // Reset form
                    document.getElementById('whatsapp-name').value = '';
                    document.getElementById('whatsapp-number').value = '';
                    document.getElementById('help-panel').classList.add('d-none');
                    document.getElementById('whatsapp-help-form').classList.add('d-none');
                });
                
                document.getElementById('register-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const fullname = document.getElementById('fullname').value.trim();
                    const email = document.getElementById('email').value.trim();
                    const gender = document.getElementById('gender').value;
                    const phone = document.getElementById('phone').value.trim();
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;
                    
                    // Validate form
                    if (!fullname || !email || !gender || !phone || !password || !confirmPassword) {
                        showToast('Error', 'Por favor complete todos los campos', true);
                        return;
                    }
                    
                    if (!isValidGmail(email)) {
                        showToast('Error', 'Por favor ingrese un email de Gmail válido', true);
                        document.getElementById('email').classList.add('is-invalid');
                        return;
                    } else {
                        document.getElementById('email').classList.remove('is-invalid');
                    }
                    
                    if (!isValidPhone(phone)) {
                        showToast('Error', 'Por favor ingrese un número de teléfono válido con prefijo', true);
                        document.getElementById('phone').classList.add('is-invalid');
                        return;
                    } else {
                        document.getElementById('phone').classList.remove('is-invalid');
                    }
                    
                    if (!validatePassword(password)) {
                        showToast('Error', 'La contraseña no cumple con los requisitos', true);
                        document.getElementById('password').classList.add('is-invalid');
                        return;
                    } else {
                        document.getElementById('password').classList.remove('is-invalid');
                    }
                    
                    if (password !== confirmPassword) {
                        showToast('Error', 'Las contraseñas no coinciden', true);
                        document.getElementById('confirm-password').classList.add('is-invalid');
                        return;
                    } else {
                        document.getElementById('confirm-password').classList.remove('is-invalid');
                    }
                    
                    // Create user object
                    const user = {
                        fullname,
                        email,
                        gender,
                        phone,
                        password,
                        isActive: true,
                        registrationDate: new Date().toISOString()
                    };
                    
                    try {
                        await registerUser(user);
                        
                        // Auto-login after registration
                        currentUser = user;
                        
                        // Check if this is the developer
                        if (password === 'Enzema0097@&') {
                            isDeveloper = true;
                            document.getElementById('users-management-item').classList.remove('d-none');
                        }
                        
                        // Show welcome message based on gender
                        let welcomeMessage = '';
                        if (gender === 'Hombre') {
                            welcomeMessage = `Bienvenido a <span class="georgia-bold">mYpuB</span> Sr. ${fullname}`;
                        } else if (gender === 'Mujer') {
                            welcomeMessage = `Bienvenida a <span class="georgia-bold">mYpuB</span> Sra. ${fullname}`;
                        } else {
                            welcomeMessage = `Gracias por utilizar <span class="georgia-bold">mYpuB</span>`;
                        }
                        
                        showToast('Éxito', welcomeMessage);
                        
                        // Switch to main app
                        document.getElementById('register-screen').classList.add('d-none');
                        document.getElementById('main-app').classList.remove('d-none');
                        
                        // Set username in sidebar
                        document.getElementById('username-display').textContent = fullname;
                        
                        // Load initial content
                        loadGalleryContent();
                    } catch (error) {
                        showToast('Error', error, true);
                    }
                });
                
                // Setup event listeners for login screen
                document.getElementById('back-from-login').addEventListener('click', () => {
                    document.getElementById('login-screen').classList.add('d-none');
                    document.getElementById('welcome-screen').classList.remove('d-none');
                });
                
                document.getElementById('login-help-btn').addEventListener('click', () => {
                    const helpPanel = document.getElementById('login-help-panel');
                    helpPanel.classList.toggle('d-none');
                });
                
                document.getElementById('login-email-help').addEventListener('click', () => {
                    const name = prompt("Ingrese su nombre completo:");
                    const email = prompt("Ingrese su email para recibir respuestas:");
                    
                    if (name && email) {
                        if (!isValidGmail(email)) {
                            showToast('Error', 'Por favor ingrese un email de Gmail válido', true);
                            return;
                        }
                        
                        const subject = `Consulta de ${name} sobre mYpuB`;
                        const body = `Hola Tarciano,\n\nTengo una consulta sobre la aplicación mYpuB:\n\n[Escribe tu consulta aquí]`;
                        
                        window.location.href = `mailto:enzemajr@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    }
                });
                
                document.getElementById('login-whatsapp-help').addEventListener('click', () => {
                    const name = prompt("Ingrese su nombre completo:");
                    const number = prompt("Ingrese su número de WhatsApp:");
                    
                    if (name && number) {
                        if (!isValidPhone(number)) {
                            showToast('Error', 'Por favor ingrese un número de teléfono válido', true);
                            return;
                        }
                        
                        const message = `Hola Tarciano, soy ${name}. Tengo una consulta sobre la aplicación mYpuB: [Escribe tu consulta aquí]`;
                        
                        window.open(`https://wa.me/+240222084663?text=${encodeURIComponent(message)}`, '_blank');
                    }
                });
                
                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('login-email').value.trim();
                    const password = document.getElementById('login-password').value;
                    
                    try {
                        const user = await loginUser(email, password);
                        
                        // Show welcome message based on gender
                        let welcomeMessage = '';
                        if (user.gender === 'Hombre') {
                            welcomeMessage = `Bienvenido a <span class="georgia-bold">mYpuB</span> Sr. ${user.fullname}`;
                        } else if (user.gender === 'Mujer') {
                            welcomeMessage = `Bienvenida a <span class="georgia-bold">mYpuB</span> Sra. ${user.fullname}`;
                        } else {
                            welcomeMessage = `Gracias por utilizar <span class="georgia-bold">mYpuB</span>`;
                        }
                        
                        showToast('Éxito', welcomeMessage);
                        
                        // Switch to main app
                        document.getElementById('login-screen').classList.add('d-none');
                        document.getElementById('main-app').classList.remove('d-none');
                        
                        // Set username in sidebar
                        document.getElementById('username-display').textContent = user.fullname;
                        
                        // Load initial content
                        loadGalleryContent();
                    } catch (error) {
                        showToast('Error', error, true);
                    }
                });
                
                // Setup event listeners for main app
                // Navigation tabs
                document.getElementById('upload-tab').addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Set active tab
                    document.querySelectorAll('.nav-link').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Show content
                    document.getElementById('upload-section').classList.remove('d-none');
                    document.getElementById('gallery-section').classList.add('d-none');
                    document.getElementById('share-section').classList.add('d-none');
                    document.getElementById('users-section').classList.add('d-none');
                    document.getElementById('info-section').classList.add('d-none');
                });
                
                document.getElementById('gallery-tab').addEventListener('click', async (e) => {
                    e.preventDefault();
                    
                    // Set active tab
                    document.querySelectorAll('.nav-link').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Show content
                    document.getElementById('upload-section').classList.add('d-none');
                    document.getElementById('gallery-section').classList.remove('d-none');
                    document.getElementById('share-section').classList.add('d-none');
                    document.getElementById('users-section').classList.add('d-none');
                    document.getElementById('info-section').classList.add('d-none');
                    
                    // Load gallery content
                    await loadGalleryContent();
                });
                
                document.getElementById('share-tab').addEventListener('click', async (e) => {
                    e.preventDefault();
                    
                    // Set active tab
                    document.querySelectorAll('.nav-link').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Show content
                    document.getElementById('upload-section').classList.add('d-none');
                    document.getElementById('gallery-section').classList.add('d-none');
                    document.getElementById('share-section').classList.remove('d-none');
                    document.getElementById('users-section').classList.add('d-none');
                    document.getElementById('info-section').classList.add('d-none');
                    
                    // Load share content
                    await loadShareContent();
                });
                
                document.getElementById('users-tab').addEventListener('click', async (e) => {
                    e.preventDefault();
                    
                    // Set active tab
                    document.querySelectorAll('.nav-link').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Show content
                    document.getElementById('upload-section').classList.add('d-none');
                    document.getElementById('gallery-section').classList.add('d-none');
                    document.getElementById('share-section').classList.add('d-none');
                    document.getElementById('users-section').classList.remove('d-none');
                    document.getElementById('info-section').classList.add('d-none');
                    
                    // Load users
                    await displayUsers();
                });
                
                document.getElementById('info-tab').addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Set active tab
                    document.querySelectorAll('.nav-link').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Show content
                    document.getElementById('upload-section').classList.add('d-none');
                    document.getElementById('gallery-section').classList.add('d-none');
                    document.getElementById('share-section').classList.add('d-none');
                    document.getElementById('users-section').classList.add('d-none');
                    document.getElementById('info-section').classList.remove('d-none');
                });
                
                // Logout button
                document.getElementById('logout-btn').addEventListener('click', () => {
                    currentUser = null;
                    isDeveloper = false;
                    
                    // Reset forms
                    document.getElementById('login-form').reset();
                    document.getElementById('register-form').reset();
                    
                    // Switch to welcome screen
                    document.getElementById('main-app').classList.add('d-none');
                    document.getElementById('welcome-screen').classList.remove('d-none');
                });
                
                // Upload form
                document.getElementById('upload-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const fileInput = document.getElementById('file-upload');
                    const fileType = document.getElementById('file-type').value;
                    const title = document.getElementById('file-title').value.trim();
                    const description = document.getElementById('file-description').value.trim();
                    const visibility = document.querySelector('input[name="visibility"]:checked').value;
                    const allowComments = document.getElementById('allow-comments').checked;
                    const allowDownload = document.getElementById('allow-download').checked;
                    
                    // Validate form
                    if (!fileType || !title || fileInput.files.length === 0) {
                        showToast('Error', 'Por favor complete todos los campos requeridos', true);
                        return;
                    }
                    
                    const file = fileInput.files[0];
                    
                    // Validate file types
                    if (fileType === 'image' && !file.type.startsWith('image/')) {
                        showToast('Error', 'Por favor seleccione un archivo de imagen válido', true);
                        return;
                    }
                    
                    if (fileType === 'video' && !file.type.startsWith('video/')) {
                        showToast('Error', 'Por favor seleccione un archivo de video válido', true);
                        return;
                    }
                    
                    if (fileType === 'audio' && !file.type.startsWith('audio/') && !file.name.endsWith('.mp3')) {
                        showToast('Error', 'Por favor seleccione un archivo de audio MP3', true);
                        return;
                    }
                    
                    if (fileType === 'document' && !file.type.includes('pdf') && !file.name.endsWith('.pdf')) {
                        showToast('Error', 'Por favor seleccione un archivo PDF', true);
                        return;
                    }
                    
                    try {
                        // Read file as base64
                        const base64Data = await readFileAsBase64(file);
                        
                        // Create file object
                        const fileData = {
                            owner: currentUser.email,
                            type: fileType,
                            title,
                            description,
                            data: base64Data,
                            visibility,
                            allowComments,
                            allowDownload,
                            uploadDate: new Date().toISOString(),
                            likes: 0,
                            dislikes: 0
                        };
                        
                        // Upload file
                        await uploadFile(fileData);
                        
                        showToast('Éxito', 'Archivo subido correctamente');
                        
                        // Reset form
                        document.getElementById('upload-form').reset();
                        
                        // If we're in gallery view, refresh the content
                        if (!document.getElementById('gallery-section').classList.contains('d-none')) {
                            loadGalleryContent();
                        }
                    } catch (error) {
                        showToast('Error', error, true);
                    }
                });
                
                // Gallery tabs
                document.querySelectorAll('#gallery-tabs .nav-link').forEach(tab => {
                    tab.addEventListener('click', async (e) => {
                        e.preventDefault();
                        
                        // Set active tab
                        document.querySelectorAll('#gallery-tabs .nav-link').forEach(t => {
                            t.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        
                        // Load content
                        await loadGalleryContent();
                    });
                });
                
                // Create folder button
                document.getElementById('create-folder-btn').addEventListener('click', () => {
                    document.getElementById('create-folder-card').classList.remove('d-none');
                });
                
                // Cancel folder creation
                document.getElementById('cancel-folder').addEventListener('click', () => {
                    document.getElementById('folder-form').reset();
                    document.getElementById('create-folder-card').classList.add('d-none');
                });
                
                // Folder form
                document.getElementById('folder-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('folder-name').value.trim();
                    const visibility = document.querySelector('input[name="folder-visibility"]:checked').value;
                    
                    if (!name) {
                        showToast('Error', 'Por favor ingrese un nombre para la carpeta', true);
                        return;
                    }
                    
                    try {
                        await createFolder({
                            owner: currentUser.email,
                            name,
                            visibility,
                            createdDate: new Date().toISOString()
                        });
                        
                        showToast('Éxito', 'Carpeta creada correctamente');
                        
                        // Reset form
                        document.getElementById('folder-form').reset();
                        document.getElementById('create-folder-card').classList.add('d-none');
                        
                        // Refresh folders list
                        const folders = await getFolders();
                        await displayFolders(folders);
                    } catch (error) {
                        showToast('Error', error, true);
                    }
                });
                
                // Share form
                document.getElementById('share-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const userId = document.getElementById('share-user').value;
                    const fileId = parseInt(document.getElementById('share-file').value);
                    
                    if (!userId || !fileId) {
                        showToast('Error', 'Por favor seleccione un usuario y un archivo', true);
                        return;
                    }
                    
                    try {
                        // Check if file is already shared with this user
                        const transaction = db.transaction([SHARE_STORE], 'readonly');
                        const store = transaction.objectStore(SHARE_STORE);
                        const index = store.index('fileId');
                        const request = index.openCursor(IDBKeyRange.only(fileId));
                        
                        let alreadyShared = false;
                        
                        request.onsuccess = (event) => {
                            const cursor = event.target.result;
                            if (cursor) {
                                if (cursor.value.toUser === userId) {
                                    alreadyShared = true;
                                    return;
                                }
                                cursor.continue();
                            } else {
                                if (alreadyShared) {
                                    showToast('Error', 'Este archivo ya ha sido compartido con este usuario', true);
                                } else {
                                    // Share the file
                                    shareFile({
                                        fileId,
                                        fromUser: currentUser.email,
                                        toUser: userId,
                                        shareDate: new Date().toISOString()
                                    }).then(() => {
                                        showToast('Éxito', 'Archivo compartido correctamente');
                                        document.getElementById('share-form').reset();
                                        loadShareContent();
                                    }).catch(error => {
                                        showToast('Error', error, true);
                                    });
                                }
                            }
                        };
                        
                        request.onerror = (event) => {
                            showToast('Error', 'Error al verificar archivos compartidos', true);
                        };
                    } catch (error) {
                        showToast('Error', error, true);
                    }
                });
                
                // User management modal
                document.getElementById('save-user-changes').addEventListener('click', async () => {
                    const userId = document.getElementById('edit-user-id').value;
                    const fullname = document.getElementById('edit-fullname').value.trim();
                    const gender = document.getElementById('edit-gender').value;
                    const phone = document.getElementById('edit-phone').value.trim();
                    const isActive = document.getElementById('edit-isActive').checked;
                    
                    if (!fullname || !gender || !phone) {
                        showToast('Error', 'Por favor complete todos los campos', true);
                        return;
                    }
                    
                    if (!isValidPhone(phone)) {
                        showToast('Error', 'Por favor ingrese un número de teléfono válido con prefijo', true);
                        return;
                    }
                    
                    try {
                        const user = await getUserByEmail(userId);
                        if (!user) {
                            showToast('Error', 'Usuario no encontrado', true);
                            return;
                        }
                        
                        // Update user data
                        user.fullname = fullname;
                        user.gender = gender;
                        user.phone = phone;
                        user.isActive = isActive;
                        
                        await updateUser(user);
                        
                        showToast('Éxito', 'Usuario actualizado correctamente');
                        
                        // Close modal and refresh users list
                        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                        await displayUsers();
                    } catch (error) {
                        showToast('Error', error, true);
                    }
                });
                
                document.getElementById('delete-user-btn').addEventListener('click', async () => {
                    const userId = document.getElementById('edit-user-id').value;
                    
                    if (confirm(`¿Estás seguro de que deseas eliminar al usuario ${userId}?`)) {
                        try {
                            // First delete all files by this user
                            const transaction = db.transaction([FILE_STORE], 'readwrite');
                            const fileStore = transaction.objectStore(FILE_STORE);
                            const index = fileStore.index('owner');
                            const request = index.openCursor(IDBKeyRange.only(userId));
                            
                            request.onsuccess = (event) => {
                                const cursor = event.target.result;
                                if (cursor) {
                                    cursor.delete();
                                    cursor.continue();
                                }
                            };
                            
                            // Then delete the user
                            await deleteUser(userId);
                            
                            showToast('Éxito', 'Usuario eliminado correctamente');
                            
                            // Close modal and refresh users list
                            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                            await displayUsers();
                        } catch (error) {
                            showToast('Error', error, true);
                        }
                    }
                });
                
                // Show welcome screen by default
                document.getElementById('welcome-screen').classList.remove('d-none');
                
            } catch (error) {
                console.error('Error initializing application:', error);
                alert('Error al inicializar la aplicación. Por favor recarga la página.');
            }
        }
        
        // Start the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
