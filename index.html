<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mYpuB - Almacenamiento Multimedia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .brand {
            font-family: Georgia, serif;
            font-weight: bold;
            color: black !important;
        }
        .welcome-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        .file-card {
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .file-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        .sidebar {
            height: 100vh;
            position: fixed;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .login-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            margin-top: 50px;
        }
        .password-help {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .help-panel {
            display: none;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Pantalla de Registro/Login -->
    <div id="auth-container" class="container">
        <div class="row">
            <div class="col-md-12">
                <div id="login-form" class="login-container bg-white">
                    <h2 class="text-center mb-4">Inicie la sesión en <span class="brand">mYpuB</span></h2>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Correo electrónico</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Iniciar sesión</button>
                        <p class="text-center mt-3">¿No tienes una cuenta? <a href="#" id="showRegister">Regístrate</a></p>
                    </form>
                </div>

                <div id="register-form" class="login-container bg-white" style="display: none;">
                    <h2 class="text-center mb-4">Regístrate en <span class="brand">mYpuB</span></h2>
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Nombre completo</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Correo electrónico (Gmail)</label>
                            <input type="email" class="form-control" id="email" required>
                            <div class="invalid-feedback">Debe ser una dirección de Gmail válida</div>
                        </div>
                        <div class="mb-3">
                            <label for="gender" class="form-label">Sexo</label>
                            <select class="form-select" id="gender" required>
                                <option value="">Seleccione...</option>
                                <option value="Hombre">Hombre</option>
                                <option value="Mujer">Mujer</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Teléfono (con prefijo)</label>
                            <input type="tel" class="form-control" id="phone" required>
                            <div class="invalid-feedback">Debe incluir el prefijo internacional</div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="password" required>
                            <div class="password-help">
                                La contraseña debe tener 12 caracteres: 6 letras (primera mayúscula), 4 números y 2 símbolos (@#&)
                            </div>
                            <div class="invalid-feedback">La contraseña no cumple los requisitos</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                            <div class="invalid-feedback">Las contraseñas no coinciden</div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary mb-3" id="helpButton">
                            <i class="bi bi-question-circle"></i> AYUDA
                        </button>
                        <div id="helpPanel" class="help-panel">
                            <h5>Enviar consulta</h5>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary w-100 mb-2" id="emailHelp">
                                    <i class="bi bi-envelope"></i> Por Email
                                </button>
                                <button type="button" class="btn btn-outline-success w-100" id="whatsappHelp">
                                    <i class="bi bi-whatsapp"></i> Por WhatsApp
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Registrarse</button>
                        <p class="text-center mt-3">¿Ya tienes una cuenta? <a href="#" id="showLogin">Inicia sesión</a></p>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel Principal -->
    <div id="main-container" style="display: none;">
        <div class="sidebar col-md-2 d-none d-md-block">
            <div class="text-center mb-4">
                <h3 class="brand">mYpuB</h3>
                <p id="welcomeMessage" class="welcome-message"></p>
                <p id="userEmail" class="text-muted small"></p>
                <p id="storageInfo" class="text-muted small"></p>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" id="uploadTab">
                        <i class="bi bi-upload"></i> SUBIR TU
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="galleryTab">
                        <i class="bi bi-images"></i> GALERÍA
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="shareTab">
                        <i class="bi bi-share"></i> COMPARTIR
                    </a>
                </li>
                <li class="nav-item" id="adminTab" style="display: none;">
                    <a class="nav-link" href="#" id="usersTab">
                        <i class="bi bi-people"></i> GESTIÓN DE USUARIOS
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="infoTab">
                        <i class="bi bi-info-circle"></i> INFÓRMATE
                    </a>
                </li>
                <li class="nav-item mt-4">
                    <a class="nav-link text-danger" href="#" id="logoutBtn">
                        <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                    </a>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <!-- Panel de Subir Archivos -->
            <div id="upload-panel">
                <h3><i class="bi bi-upload"></i> Subir archivos</h3>
                <div class="mb-4">
                    <input type="file" class="form-control" id="fileInput" multiple>
                    <div class="mt-2">
                        <select class="form-select" id="fileType">
                            <option value="image">Imagen</option>
                            <option value="video">Video</option>
                            <option value="audio">Música (MP3)</option>
                            <option value="document">Documento PDF</option>
                        </select>
                    </div>
                    <div class="mt-2">
                        <select class="form-select" id="fileVisibility">
                            <option value="public">Público</option>
                            <option value="private">Privado</option>
                        </select>
                    </div>
                    <div class="mt-2">
                        <input type="text" class="form-control" id="fileName" placeholder="Título del archivo">
                    </div>
                    <div class="mt-2">
                        <textarea class="form-control" id="fileDescription" placeholder="Descripción (opcional)" rows="2"></textarea>
                    </div>
                    <button class="btn btn-primary mt-3" id="uploadBtn">Subir archivo</button>
                </div>
                <div id="uploadProgress" class="progress" style="display: none;">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="uploadStatus" class="mt-2"></div>
            </div>

            <!-- Panel de Galería -->
            <div id="gallery-panel" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="bi bi-images"></i> Galería</h3>
                    <button class="btn btn-sm btn-outline-primary" id="createFolderBtn">
                        <i class="bi bi-folder-plus"></i> Crear carpeta
                    </button>
                </div>
                <div id="folderModal" class="modal fade" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Crear nueva carpeta</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <input type="text" class="form-control" id="folderName" placeholder="Nombre de la carpeta">
                                <select class="form-select mt-2" id="folderVisibility">
                                    <option value="public">Pública</option>
                                    <option value="private">Privada</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="saveFolderBtn">Crear</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="gallery-content" class="row">
                    <!-- Los archivos se cargarán aquí dinámicamente -->
                </div>
            </div>

            <!-- Panel de Compartir -->
            <div id="share-panel" style="display: none;">
                <h3><i class="bi bi-share"></i> Compartir archivos</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Seleccionar usuario</label>
                            <select class="form-select" id="shareUserSelect">
                                <!-- Usuarios se cargarán aquí -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Seleccionar archivo</label>
                            <select class="form-select" id="shareFileSelect">
                                <!-- Archivos se cargarán aquí -->
                            </select>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" id="shareBtn">Compartir archivo</button>
                <div id="shareStatus" class="mt-3"></div>

                <h4 class="mt-5">Archivos compartidos conmigo</h4>
                <div id="sharedFilesContainer" class="row mt-3">
                    <!-- Archivos compartidos se cargarán aquí -->
                </div>
            </div>

            <!-- Panel de Gestión de Usuarios (solo para desarrollador) -->
            <div id="users-panel" style="display: none;">
                <h3><i class="bi bi-people"></i> Gestión de usuarios</h3>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Usuarios se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Panel de Información -->
            <div id="info-panel" style="display: none;">
                <h3><i class="bi bi-info-circle"></i> Información sobre <span class="brand">mYpuB</span></h3>
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">¿Qué es <span class="brand">mYpuB</span>?</h5>
                        <p class="card-text">
                            <span class="brand">mYpuB</span> es una plataforma de almacenamiento multimedia que te permite subir, 
                            organizar y compartir tus archivos de manera segura. Puedes almacenar imágenes, videos, 
                            música y documentos PDF, y decidir si quieres que sean públicos o privados.
                        </p>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">¿Cómo usar <span class="brand">mYpuB</span>?</h5>
                        <ol>
                            <li>Regístrate con tu cuenta de Gmail</li>
                            <li>Inicia sesión con tus credenciales</li>
                            <li>Sube tus archivos desde el panel "SUBIR TU"</li>
                            <li>Organiza tus archivos en carpetas desde "GALERÍA"</li>
                            <li>Comparte archivos con otros usuarios desde "COMPARTIR"</li>
                            <li>Gestiona tu cuenta y disfruta de hasta 100GB de almacenamiento</li>
                        </ol>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Sobre el desarrollador</h5>
                        <ul class="list-unstyled">
                            <li><strong>Nombre completo:</strong> Tarciano ENZEMA NCHAMA</li>
                            <li><strong>Formación académica:</strong> Finalista universitario de la UNGE</li>
                            <li><strong>Facultad:</strong> Ciencias económicas gestión y administración</li>
                            <li><strong>Departamento:</strong> Informática de gestión empresarial</li>
                            <li><strong>Contacto:</strong> enzemajr@gmail.com</li>
                            <li><strong>Fecha final del desarrollo:</strong> 06/07/2025</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualización de archivos -->
    <div class="modal fade" id="fileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center" id="fileModalContent">
                    <!-- Contenido del archivo se cargará aquí -->
                </div>
                <div class="modal-footer">
                    <div class="me-auto" id="fileModalInfo"></div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="downloadFileBtn">Descargar</button>
                    <button type="button" class="btn btn-outline-primary" id="likeFileBtn">
                        <i class="bi bi-hand-thumbs-up"></i> <span id="likeCount">0</span>
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="dislikeFileBtn">
                        <i class="bi bi-hand-thumbs-down"></i> <span id="dislikeCount">0</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ayuda por email -->
    <div class="modal fade" id="emailHelpModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enviar consulta por email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="helpName" class="form-label">Nombre completo</label>
                        <input type="text" class="form-control" id="helpName">
                    </div>
                    <div class="mb-3">
                        <label for="helpEmail" class="form-label">Email para respuesta</label>
                        <input type="email" class="form-control" id="helpEmail">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="sendEmailHelpBtn">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ayuda por WhatsApp -->
    <div class="modal fade" id="whatsappHelpModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enviar consulta por WhatsApp</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="whatsappName" class="form-label">Nombre completo</label>
                        <input type="text" class="form-control" id="whatsappName">
                    </div>
                    <div class="mb-3">
                        <label for="whatsappNumber" class="form-label">Número de WhatsApp</label>
                        <input type="tel" class="form-control" id="whatsappNumber">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="sendWhatsappHelpBtn">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let db;
        let currentUser = null;
        let isDeveloper = false;
        const DEVELOPER_PASSWORD = "Enzema0097@&";
        const MAX_STORAGE = 50 * 1024 * 1024 * 1024; // 50GB en bytes
        const MAX_STORAGE_DEVELOPER = 100 * 1024 * 1024 * 1024; // 100GB en bytes

        // Inicialización de la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initDB();
            setupEventListeners();
        });

        // Inicializar la base de datos IndexedDB
        function initDB() {
            const request = indexedDB.open('mYpuBDB', 3);

            request.onupgradeneeded = function(event) {
                const db = event.target.result;

                // Crear almacén de objetos para usuarios
                if (!db.objectStoreNames.contains('users')) {
                    const usersStore = db.createObjectStore('users', { keyPath: 'email' });
                    usersStore.createIndex('email', 'email', { unique: true });
                }

                // Crear almacén de objetos para archivos
                if (!db.objectStoreNames.contains('files')) {
                    const filesStore = db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                    filesStore.createIndex('owner', 'owner', { unique: false });
                    filesStore.createIndex('type', 'type', { unique: false });
                    filesStore.createIndex('visibility', 'visibility', { unique: false });
                    filesStore.createIndex('folderId', 'folderId', { unique: false });
                }

                // Crear almacén de objetos para carpetas
                if (!db.objectStoreNames.contains('folders')) {
                    const foldersStore = db.createObjectStore('folders', { keyPath: 'id', autoIncrement: true });
                    foldersStore.createIndex('owner', 'owner', { unique: false });
                    foldersStore.createIndex('visibility', 'visibility', { unique: false });
                }

                // Crear almacén de objetos para archivos compartidos
                if (!db.objectStoreNames.contains('sharedFiles')) {
                    const sharedStore = db.createObjectStore('sharedFiles', { keyPath: 'id', autoIncrement: true });
                    sharedStore.createIndex('fileId', 'fileId', { unique: false });
                    sharedStore.createIndex('fromUser', 'fromUser', { unique: false });
                    sharedStore.createIndex('toUser', 'toUser', { unique: false });
                }

                // Crear almacén de objetos para likes
                if (!db.objectStoreNames.contains('likes')) {
                    const likesStore = db.createObjectStore('likes', { keyPath: ['fileId', 'userId'] });
                }
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('Base de datos inicializada correctamente');
            };

            request.onerror = function(event) {
                console.error('Error al abrir la base de datos:', event.target.error);
            };
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Mostrar/ocultar formularios de login/registro
            document.getElementById('showRegister').addEventListener('click', showRegisterForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);

            // Formulario de login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Formulario de registro
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('email').addEventListener('blur', validateGmail);
            document.getElementById('password').addEventListener('blur', validatePassword);
            document.getElementById('confirmPassword').addEventListener('blur', validateConfirmPassword);
            document.getElementById('phone').addEventListener('blur', validatePhone);

            // Botón de ayuda
            document.getElementById('helpButton').addEventListener('click', toggleHelpPanel);
            document.getElementById('emailHelp').addEventListener('click', showEmailHelpModal);
            document.getElementById('whatsappHelp').addEventListener('click', showWhatsappHelpModal);

            // Panel principal
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('uploadTab').addEventListener('click', () => showPanel('upload'));
            document.getElementById('galleryTab').addEventListener('click', () => showPanel('gallery'));
            document.getElementById('shareTab').addEventListener('click', () => showPanel('share'));
            document.getElementById('usersTab').addEventListener('click', () => showPanel('users'));
            document.getElementById('infoTab').addEventListener('click', () => showPanel('info'));

            // Subir archivos
            document.getElementById('uploadBtn').addEventListener('click', handleFileUpload);

            // Galería
            document.getElementById('createFolderBtn').addEventListener('click', () => {
                new bootstrap.Modal(document.getElementById('folderModal')).show();
            });
            document.getElementById('saveFolderBtn').addEventListener('click', createFolder);

            // Compartir archivos
            document.getElementById('shareBtn').addEventListener('click', shareFile);

            // Modales de ayuda
            document.getElementById('sendEmailHelpBtn').addEventListener('click', sendEmailHelp);
            document.getElementById('sendWhatsappHelpBtn').addEventListener('click', sendWhatsappHelp);

            // Modal de archivo
            document.getElementById('downloadFileBtn').addEventListener('click', downloadFile);
            document.getElementById('likeFileBtn').addEventListener('click', likeFile);
            document.getElementById('dislikeFileBtn').addEventListener('click', dislikeFile);
        }

        // Mostrar formulario de registro
        function showRegisterForm(e) {
            e.preventDefault();
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }

        // Mostrar formulario de login
        function showLoginForm(e) {
            e.preventDefault();
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
        }

        // Validar Gmail
        function validateGmail() {
            const emailInput = document.getElementById('email');
            const isValid = /^[a-zA-Z0-9._%+-]+@gmail\.com$/.test(emailInput.value);
            
            if (!isValid && emailInput.value) {
                emailInput.classList.add('is-invalid');
            } else {
                emailInput.classList.remove('is-invalid');
            }
            
            return isValid;
        }

        // Validar contraseña
        function validatePassword() {
            const passwordInput = document.getElementById('password');
            const password = passwordInput.value;
            
            // 6 letras (primera mayúscula), 4 números y 2 símbolos (@#&)
            const regex = /^(?=[A-Z][a-zA-Z]{5})(?=(?:\D*\d){4})(?=(?:[^@#&]*[@#&]){2})[a-zA-Z0-9@#&]{12}$/;
            const isValid = regex.test(password);
            
            if (!isValid && password) {
                passwordInput.classList.add('is-invalid');
            } else {
                passwordInput.classList.remove('is-invalid');
            }
            
            return isValid;
        }

        // Validar confirmación de contraseña
        function validateConfirmPassword() {
            const password = document.getElementById('password').value;
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const confirmPassword = confirmPasswordInput.value;
            
            const isValid = password === confirmPassword;
            
            if (!isValid && confirmPassword) {
                confirmPasswordInput.classList.add('is-invalid');
            } else {
                confirmPasswordInput.classList.remove('is-invalid');
            }
            
            return isValid;
        }

        // Validar teléfono con prefijo
        function validatePhone() {
            const phoneInput = document.getElementById('phone');
            // Validar que comience con + y tenga al menos 8 dígitos después
            const isValid = /^\+\d{8,}$/.test(phoneInput.value);
            
            if (!isValid && phoneInput.value) {
                phoneInput.classList.add('is-invalid');
            } else {
                phoneInput.classList.remove('is-invalid');
            }
            
            return isValid;
        }

        // Mostrar/ocultar panel de ayuda
        function toggleHelpPanel() {
            const helpPanel = document.getElementById('helpPanel');
            helpPanel.style.display = helpPanel.style.display === 'block' ? 'none' : 'block';
        }

        // Mostrar modal de ayuda por email
        function showEmailHelpModal() {
            toggleHelpPanel();
            new bootstrap.Modal(document.getElementById('emailHelpModal')).show();
        }

        // Mostrar modal de ayuda por WhatsApp
        function showWhatsappHelpModal() {
            toggleHelpPanel();
            new bootstrap.Modal(document.getElementById('whatsappHelpModal')).show();
        }

        // Enviar ayuda por email
        function sendEmailHelp() {
            const name = document.getElementById('helpName').value.trim();
            const email = document.getElementById('helpEmail').value.trim();
            
            if (!name || !email) {
                alert('Por favor complete todos los campos');
                return;
            }
            
            const subject = `Consulta de ${name} sobre mYpuB`;
            const body = `Nombre: ${name}\nEmail para respuesta: ${email}\n\nConsulta: `;
            const mailtoLink = `mailto:enzemajr@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            window.location.href = mailtoLink;
            bootstrap.Modal.getInstance(document.getElementById('emailHelpModal')).hide();
        }

        // Enviar ayuda por WhatsApp
        function sendWhatsappHelp() {
            const name = document.getElementById('whatsappName').value.trim();
            const number = document.getElementById('whatsappNumber').value.trim();
            
            if (!name || !number) {
                alert('Por favor complete todos los campos');
                return;
            }
            
            const message = `Hola, soy ${name}. Tengo una consulta sobre mYpuB. Mi número es ${number}. Mi consulta es: `;
            const whatsappLink = `https://wa.me/+240222084663?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappLink, '_blank');
            bootstrap.Modal.getInstance(document.getElementById('whatsappHelpModal')).hide();
        }

        // Manejar registro de usuario
        function handleRegister(e) {
            e.preventDefault();
            
            // Validar todos los campos
            const isEmailValid = validateGmail();
            const isPasswordValid = validatePassword();
            const isConfirmValid = validateConfirmPassword();
            const isPhoneValid = validatePhone();
            
            if (!isEmailValid || !isPasswordValid || !isConfirmValid || !isPhoneValid) {
                alert('Por favor corrija los errores en el formulario');
                return;
            }
            
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const gender = document.getElementById('gender').value;
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;
            
            // Verificar si el usuario ya existe
            const transaction = db.transaction(['users'], 'readwrite');
            const usersStore = transaction.objectStore('users');
            const request = usersStore.get(email);
            
            request.onsuccess = function(e) {
                if (e.target.result) {
                    alert('Este correo electrónico ya está registrado');
                } else {
                    // Crear nuevo usuario
                    const newUser = {
                        fullName,
                        email,
                        gender,
                        phone,
                        password,
                        storageUsed: 0,
                        maxStorage: MAX_STORAGE,
                        isBlocked: false,
                        isAdmin: password === DEVELOPER_PASSWORD,
                        createdAt: new Date().toISOString()
                    };
                    
                    const addRequest = usersStore.add(newUser);
                    
                    addRequest.onsuccess = function() {
                        alert('Registro exitoso. Ahora puede iniciar sesión.');
                        showLoginForm(e);
                    };
                    
                    addRequest.onerror = function() {
                        alert('Error al registrar el usuario');
                    };
                }
            };
            
            request.onerror = function() {
                alert('Error al verificar el usuario');
            };
        }

        // Manejar inicio de sesión
        function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const transaction = db.transaction(['users'], 'readonly');
            const usersStore = transaction.objectStore('users');
            const request = usersStore.get(email);
            
            request.onsuccess = function(e) {
                const user = e.target.result;
                
                if (!user) {
                    alert('Usuario no encontrado');
                    return;
                }
                
                if (user.isBlocked) {
                    alert('Su cuenta ha sido bloqueada. Contacte al administrador.');
                    return;
                }
                
                if (user.password !== password) {
                    alert('Contraseña incorrecta');
                    return;
                }
                
                // Login exitoso
                currentUser = user;
                isDeveloper = password === DEVELOPER_PASSWORD;
                
                if (isDeveloper) {
                    currentUser.maxStorage = MAX_STORAGE_DEVELOPER;
                    currentUser.isAdmin = true;
                }
                
                showMainPanel();
                showWelcomeMessage();
                loadUserFiles();
                loadSharedFiles();
                
                if (isDeveloper) {
                    document.getElementById('adminTab').style.display = 'block';
                    loadAllUsers();
                }
            };
            
            request.onerror = function() {
                alert('Error al iniciar sesión');
            };
        }

        // Mostrar panel principal
        function showMainPanel() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'flex';
            showPanel('upload');
        }

        // Mostrar mensaje de bienvenida
        function showWelcomeMessage() {
            const welcomeMessage = document.getElementById('welcomeMessage');
            const userEmail = document.getElementById('userEmail');
            const storageInfo = document.getElementById('storageInfo');
            
            userEmail.textContent = currentUser.email;
            
            const usedGB = (currentUser.storageUsed / (1024 * 1024 * 1024)).toFixed(2);
            const maxGB = (currentUser.maxStorage / (1024 * 1024 * 1024)).toFixed(0);
            storageInfo.textContent = `Almacenamiento: ${usedGB} GB / ${maxGB} GB`;
            
            if (currentUser.gender === 'Hombre') {
                welcomeMessage.textContent = `Bienvenido a mYpuB Sr. ${currentUser.fullName.split(' ')[0]}`;
            } else if (currentUser.gender === 'Mujer') {
                welcomeMessage.textContent = `Bienvenida a mYpuB Sra. ${currentUser.fullName.split(' ')[0]}`;
            } else {
                welcomeMessage.textContent = 'Gracias por utilizar mYpuB';
            }
            
            // Resaltar mYpuB en el mensaje
            welcomeMessage.innerHTML = welcomeMessage.innerHTML.replace('mYpuB', '<span class="brand">mYpuB</span>');
        }

        // Mostrar panel específico
        function showPanel(panelName) {
            // Ocultar todos los paneles
            document.getElementById('upload-panel').style.display = 'none';
            document.getElementById('gallery-panel').style.display = 'none';
            document.getElementById('share-panel').style.display = 'none';
            document.getElementById('users-panel').style.display = 'none';
            document.getElementById('info-panel').style.display = 'none';
            
            // Mostrar el panel seleccionado
            document.getElementById(`${panelName}-panel`).style.display = 'block';
            
            // Actualizar navegación activa
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(`${panelName}Tab`).classList.add('active');
            
            // Cargar datos específicos del panel si es necesario
            if (panelName === 'gallery') {
                loadUserFiles();
            } else if (panelName === 'share') {
                loadUsersForSharing();
                loadFilesForSharing();
            } else if (panelName === 'users' && isDeveloper) {
                loadAllUsers();
            }
        }

        // Manejar cierre de sesión
        function handleLogout() {
            currentUser = null;
            isDeveloper = false;
            
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
            
            // Limpiar formularios
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }

        // Manejar subida de archivos
        function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const fileType = document.getElementById('fileType').value;
            const visibility = document.getElementById('fileVisibility').value;
            const title = document.getElementById('fileName').value.trim() || 'Sin título';
            const description = document.getElementById('fileDescription').value.trim() || 'Sin descripción';
            
            if (fileInput.files.length === 0) {
                alert('Por favor seleccione al menos un archivo');
                return;
            }
            
            const file = fileInput.files[0];
            const fileSize = file.size;
            
            // Verificar espacio disponible
            if (currentUser.storageUsed + fileSize > currentUser.maxStorage) {
                alert('No tiene suficiente espacio de almacenamiento disponible');
                return;
            }
            
            // Validar tipo de archivo
            if (fileType === 'audio' && !file.name.toLowerCase().endsWith('.mp3')) {
                alert('Solo se permiten archivos MP3 para música');
                return;
            }
            
            if (fileType === 'document' && !file.name.toLowerCase().endsWith('.pdf')) {
                alert('Solo se permiten archivos PDF para documentos');
                return;
            }
            
            // Mostrar progreso
            const progressBar = document.getElementById('progressBar');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadStatus = document.getElementById('uploadStatus');
            
            uploadProgress.style.display = 'block';
            progressBar.style.width = '0%';
            uploadStatus.textContent = 'Subiendo archivo...';
            
            // Leer el archivo como base64
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const fileData = e.target.result;
                
                // Calcular progreso (simulado para este ejemplo)
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    progressBar.style.width = `${progress}%`;
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        
                        // Guardar archivo en la base de datos
                        const transaction = db.transaction(['files', 'users'], 'readwrite');
                        const filesStore = transaction.objectStore('files');
                        const usersStore = transaction.objectStore('users');
                        
                        const newFile = {
                            owner: currentUser.email,
                            name: file.name,
                            title,
                            description,
                            type: fileType,
                            visibility,
                            size: fileSize,
                            data: fileData,
                            likes: 0,
                            dislikes: 0,
                            createdAt: new Date().toISOString(),
                            folderId: null
                        };
                        
                        const addFileRequest = filesStore.add(newFile);
                        
                        addFileRequest.onsuccess = function() {
                            // Actualizar espacio usado por el usuario
                            currentUser.storageUsed += fileSize;
                            const updateUserRequest = usersStore.put(currentUser);
                            
                            updateUserRequest.onsuccess = function() {
                                uploadStatus.textContent = 'Archivo subido exitosamente!';
                                setTimeout(() => {
                                    uploadProgress.style.display = 'none';
                                    fileInput.value = '';
                                    document.getElementById('fileName').value = '';
                                    document.getElementById('fileDescription').value = '';
                                }, 2000);
                                
                                // Recargar archivos si estamos en la galería
                                if (document.getElementById('gallery-panel').style.display === 'block') {
                                    loadUserFiles();
                                }
                            };
                            
                            updateUserRequest.onerror = function() {
                                uploadStatus.textContent = 'Error al actualizar el espacio de almacenamiento';
                            };
                        };
                        
                        addFileRequest.onerror = function() {
                            uploadStatus.textContent = 'Error al subir el archivo';
                        };
                    }
                }, 100);
            };
            
            reader.onerror = function() {
                uploadStatus.textContent = 'Error al leer el archivo';
            };
            
            reader.readAsDataURL(file);
        }

        // Cargar archivos del usuario
        function loadUserFiles() {
            if (!currentUser) return;
            
            const galleryContent = document.getElementById('gallery-content');
            galleryContent.innerHTML = '<p>Cargando archivos...</p>';
            
            const transaction = db.transaction(['files', 'folders'], 'readonly');
            const filesStore = transaction.objectStore('files');
            const foldersStore = transaction.objectStore('folders');
            
            // Obtener todas las carpetas del usuario
            const foldersRequest = foldersStore.index('owner').getAll(currentUser.email);
            
            foldersRequest.onsuccess = function(e) {
                const folders = e.target.result || [];
                
                // Obtener todos los archivos del usuario
                const filesRequest = filesStore.index('owner').getAll(currentUser.email);
                
                filesRequest.onsuccess = function(e) {
                    const userFiles = e.target.result || [];
                    
                    // Obtener archivos públicos de otros usuarios
                    const publicFilesRequest = filesStore.index('visibility').getAll('public');
                    
                    publicFilesRequest.onsuccess = function(e) {
                        const publicFiles = e.target.result || [];
                        const otherPublicFiles = publicFiles.filter(file => file.owner !== currentUser.email);
                        
                        // Combinar archivos
                        const allFiles = [...userFiles, ...otherPublicFiles];
                        
                        if (allFiles.length === 0) {
                            galleryContent.innerHTML = '<p>No hay archivos para mostrar. Sube tu primer archivo!</p>';
                            return;
                        }
                        
                        // Agrupar archivos por carpeta
                        const filesByFolder = {};
                        filesByFolder['null'] = []; // Archivos sin carpeta
                        
                        folders.forEach(folder => {
                            filesByFolder[folder.id] = {
                                folderInfo: folder,
                                files: []
                            };
                        });
                        
                        allFiles.forEach(file => {
                            if (file.folderId === null || file.folderId === undefined) {
                                filesByFolder['null'].push(file);
                            } else if (filesByFolder[file.folderId]) {
                                filesByFolder[file.folderId].files.push(file);
                            }
                        });
                        
                        // Mostrar archivos
                        galleryContent.innerHTML = '';
                        
                        // Mostrar archivos sin carpeta primero
                        if (filesByFolder['null'].length > 0) {
                            const noFolderGroup = document.createElement('div');
                            noFolderGroup.className = 'col-12 mb-4';
                            noFolderGroup.innerHTML = '<h5>Archivos sin carpeta</h5><hr>';
                            
                            const noFolderFiles = document.createElement('div');
                            noFolderFiles.className = 'row';
                            
                            filesByFolder['null'].forEach(file => {
                                noFolderFiles.appendChild(createFileCard(file));
                            });
                            
                            noFolderGroup.appendChild(noFolderFiles);
                            galleryContent.appendChild(noFolderGroup);
                        }
                        
                        // Mostrar archivos en carpetas
                        Object.keys(filesByFolder).forEach(folderId => {
                            if (folderId !== 'null' && filesByFolder[folderId].files.length > 0) {
                                const folder = filesByFolder[folderId].folderInfo;
                                const folderGroup = document.createElement('div');
                                folderGroup.className = 'col-12 mb-4';
                                
                                const folderTitle = document.createElement('h5');
                                folderTitle.innerHTML = `<i class="bi bi-folder"></i> ${folder.name} (${folder.visibility === 'public' ? 'Pública' : 'Privada'})`;
                                
                                folderGroup.appendChild(folderTitle);
                                folderGroup.appendChild(document.createElement('hr'));
                                
                                const folderFiles = document.createElement('div');
                                folderFiles.className = 'row';
                                
                                filesByFolder[folderId].files.forEach(file => {
                                    folderFiles.appendChild(createFileCard(file));
                                });
                                
                                folderGroup.appendChild(folderFiles);
                                galleryContent.appendChild(folderGroup);
                            }
                        });
                    };
                    
                    publicFilesRequest.onerror = function() {
                        galleryContent.innerHTML = '<p>Error al cargar archivos públicos</p>';
                    };
                };
                
                filesRequest.onerror = function() {
                    galleryContent.innerHTML = '<p>Error al cargar tus archivos</p>';
                };
            };
            
            foldersRequest.onerror = function() {
                galleryContent.innerHTML = '<p>Error al cargar carpetas</p>';
            };
        }

        // Crear tarjeta de archivo
        function createFileCard(file) {
            const col = document.createElement('div');
            col.className = 'col-md-3 col-sm-6';
            
            const card = document.createElement('div');
            card.className = 'card file-card';
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body text-center';
            
            // Icono según tipo de archivo
            const icon = document.createElement('i');
            icon.className = 'file-icon';
            
            if (file.type === 'image') {
                icon.classList.add('bi', 'bi-image');
            } else if (file.type === 'video') {
                icon.classList.add('bi', 'bi-film');
            } else if (file.type === 'audio') {
                icon.classList.add('bi', 'bi-music-note-beamed');
            } else {
                icon.classList.add('bi', 'bi-file-earmark-pdf');
            }
            
            // Título y información
            const title = document.createElement('h5');
            title.className = 'card-title';
            title.textContent = file.title || file.name;
            
            const info = document.createElement('p');
            info.className = 'card-text small text-muted';
            
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            info.textContent = `${fileSize} MB | ${file.visibility === 'public' ? 'Público' : 'Privado'}`;
            
            // Botón para ver/descargar
            const viewBtn = document.createElement('button');
            viewBtn.className = 'btn btn-sm btn-outline-primary w-100';
            viewBtn.innerHTML = '<i class="bi bi-eye"></i> Ver';
            viewBtn.addEventListener('click', () => showFileModal(file));
            
            // Agregar elementos al card
            cardBody.appendChild(icon);
            cardBody.appendChild(title);
            cardBody.appendChild(info);
            cardBody.appendChild(viewBtn);
            
            card.appendChild(cardBody);
            col.appendChild(card);
            
            return col;
        }

        // Mostrar modal de archivo
        function showFileModal(file) {
            const modal = new bootstrap.Modal(document.getElementById('fileModal'));
            const modalTitle = document.getElementById('fileModalTitle');
            const modalContent = document.getElementById('fileModalContent');
            const modalInfo = document.getElementById('fileModalInfo');
            const downloadBtn = document.getElementById('downloadFileBtn');
            const likeBtn = document.getElementById('likeFileBtn');
            const dislikeBtn = document.getElementById('dislikeFileBtn');
            const likeCount = document.getElementById('likeCount');
            const dislikeCount = document.getElementById('dislikeCount');
            
            // Configurar título y contenido
            modalTitle.textContent = file.title || file.name;
            
            // Mostrar contenido según tipo de archivo
            if (file.type === 'image') {
                modalContent.innerHTML = `<img src="${file.data}" class="img-fluid" alt="${file.title}" style="max-height: 70vh;">`;
            } else if (file.type === 'video') {
                modalContent.innerHTML = `
                    <video controls class="w-100" style="max-height: 70vh;">
                        <source src="${file.data}" type="video/mp4">
                        Tu navegador no soporta videos HTML5.
                    </video>
                `;
            } else if (file.type === 'audio') {
                modalContent.innerHTML = `
                    <audio controls class="w-100">
                        <source src="${file.data}" type="audio/mpeg">
                        Tu navegador no soporta audio HTML5.
                    </audio>
                    <div class="mt-3">
                        <p class="mb-1">${file.title || file.name}</p>
                        <small class="text-muted">Archivo de audio</small>
                    </div>
                `;
            } else {
                // Para PDF mostramos un iframe (nota: algunos navegadores pueden no mostrarlo)
                modalContent.innerHTML = `
                    <iframe src="${file.data}" class="w-100" style="height: 70vh;" frameborder="0"></iframe>
                    <p class="mt-2">Si el PDF no se muestra, puedes descargarlo para verlo.</p>
                `;
            }
            
            // Configurar información
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            const date = new Date(file.createdAt).toLocaleString();
            modalInfo.innerHTML = `
                <small class="text-muted">
                    Subido por: ${file.owner}<br>
                    Tamaño: ${fileSize} MB<br>
                    Fecha: ${date}<br>
                    Visibilidad: ${file.visibility === 'public' ? 'Público' : 'Privado'}
                </small>
            `;
            
            // Configurar botones de like/dislike
            likeCount.textContent = file.likes || 0;
            dislikeCount.textContent = file.dislikes || 0;
            
            // Verificar si el usuario ya dio like/dislike
            checkUserLike(file.id, likeBtn, dislikeBtn);
            
            // Configurar evento de descarga
            downloadBtn.onclick = function() {
                downloadFile(file);
                modal.hide();
            };
            
            // Configurar eventos de like/dislike
            likeBtn.onclick = function() {
                likeFile(file.id, likeBtn, dislikeBtn, likeCount);
            };
            
            dislikeBtn.onclick = function() {
                dislikeFile(file.id, likeBtn, dislikeBtn, dislikeCount);
            };
            
            // Mostrar modal
            modal.show();
        }

        // Descargar archivo
        function downloadFile(file) {
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Verificar si el usuario ya dio like/dislike a un archivo
        function checkUserLike(fileId, likeBtn, dislikeBtn) {
            if (!currentUser) return;
            
            const transaction = db.transaction(['likes'], 'readonly');
            const likesStore = transaction.objectStore('likes');
            const request = likesStore.get([fileId, currentUser.email]);
            
            request.onsuccess = function(e) {
                const likeRecord = e.target.result;
                
                if (likeRecord) {
                    if (likeRecord.like) {
                        likeBtn.classList.add('active');
                    } else {
                        dislikeBtn.classList.add('active');
                    }
                }
            };
        }

        // Dar like a un archivo
        function likeFile(fileId, likeBtn, dislikeBtn, likeCount) {
            if (!currentUser) return;
            
            const transaction = db.transaction(['files', 'likes'], 'readwrite');
            const filesStore = transaction.objectStore('files');
            const likesStore = transaction.objectStore('likes');
            
            // Obtener el archivo
            const getFileRequest = filesStore.get(fileId);
            
            getFileRequest.onsuccess = function(e) {
                const file = e.target.result;
                
                if (!file) return;
                
                // Verificar si ya hay un like/dislike del usuario
                const getLikeRequest = likesStore.get([fileId, currentUser.email]);
                
                getLikeRequest.onsuccess = function(e) {
                    const likeRecord = e.target.result;
                    
                    if (likeRecord) {
                        if (likeRecord.like) {
                            // Ya dio like, quitarlo
                            const deleteRequest = likesStore.delete([fileId, currentUser.email]);
                            
                            deleteRequest.onsuccess = function() {
                                file.likes = (file.likes || 0) - 1;
                                const updateFileRequest = filesStore.put(file);
                                
                                updateFileRequest.onsuccess = function() {
                                    likeBtn.classList.remove('active');
                                    likeCount.textContent = file.likes;
                                };
                            };
                        } else {
                            // Cambiar de dislike a like
                            likeRecord.like = true;
                            const putRequest = likesStore.put(likeRecord);
                            
                            putRequest.onsuccess = function() {
                                file.likes = (file.likes || 0) + 1;
                                file.dislikes = (file.dislikes || 0) - 1;
                                const updateFileRequest = filesStore.put(file);
                                
                                updateFileRequest.onsuccess = function() {
                                    likeBtn.classList.add('active');
                                    dislikeBtn.classList.remove('active');
                                    likeCount.textContent = file.likes;
                                    dislikeCount.textContent = file.dislikes;
                                };
                            };
                        }
                    } else {
                        // Agregar nuevo like
                        const newLike = {
                            fileId,
                            userId: currentUser.email,
                            like: true
                        };
                        
                        const addRequest = likesStore.add(newLike);
                        
                        addRequest.onsuccess = function() {
                            file.likes = (file.likes || 0) + 1;
                            const updateFileRequest = filesStore.put(file);
                            
                            updateFileRequest.onsuccess = function() {
                                likeBtn.classList.add('active');
                                likeCount.textContent = file.likes;
                            };
                        };
                    }
                };
            };
        }

        // Dar dislike a un archivo
        function dislikeFile(fileId, likeBtn, dislikeBtn, dislikeCount) {
            if (!currentUser) return;
            
            const transaction = db.transaction(['files', 'likes'], 'readwrite');
            const filesStore = transaction.objectStore('files');
            const likesStore = transaction.objectStore('likes');
            
            // Obtener el archivo
            const getFileRequest = filesStore.get(fileId);
            
            getFileRequest.onsuccess = function(e) {
                const file = e.target.result;
                
                if (!file) return;
                
                // Verificar si ya hay un like/dislike del usuario
                const getLikeRequest = likesStore.get([fileId, currentUser.email]);
                
                getLikeRequest.onsuccess = function(e) {
                    const likeRecord = e.target.result;
                    
                    if (likeRecord) {
                        if (!likeRecord.like) {
                            // Ya dio dislike, quitarlo
                            const deleteRequest = likesStore.delete([fileId, currentUser.email]);
                            
                            deleteRequest.onsuccess = function() {
                                file.dislikes = (file.dislikes || 0) - 1;
                                const updateFileRequest = filesStore.put(file);
                                
                                updateFileRequest.onsuccess = function() {
                                    dislikeBtn.classList.remove('active');
                                    dislikeCount.textContent = file.dislikes;
                                };
                            };
                        } else {
                            // Cambiar de like a dislike
                            likeRecord.like = false;
                            const putRequest = likesStore.put(likeRecord);
                            
                            putRequest.onsuccess = function() {
                                file.likes = (file.likes || 0) - 1;
                                file.dislikes = (file.dislikes || 0) + 1;
                                const updateFileRequest = filesStore.put(file);
                                
                                updateFileRequest.onsuccess = function() {
                                    likeBtn.classList.remove('active');
                                    dislikeBtn.classList.add('active');
                                    likeCount.textContent = file.likes;
                                    dislikeCount.textContent = file.dislikes;
                                };
                            };
                        }
                    } else {
                        // Agregar nuevo dislike
                        const newLike = {
                            fileId,
                            userId: currentUser.email,
                            like: false
                        };
                        
                        const addRequest = likesStore.add(newLike);
                        
                        addRequest.onsuccess = function() {
                            file.dislikes = (file.dislikes || 0) + 1;
                            const updateFileRequest = filesStore.put(file);
                            
                            updateFileRequest.onsuccess = function() {
                                dislikeBtn.classList.add('active');
                                dislikeCount.textContent = file.dislikes;
                            };
                        };
                    }
                };
            };
        }

        // Crear carpeta
        function createFolder() {
            const folderName = document.getElementById('folderName').value.trim();
            const visibility = document.getElementById('folderVisibility').value;
            
            if (!folderName) {
                alert('Por favor ingrese un nombre para la carpeta');
                return;
            }
            
            const transaction = db.transaction(['folders'], 'readwrite');
            const foldersStore = transaction.objectStore('folders');
            
            const newFolder = {
                name: folderName,
                owner: currentUser.email,
                visibility,
                createdAt: new Date().toISOString()
            };
            
            const request = foldersStore.add(newFolder);
            
            request.onsuccess = function() {
                bootstrap.Modal.getInstance(document.getElementById('folderModal')).hide();
                document.getElementById('folderName').value = '';
                loadUserFiles();
            };
            
            request.onerror = function() {
                alert('Error al crear la carpeta');
            };
        }

        // Cargar usuarios para compartir
        function loadUsersForSharing() {
            if (!currentUser) return;
            
            const userSelect = document.getElementById('shareUserSelect');
            userSelect.innerHTML = '<option value="">Seleccionar usuario...</option>';
            
            const transaction = db.transaction(['users'], 'readonly');
            const usersStore = transaction.objectStore('users');
            const request = usersStore.getAll();
            
            request.onsuccess = function(e) {
                const users = e.target.result || [];
                
                users.forEach(user => {
                    if (user.email !== currentUser.email && !user.isBlocked) {
                        const option = document.createElement('option');
                        option.value = user.email;
                        option.textContent = `${user.fullName} (${user.email})`;
                        userSelect.appendChild(option);
                    }
                });
            };
        }

        // Cargar archivos para compartir
        function loadFilesForSharing() {
            if (!currentUser) return;
            
            const fileSelect = document.getElementById('shareFileSelect');
            fileSelect.innerHTML = '<option value="">Seleccionar archivo...</option>';
            
            const transaction = db.transaction(['files'], 'readonly');
            const filesStore = transaction.objectStore('files');
            const request = filesStore.index('owner').getAll(currentUser.email);
            
            request.onsuccess = function(e) {
                const files = e.target.result || [];
                
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.id;
                    option.textContent = `${file.title || file.name} (${file.type})`;
                    fileSelect.appendChild(option);
                });
            };
        }

        // Compartir archivo
        function shareFile() {
            const userEmail = document.getElementById('shareUserSelect').value;
            const fileId = parseInt(document.getElementById('shareFileSelect').value);
            const status = document.getElementById('shareStatus');
            
            if (!userEmail || !fileId) {
                status.textContent = 'Por favor seleccione un usuario y un archivo';
                status.className = 'text-danger';
                return;
            }
            
            const transaction = db.transaction(['sharedFiles', 'files'], 'readwrite');
            const sharedStore = transaction.objectStore('sharedFiles');
            const filesStore = transaction.objectStore('files');
            
            // Verificar si el archivo ya fue compartido con este usuario
            const checkRequest = sharedStore.index('toUser').getAll(userEmail);
            
            checkRequest.onsuccess = function(e) {
                const sharedFiles = e.target.result || [];
                const alreadyShared = sharedFiles.some(shared => shared.fileId === fileId);
                
                if (alreadyShared) {
                    status.textContent = 'Este archivo ya fue compartido con el usuario seleccionado';
                    status.className = 'text-warning';
                    return;
                }
                
                // Obtener información del archivo
                const getFileRequest = filesStore.get(fileId);
                
                getFileRequest.onsuccess = function(e) {
                    const file = e.target.result;
                    
                    if (!file) {
                        status.textContent = 'Error: Archivo no encontrado';
                        status.className = 'text-danger';
                        return;
                    }
                    
                    // Compartir el archivo
                    const newShare = {
                        fileId,
                        fromUser: currentUser.email,
                        toUser: userEmail,
                        sharedAt: new Date().toISOString()
                    };
                    
                    const addRequest = sharedStore.add(newShare);
                    
                    addRequest.onsuccess = function() {
                        status.textContent = 'Archivo compartido exitosamente!';
                        status.className = 'text-success';
                        
                        // Limpiar selección
                        document.getElementById('shareUserSelect').value = '';
                        document.getElementById('shareFileSelect').value = '';
                        
                        // Recargar archivos compartidos
                        loadSharedFiles();
                    };
                    
                    addRequest.onerror = function() {
                        status.textContent = 'Error al compartir el archivo';
                        status.className = 'text-danger';
                    };
                };
            };
        }

        // Cargar archivos compartidos con el usuario actual
        function loadSharedFiles() {
            if (!currentUser) return;
            
            const sharedFilesContainer = document.getElementById('sharedFilesContainer');
            sharedFilesContainer.innerHTML = '<p>Cargando archivos compartidos...</p>';
            
            const transaction = db.transaction(['sharedFiles', 'files', 'users'], 'readonly');
            const sharedStore = transaction.objectStore('sharedFiles');
            const filesStore = transaction.objectStore('files');
            const usersStore = transaction.objectStore('users');
            
            // Obtener archivos compartidos con el usuario actual
            const sharedRequest = sharedStore.index('toUser').getAll(currentUser.email);
            
            sharedRequest.onsuccess = function(e) {
                const sharedFiles = e.target.result || [];
                
                if (sharedFiles.length === 0) {
                    sharedFilesContainer.innerHTML = '<p>No tienes archivos compartidos contigo.</p>';
                    return;
                }
                
                // Obtener información de los archivos y usuarios
                const fileRequests = [];
                const userRequests = [];
                
                sharedFiles.forEach(shared => {
                    fileRequests.push(new Promise((resolve) => {
                        const fileRequest = filesStore.get(shared.fileId);
                        
                        fileRequest.onsuccess = function(e) {
                            resolve({
                                file: e.target.result,
                                shared
                            });
                        };
                        
                        fileRequest.onerror = function() {
                            resolve(null);
                        };
                    }));
                    
                    userRequests.push(new Promise((resolve) => {
                        const userRequest = usersStore.get(shared.fromUser);
                        
                        userRequest.onsuccess = function(e) {
                            resolve(e.target.result);
                        };
                        
                        userRequest.onerror = function() {
                            resolve(null);
                        };
                    }));
                });
                
                Promise.all(fileRequests).then(fileResults => {
                    Promise.all(userRequests).then(userResults => {
                        // Filtrar resultados nulos
                        const validFiles = fileResults.filter(result => result !== null && result.file !== undefined);
                        const validUsers = userResults.filter(result => result !== null);
                        
                        // Mostrar archivos compartidos
                        sharedFilesContainer.innerHTML = '';
                        
                        validFiles.forEach((result, index) => {
                            const file = result.file;
                            const shared = result.shared;
                            const user = validUsers[index];
                            
                            if (file && user) {
                                const col = document.createElement('div');
                                col.className = 'col-md-3 col-sm-6 mb-3';
                                
                                const card = document.createElement('div');
                                card.className = 'card h-100';
                                
                                const cardBody = document.createElement('div');
                                cardBody.className = 'card-body';
                                
                                // Icono según tipo de archivo
                                const icon = document.createElement('i');
                                icon.className = 'bi file-icon';
                                
                                if (file.type === 'image') {
                                    icon.classList.add('bi-image');
                                } else if (file.type === 'video') {
                                    icon.classList.add('bi-film');
                                } else if (file.type === 'audio') {
                                    icon.classList.add('bi-music-note-beamed');
                                } else {
                                    icon.classList.add('bi-file-earmark-pdf');
                                }
                                
                                // Título y información
                                const title = document.createElement('h6');
                                title.className = 'card-title';
                                title.textContent = file.title || file.name;
                                
                                const sharedBy = document.createElement('p');
                                sharedBy.className = 'card-text small';
                                sharedBy.textContent = `Compartido por: ${user.fullName}`;
                                
                                const sharedDate = document.createElement('p');
                                sharedDate.className = 'card-text small text-muted';
                                sharedDate.textContent = new Date(shared.sharedAt).toLocaleString();
                                
                                // Botón para ver
                                const viewBtn = document.createElement('button');
                                viewBtn.className = 'btn btn-sm btn-outline-primary w-100 mt-2';
                                viewBtn.innerHTML = '<i class="bi bi-eye"></i> Ver';
                                viewBtn.addEventListener('click', () => showFileModal(file));
                                
                                // Agregar elementos al card
                                cardBody.appendChild(icon);
                                cardBody.appendChild(title);
                                cardBody.appendChild(sharedBy);
                                cardBody.appendChild(sharedDate);
                                cardBody.appendChild(viewBtn);
                                
                                card.appendChild(cardBody);
                                col.appendChild(card);
                                sharedFilesContainer.appendChild(col);
                            }
                        });
                    });
                });
            };
        }

        // Cargar todos los usuarios (solo para desarrollador)
        function loadAllUsers() {
            if (!isDeveloper) return;
            
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = '<tr><td colspan="5">Cargando usuarios...</td></tr>';
            
            const transaction = db.transaction(['users'], 'readonly');
            const usersStore = transaction.objectStore('users');
            const request = usersStore.getAll();
            
            request.onsuccess = function(e) {
                const users = e.target.result || [];
                
                if (users.length === 0) {
                    usersTableBody.innerHTML = '<tr><td colspan="5">No hay usuarios registrados</td></tr>';
                    return;
                }
                
                usersTableBody.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    
                    // Nombre
                    const nameCell = document.createElement('td');
                    nameCell.textContent = user.fullName;
                    row.appendChild(nameCell);
                    
                    // Email
                    const emailCell = document.createElement('td');
                    emailCell.textContent = user.email;
                    row.appendChild(emailCell);
                    
                    // Teléfono
                    const phoneCell = document.createElement('td');
                    phoneCell.textContent = user.phone;
                    row.appendChild(phoneCell);
                    
                    // Estado
                    const statusCell = document.createElement('td');
                    if (user.isBlocked) {
                        statusCell.innerHTML = '<span class="badge bg-danger">Bloqueado</span>';
                    } else {
                        statusCell.innerHTML = '<span class="badge bg-success">Activo</span>';
                    }
                    row.appendChild(statusCell);
                    
                    // Acciones
                    const actionsCell = document.createElement('td');
                    
                    if (user.email !== currentUser.email) {
                        if (user.isBlocked) {
                            const unblockBtn = document.createElement('button');
                            unblockBtn.className = 'btn btn-sm btn-success me-1';
                            unblockBtn.innerHTML = '<i class="bi bi-unlock"></i>';
                            unblockBtn.title = 'Desbloquear';
                            unblockBtn.addEventListener('click', () => toggleUserBlock(user, false));
                            actionsCell.appendChild(unblockBtn);
                        } else {
                            const blockBtn = document.createElement('button');
                            blockBtn.className = 'btn btn-sm btn-warning me-1';
                            blockBtn.innerHTML = '<i class="bi bi-lock"></i>';
                            blockBtn.title = 'Bloquear';
                            blockBtn.addEventListener('click', () => toggleUserBlock(user, true));
                            actionsCell.appendChild(blockBtn);
                        }
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-sm btn-danger';
                        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                        deleteBtn.title = 'Eliminar';
                        deleteBtn.addEventListener('click', () => deleteUser(user));
                        actionsCell.appendChild(deleteBtn);
                    } else {
                        actionsCell.textContent = 'Tú';
                    }
                    
                    row.appendChild(actionsCell);
                    usersTableBody.appendChild(row);
                });
            };
        }

        // Bloquear/desbloquear usuario
        function toggleUserBlock(user, block) {
            if (!confirm(`¿Estás seguro que deseas ${block ? 'bloquear' : 'desbloquear'} a ${user.fullName}?`)) {
                return;
            }
            
            user.isBlocked = block;
            
            const transaction = db.transaction(['users'], 'readwrite');
            const usersStore = transaction.objectStore('users');
            const request = usersStore.put(user);
            
            request.onsuccess = function() {
                loadAllUsers();
            };
            
            request.onerror = function() {
                alert('Error al actualizar el usuario');
            };
        }

        // Eliminar usuario
        function deleteUser(user) {
            if (!confirm(`¿Estás seguro que deseas eliminar permanentemente a ${user.fullName}? Todos sus archivos también serán eliminados.`)) {
                return;
            }
            
            // Primero eliminamos todos los archivos del usuario
            const filesTransaction = db.transaction(['files'], 'readwrite');
            const filesStore = filesTransaction.objectStore('files');
            const filesRequest = filesStore.index('owner').getAll(user.email);
            
            filesRequest.onsuccess = function(e) {
                const userFiles = e.target.result || [];
                
                userFiles.forEach(file => {
                    filesStore.delete(file.id);
                });
                
                // Luego eliminamos al usuario
                const usersTransaction = db.transaction(['users'], 'readwrite');
                const usersStore = usersTransaction.objectStore('users');
                usersStore.delete(user.email);
                
                loadAllUsers();
            };
        }
    </script>
</body>
</html>
